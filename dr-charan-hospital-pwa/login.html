<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PIN Login â€“ Dr. Charan Hospital</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="assets/logo.png" />
  <link rel="stylesheet" href="styles.css?v=21" />
  <meta name="theme-color" content="#0b5a83" />
</head>
<body>
  <!-- Banner (fixed height, centered, responsive) -->
  <header class="banner">
    <button id="themeToggle" class="chip floating-toggle" aria-label="Theme">ðŸŒ™</button>
  </header>

  <!-- Small sticky action chips (not on the banner) -->
  <div class="fixed-actions">
    <button id="clearCacheBtn" class="chip" type="button">Clear Cache</button>
  </div>

  <!-- Login card -->
  <section class="login-wrap">
    <div class="login-card">
      <h1 class="login-title">PIN Login</h1>

      <form id="loginForm" autocomplete="one-time-code">
        <label for="pin" class="muted" style="display:block;margin:6px 0 6px">Enter PIN</label>
        <input id="pin" name="pin" class="input" type="password" inputmode="numeric"
               minlength="4" maxlength="6" placeholder="4â€“6 digits" required />

        <div style="display:flex;gap:10px;align-items:center;margin-top:12px">
          <button class="btn" type="submit">Login</button>
        </div>

        <p class="help" id="demoInfo">
          Demo: 4321 (Doctor) Â· 1111 (Supervisor) Â· 2222 (Patient)
        </p>
      </form>
    </div>
  </section>

  <script type="module">
    /* ---------------- Theme toggle ---------------- */
    const themeBtn = document.getElementById('themeToggle');
    const setTheme = (mode) => {
      document.documentElement.dataset.theme = mode;
      localStorage.theme = mode;
      themeBtn.textContent = mode === 'light' ? 'ðŸŒž' : 'ðŸŒ™';
    };
    setTheme(localStorage.theme || 'light');
    themeBtn.addEventListener('click', () => {
      setTheme((document.documentElement.dataset.theme || 'light') === 'light' ? 'dark' : 'light');
    });

    /* --------- Sticky actions: Clear cache --------- */
    document.getElementById('clearCacheBtn').addEventListener('click', async () => {
      try {
        localStorage.clear();
        // wipe SW caches
        if ('caches' in window) {
          const names = await caches.keys();
          await Promise.all(names.map((n) => caches.delete(n)));
        }
        // unregister all SWs
        if ('serviceWorker' in navigator) {
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map((r) => r.unregister()));
        }
        alert('Cache cleared. App will reload.');
        location.reload();
      } catch (e) {
        alert('Could not fully clear cache. Try a hard reload.');
      }
    });

    /* --------------- Session helpers --------------- */
    const saveSession = (role) => {
      localStorage.setItem('session', JSON.stringify({ role, ts: Date.now() }));
    };
    const routeToRole = (role) => {
      if (role === 'doctor') location.href = 'dashboard.html';
      else if (role === 'supervisor') location.href = 'admin.html';
      else location.href = 'portal.html';
    };

    // If already logged in, go straight to the right page
    try {
      const s = JSON.parse(localStorage.getItem('session') || 'null');
      if (s && s.role) routeToRole(s.role);
    } catch {}

    /* ---------- PIN verify (local + optional supa) ---------- */
    async function resolveRoleFromPin(pin) {
      // If you later define window.verifyPin = async (pin)=>'doctor'|'supervisor'|'patient'|null
      if (typeof window.verifyPin === 'function') {
        try {
          const r = await window.verifyPin(pin);
          if (r) return r;
        } catch (e) {
          console.warn('verifyPin failed, falling back to demo map', e);
        }
      }
      // Demo map
      const map = { '4321': 'doctor', '1111': 'supervisor', '2222': 'patient' };
      return map[pin] || null;
    }

    /* ------------------ Login submit ------------------ */
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const pin = (document.getElementById('pin').value || '').trim();
      if (pin.length < 4) return alert('Enter a valid 4â€“6 digit PIN');

      const role = await resolveRoleFromPin(pin);
      if (!role) return alert('Invalid PIN');

      saveSession(role);
      routeToRole(role);
    });

    /* --------------- Register Service Worker --------------- */
    if ('serviceWorker' in navigator) {
      // slight delay avoids the SW hijacking first navigation
      setTimeout(() => {
        navigator.serviceWorker.register('service-worker.js').catch(() => {});
      }, 300);
    }
  </script>
</body>
</html>
