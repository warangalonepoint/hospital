<script type="module">
  // --- theme toggle ---
  const themeBtn = document.getElementById('themeToggle');
  const setTheme = (mode) => {
    document.documentElement.dataset.theme = mode;
    localStorage.theme = mode;
    themeBtn.textContent = mode === 'light' ? 'ðŸŒž' : 'ðŸŒ™';
  };
  setTheme(localStorage.theme || 'light');
  themeBtn.onclick = () =>
    setTheme(document.documentElement.dataset.theme === 'light' ? 'dark' : 'light');

  // --- cache clear ---
  document.getElementById('clearCacheBtn').onclick = async () => {
    try {
      localStorage.clear();
      if ('caches' in window) {
        const ks = await caches.keys();
        await Promise.all(ks.map(k => caches.delete(k)));
      }
      if ('serviceWorker' in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        for (const r of regs) await r.unregister();
      }
      alert('Cache cleared. Reloadingâ€¦'); location.reload();
    } catch { alert('Couldnâ€™t fully clear. Try hard refresh.'); }
  };

  // ---- PIN login (digits only) ----
  const DIGITS_ONLY = /[0-9]/g;
  const normalizePin = (raw) => ((raw||'').match(DIGITS_ONLY) || []).join('').slice(0,6);

  const roles = { '4321':'doctor', '1111':'supervisor', '2222':'patient' };
  const pinEl = document.getElementById('pin');
  pinEl.addEventListener('input', () => {
    const clean = normalizePin(pinEl.value);
    if (pinEl.value !== clean) pinEl.value = clean;
  });

  document.getElementById('loginForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const pin = normalizePin(pinEl.value);
    const role = roles[pin];
    if (!role) { alert('Invalid PIN'); return; }

    // ---- Write ALL expected keys so any guard recognizes auth ----
    const session = { role, pin, ts: Date.now() };
    localStorage.setItem('session', JSON.stringify(session)); // JSON session
    localStorage.setItem('role', role);                       // flat role
    localStorage.setItem('isLoggedIn', '1');                  // boolean-ish flag
    sessionStorage.setItem('role', role);                     // some guards use sessionStorage
    // (Optional) compatibility keys often seen in custom stores:
    localStorage.setItem('authRole', role);
    localStorage.setItem('auth', JSON.stringify({ role }));

    // ---- Route by role ----
    const go = (p) => { window.location.href = p; };
    if (role === 'doctor')      go('dashboard.html');
    else if (role === 'supervisor') go('admin.html');   // supervisorâ€™s landing (pharmacy, bookings)
    else                        go('portal.html');      // patient portal
  });

  // SW register quietly
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').catch(()=>{});
  }
</script>
