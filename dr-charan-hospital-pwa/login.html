<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Login â€“ Dr. Charan Hospital</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=14"/>
</head>
<body>
  <!-- Banner already includes logo + title -->
  <header class="banner clean"></header>
  <button id="themeToggle" class="chip floating-toggle">ðŸŒ™</button>

  <main class="container n8">
    <section class="card">
      <h3 style="margin-top:0">PIN Login</h3>
      <div class="form-grid">
        <div class="field">
          <label>Enter PIN</label>
          <input id="pin" type="password" inputmode="numeric" maxlength="6" placeholder="4â€“6 digits"/>
        </div>
        <div class="field" style="align-items:end">
          <button id="loginBtn" class="btn">Login</button>
        </div>
      </div>
      <div id="err" style="color:#d33;margin-top:8px"></div>
    </section>
  </main>

  <footer style="text-align:center;color:var(--muted);margin:20px 0 40px">
    Demo PINs â†’ Doctor: 4321 â€¢ Supervisor: 1111 â€¢ Patient: 2222
  </footer>

  <!-- App logic -->
  <script type="module">
    import { authenticatePin, currentUser } from './js/store.js?v=14';

    // Auto-skip login if already authenticated
    const u = currentUser?.();
    if (u) {
      if (u.role === 'doctor') location.href = 'dashboard.html?v=15';
      else if (u.role === 'supervisor') location.href = 'admin.html?v=15';
      else if (u.role === 'patient') location.href = 'portal.html?v=15';
    }

    // Theme toggle
    const tbtn=document.getElementById('themeToggle');
    if(localStorage.theme){
      document.documentElement.setAttribute('data-theme', localStorage.theme);
      tbtn.textContent = localStorage.theme==='light'?'ðŸŒž':'ðŸŒ™';
    }
    tbtn.onclick=()=>{
      const cur=document.documentElement.getAttribute('data-theme')||'light';
      const next=cur==='light'?'dark':'light';
      document.documentElement.setAttribute('data-theme',next);
      localStorage.theme=next;
      tbtn.textContent=next==='light'?'ðŸŒž':'ðŸŒ™';
    };

    // Login handler
    document.getElementById('loginBtn').onclick=async()=>{
      const pin=document.getElementById('pin').value.trim();
      const err=document.getElementById('err');
      err.textContent='';
      if(!pin){ err.textContent='Enter your PIN'; return; }
      const user=await authenticatePin(pin);
      if(!user){ err.textContent='Invalid PIN'; return; }
      if(user.role==='doctor'){ location.href='dashboard.html?v=15'; }
      else if(user.role==='supervisor'){ location.href='admin.html?v=15'; }
      else if(user.role==='patient'){ location.href='portal.html?v=15'; }
      else{ err.textContent='Unknown role'; }
    };
    document.getElementById('pin').addEventListener('keyup',e=>{
      if(e.key==='Enter') document.getElementById('loginBtn').click();
    });
  </script>

  <!-- SW registration + install prompt -->
  <script>
    // Register service worker
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js").catch(err => console.error("SW failed:", err));
    }

    // Handle install prompt (Add to Home Screen)
    let deferredPrompt;
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;

      // Create a floating install button
      const btn = document.createElement("button");
      btn.textContent = "Install App";
      btn.className = "btn";
      btn.style = "position:fixed;bottom:20px;right:20px;z-index:9999";
      document.body.appendChild(btn);

      btn.addEventListener("click", async () => {
        btn.disabled = true;
        try {
          deferredPrompt.prompt();
          await deferredPrompt.userChoice; // {outcome: 'accepted'|'dismissed'}
        } finally {
          deferredPrompt = null;
          btn.remove();
        }
      });
    });

    // iOS hint (no A2HS event)
    (function iosHint(){
      const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
      if (isIOS && !isStandalone) {
        const hint = document.createElement('div');
        hint.textContent = 'On iPhone: Share â–¶ Add to Home Screen to install the app';
        hint.style = 'position:fixed;left:12px;right:12px;bottom:12px;padding:10px;border:1px solid var(--border);background:var(--card-bg);color:var(--text);border-radius:12px;box-shadow:0 6px 30px #0002;z-index:9999;text-align:center';
        document.body.appendChild(hint);
        setTimeout(()=>hint.remove(), 8000);
      }
    })();
  </script>
</body>
</html>
