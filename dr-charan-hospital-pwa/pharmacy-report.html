<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Pharmacy Records ‚Äì Dr. Charan Hospital</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=18"/>
</head>
<body>
  <header class="banner">
    <button id="themeToggle" class="chip floating-toggle" aria-label="Theme">üåô</button>
  </header>

  <nav class="fixed-actions">
    <a class="chip" href="dashboard.html">‚Üê Dashboard</a>
    <button id="logoutBtn" class="chip">Logout</button>
    <button id="clearCacheBtn" class="chip">Clear Cache</button>
  </nav>

  <section class="section">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <h1>Pharmacy Records</h1>
      <div class="range">
        <button class="chip active" data-range="daily">Daily</button>
        <button class="chip" data-range="weekly">Weekly</button>
        <button class="chip" data-range="monthly">Monthly</button>
        <button class="chip" data-range="yearly">Yearly</button>
      </div>
    </div>

    <div class="card-grid" style="margin-top:10px">
      <div class="card" style="background:var(--blue);"><h2>Total (selected)</h2><p id="rTotal">0.00</p></div>
      <div class="card" style="background:var(--lilac);"><h2>Invoices</h2><p id="rInv">0</p></div>
      <div class="card" style="background:var(--mint);"><h2>Avg / Invoice ‚Çπ</h2><p id="rAvg">0.00</p></div>
      <div class="card" style="background:var(--peach);"><h2>Top Item</h2><p id="rTop">‚Äî</p></div>
    </div>

    <div class="section" id="rList" style="margin-top:14px">
      <h2 style="margin-bottom:8px">Invoices</h2>
      <table class="table" id="tbl"></table>
    </div>
  </section>

  <script type="module">
    // theme toggle
    const t=document.getElementById('themeToggle');
    if(localStorage.theme){ document.documentElement.dataset.theme=localStorage.theme; t.textContent=localStorage.theme==='light'?'üåû':'üåô'; }
    t.onclick=()=>{ const cur=document.documentElement.dataset.theme||'light'; const next=cur==='light'?'dark':'light'; document.documentElement.dataset.theme=next; localStorage.theme=next; t.textContent=next==='light'?'üåû':'üåô'; };

    // guard: doctor view
    const ses=JSON.parse(localStorage.getItem('session')||'{}');
    if(ses.role!=='doctor'){ location.href='login.html'; }

    // actions
    document.getElementById('logoutBtn').onclick=()=>{ localStorage.removeItem('session'); location.href='login.html'; };
    document.getElementById('clearCacheBtn').onclick=async()=>{
      try{
        localStorage.clear();
        if('caches' in window){ const ks=await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k))); }
        if('serviceWorker' in navigator){ const regs=await navigator.serviceWorker.getRegistrations(); for(const r of regs) await r.unregister(); }
        alert('Cache cleared. Reloading‚Ä¶'); location.reload();
      }catch(e){ alert('Could not fully clear cache.'); }
    };

    // range chips active state
    const chips=[...document.querySelectorAll('[data-range]')];
    function markActive(btn){ chips.forEach(c=>c.classList.remove('active')); btn.classList.add('active'); }
    chips.forEach(btn=>btn.addEventListener('click', ()=>{ markActive(btn); load(btn.dataset.range); }));

    // helpers
    function sum(arr,fn){ return arr.reduce((a,b)=>a+fn(b),0); }
    function rowsBetween(start,end){
      const s=start.toISOString().slice(0,10), e=end.toISOString().slice(0,10);
      const store=JSON.parse(localStorage.getItem('sales')||'[]');
      return store.filter(r=>r.date>=s && r.date<=e);
    }
    function load(key){
      const end=new Date(); const start=new Date(end);
      if(key==='daily'){ /* start today */ }
      if(key==='weekly'){ start.setDate(end.getDate()-6); }
      if(key==='monthly'){ start.setDate(end.getDate()-29); }
      if(key==='yearly'){ start.setFullYear(end.getFullYear()-1); }
      const rows=rowsBetween(start,end);

      const total=sum(rows,r=>+r.total||0);
      const inv=rows.length;
      document.getElementById('rTotal').textContent=total.toFixed(2);
      document.getElementById('rInv').textContent=inv;
      document.getElementById('rAvg').textContent=(inv? total/inv : 0).toFixed(2);

      const byItem={}; rows.forEach(r=> (r.items||[]).forEach(i=>{ byItem[i.name]=(byItem[i.name]||0)+((+i.qty||0)*(+i.price||0)); }));
      const top=Object.entries(byItem).sort((a,b)=>b[1]-a[1])[0]?.[0] || '‚Äî';
      document.getElementById('rTop').textContent=top;

      const tbl=document.getElementById('tbl');
      tbl.innerHTML = `<thead><tr><th>Date</th><th>Invoice</th><th>Lines</th><th>Total ‚Çπ</th></tr></thead><tbody>${
        rows.map(r=>`<tr><td>${r.date}</td><td>${r.no||'-'}</td><td>${(r.items||[]).length}</td><td>${(+r.total||0).toFixed(2)}</td></tr>`).join('')
      }</tbody>`;
    }

    load('daily');
  </script>
</body>
</html>
