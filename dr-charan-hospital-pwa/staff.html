<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Staff ‚Ä¢ Dr. Charan Hospital</title>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=23"/>
</head>
<body>
  <!-- Banner -->
  <header class="banner">
    <button id="themeToggle" class="floating-toggle">üåô</button>
  </header>

  <!-- Fixed Actions -->
  <div class="fixed-actions">
    <a class="chip" href="dashboard.html">‚Üê Dashboard</a>
    <button class="chip" id="logoutBtn">Logout</button>
    <button class="chip" id="clearCacheBtn">Clear Cache</button>
  </div>

  <!-- Staff Summary -->
  <section class="section panel--mint">
    <h2>Staff ‚Ä¢ Roster & Attendance</h2>
    <div class="chips range mt12" id="viewChips">
      <button class="chip chip--blue active" data-view="today">Today</button>
      <button class="chip chip--peach" data-view="week">This Week</button>
      <button class="chip chip--lilac" data-view="month">This Month</button>
    </div>

    <div class="kpi-grid mt12">
      <div class="kpi panel--blue"><h4>On Duty</h4><div class="num" id="sumOn">0</div></div>
      <div class="kpi panel--mint"><h4>On Leave</h4><div class="num" id="sumLeave">0</div></div>
      <div class="kpi panel--peach"><h4>Late</h4><div class="num" id="sumLate">0</div></div>
      <div class="kpi panel--rose"><h4>Total</h4><div class="num" id="sumTotal">0</div></div>
    </div>
  </section>

  <!-- Attendance Table -->
  <section class="section panel--peach">
    <h2>Attendance Log</h2>
    <div class="chips mt12">
      <input id="search" class="input" placeholder="Search name/role" style="width:200px"/>
      <button id="markAllOnDuty" class="chip chip--mint">Mark All On Duty</button>
      <button id="exportCsv" class="chip chip--blue">Export CSV</button>
    </div>
    <table class="table mt12" id="tbl">
      <thead><tr><th>Name</th><th>Role</th><th>Status</th><th>Check-in</th><th>Notes</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </section>

  <script type="module">
    // --- Theme toggle
    const t=document.getElementById('themeToggle');
    if(localStorage.theme){document.documentElement.dataset.theme=localStorage.theme;t.textContent=localStorage.theme==='light'?'üåû':'üåô'}
    t.onclick=()=>{const cur=document.documentElement.dataset.theme||'light';const next=cur==='light'?'dark':'light';document.documentElement.dataset.theme=next;localStorage.theme=next;t.textContent=next==='light'?'üåû':'üåô'}

    // --- Role guard
    const ses=JSON.parse(localStorage.getItem('session')||'{}');
    if(!['doctor','supervisor'].includes(ses.role)){location.href='login.html'}

    // --- Logout / clear cache
    logoutBtn.onclick=()=>{localStorage.removeItem('session');location.href='login.html'}
    clearCacheBtn.onclick=async()=>{localStorage.clear();if('caches'in window){const ks=await caches.keys();await Promise.all(ks.map(k=>caches.delete(k)))};location.reload()}

    // --- Demo data
    const LS_KEY='staffRoster';
    if(!localStorage.getItem(LS_KEY)){
      localStorage.setItem(LS_KEY, JSON.stringify([
        {id:'S1',name:'Rohit',role:'Nurse',status:'On Duty',checkin:'09:00',notes:''},
        {id:'S2',name:'Swathi',role:'Admin',status:'On Leave',checkin:'‚Äî',notes:'Leave'},
        {id:'S3',name:'Anil',role:'Pharmacist',status:'Late',checkin:'10:15',notes:''}
      ]));
    }

    // --- Render
    function render(){
      const rows=JSON.parse(localStorage.getItem(LS_KEY)||'[]');
      const q=search.value.toLowerCase();
      const filtered=rows.filter(r=>r.name.toLowerCase().includes(q)||r.role.toLowerCase().includes(q));
      const tbody=document.getElementById('tbody'); tbody.innerHTML='';
      filtered.forEach(r=>{
        tbody.innerHTML+=`
          <tr>
            <td>${r.name}</td>
            <td>${r.role}</td>
            <td><select data-id="${r.id}" class="input"><option ${r.status==='On Duty'?'selected':''}>On Duty</option><option ${r.status==='On Leave'?'selected':''}>On Leave</option><option ${r.status==='Late'?'selected':''}>Late</option></select></td>
            <td>${r.checkin}</td>
            <td contenteditable data-id="${r.id}" data-field="notes">${r.notes||''}</td>
          </tr>`;
      });

      sumOn.textContent=rows.filter(r=>r.status==='On Duty').length;
      sumLeave.textContent=rows.filter(r=>r.status==='On Leave').length;
      sumLate.textContent=rows.filter(r=>r.status==='Late').length;
      sumTotal.textContent=rows.length;

      tbody.querySelectorAll('select').forEach(sel=>{
        sel.onchange=()=>{
          const id=sel.dataset.id;
          const all=JSON.parse(localStorage.getItem(LS_KEY)||'[]');
          const row=all.find(x=>x.id===id); if(row){row.status=sel.value;localStorage.setItem(LS_KEY,JSON.stringify(all));render();}
        };
      });
      tbody.querySelectorAll('[contenteditable]').forEach(cell=>{
        cell.onblur=()=>{
          const id=cell.dataset.id; const field=cell.dataset.field;
          const all=JSON.parse(localStorage.getItem(LS_KEY)||'[]');
          const row=all.find(x=>x.id===id); if(row){row[field]=cell.textContent;localStorage.setItem(LS_KEY,JSON.stringify(all));}
        };
      });
    }
    search.oninput=render;
    markAllOnDuty.onclick=()=>{const all=JSON.parse(localStorage.getItem(LS_KEY)||'[]').map(x=>({...x,status:'On Duty'}));localStorage.setItem(LS_KEY,JSON.stringify(all));render();}
    exportCsv.onclick=()=>{const rows=JSON.parse(localStorage.getItem(LS_KEY)||'[]');const csv='id,name,role,status,checkin,notes\n'+rows.map(r=>[r.id,r.name,r.role,r.status,r.checkin,r.notes].join(',')).join('\n');const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv]));a.download='staff.csv';a.click();}
    render();
  </script>
</body>
</html>
