<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Staff ‚Ä¢ Dr. Charan Hospital</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=18"/>
</head>
<body>
  <!-- Consistent banner -->
  <header class="banner">
    <button id="themeToggle" class="chip floating-toggle" aria-label="Theme">üåô</button>
  </header>

  <!-- Fixed actions row -->
  <nav class="fixed-actions">
    <a class="chip" href="dashboard.html">‚Üê Dashboard</a>
    <button id="logoutBtn" class="chip">Logout</button>
    <button id="clearCacheBtn" class="chip">Clear Cache</button>
  </nav>

  <section class="section">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <h1>Staff ‚Ä¢ Roster & Status</h1>
      <div class="range" id="viewChips">
        <button class="chip active" data-view="today">Today</button>
        <button class="chip" data-view="week">This Week</button>
        <button class="chip" data-view="month">This Month</button>
      </div>
    </div>

    <!-- Summary cards -->
    <div class="card-grid" style="margin-top:10px">
      <div class="card" style="background:var(--blue);">
        <h2>On Duty</h2><p id="sumOn">0</p>
      </div>
      <div class="card" style="background:var(--mint);">
        <h2>On Leave</h2><p id="sumLeave">0</p>
      </div>
      <div class="card" style="background:var(--peach);">
        <h2>Late</h2><p id="sumLate">0</p>
      </div>
      <div class="card" style="background:var(--lilac);">
        <h2>Total Staff</h2><p id="sumTotal">0</p>
      </div>
    </div>

    <!-- Attendance table -->
    <div class="section" style="margin-top:12px">
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <h2 style="margin:0">Attendance</h2>
        <input id="search" class="input" placeholder="Search name or role" style="width:220px"/>
        <button id="markAllOnDuty" class="chip">Mark All On Duty</button>
        <button id="exportCsv" class="chip">Export CSV</button>
      </div>
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th>Name</th><th>Role</th><th>Status</th><th>Check-in</th><th>Notes</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <script type="module">
    // Theme
    const t=document.getElementById('themeToggle');
    if(localStorage.theme){ document.documentElement.dataset.theme=localStorage.theme; t.textContent=localStorage.theme==='light'?'üåû':'üåô'; }
    t.onclick=()=>{ const cur=document.documentElement.dataset.theme||'light'; const next=cur==='light'?'dark':'light'; document.documentElement.dataset.theme=next; localStorage.theme=next; t.textContent=next==='light'?'üåû':'üåô'; };

    // Guard: Staff page allowed for doctor & supervisor
    const ses=JSON.parse(localStorage.getItem('session')||'{}');
    if(!['doctor','supervisor'].includes(ses.role)){ location.href='login.html'; }

    // Actions
    document.getElementById('logoutBtn').onclick=()=>{ localStorage.removeItem('session'); location.href='login.html'; };
    document.getElementById('clearCacheBtn').onclick=async()=>{
      try{
        localStorage.clear();
        if('caches' in window){ const ks=await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k))); }
        if('serviceWorker' in navigator){ const regs=await navigator.serviceWorker.getRegistrations(); for(const r of regs) await r.unregister(); }
        alert('Cache cleared. Reloading‚Ä¶'); location.reload();
      }catch(e){ alert('Could not fully clear cache.'); }
    };

    // Demo local storage structure for staff (works with your future Supabase sync)
    const LS_KEY='staffRoster';
    if(!localStorage.getItem(LS_KEY)){
      localStorage.setItem(LS_KEY, JSON.stringify([
        {id:'S001', name:'Rohit',   role:'Nurse',   status:'On Duty', checkin:'09:02', notes:''},
        {id:'S002', name:'Swathi',  role:'Admin',   status:'On Leave', checkin:'‚Äî',    notes:'Casual leave'},
        {id:'S003', name:'Anil',    role:'Pharmacist', status:'Late', checkin:'10:15', notes:''},
        {id:'S004', name:'Sana',    role:'Lab Tech',status:'On Duty', checkin:'08:55', notes:''}
      ]));
    }

    const chips=[...document.querySelectorAll('#viewChips .chip')];
    chips.forEach(c=>c.addEventListener('click',()=>{ chips.forEach(b=>b.classList.remove('active')); c.classList.add('active'); render(); }));
    document.getElementById('search').addEventListener('input', render);

    function getRows(){
      const q=(document.getElementById('search').value||'').toLowerCase();
      const rows=JSON.parse(localStorage.getItem(LS_KEY)||'[]');
      return rows.filter(r=> r.name.toLowerCase().includes(q) || r.role.toLowerCase().includes(q));
    }

    function render(){
      const rows=getRows();
      const tbody=document.getElementById('tbody');
      tbody.innerHTML = rows.map(r=>`
        <tr>
          <td>${r.name}</td>
          <td>${r.role}</td>
          <td>
            <select data-id="${r.id}" class="input" style="padding:4px 8px;width:auto">
              ${['On Duty','On Leave','Late','Off'].map(s=>`<option ${s===r.status?'selected':''}>${s}</option>`).join('')}
            </select>
          </td>
          <td>${r.checkin}</td>
          <td contenteditable data-id="${r.id}" data-field="notes">${r.notes||''}</td>
        </tr>`).join('');

      // summary
      const on = rows.filter(r=>r.status==='On Duty').length;
      const lv = rows.filter(r=>r.status==='On Leave').length;
      const lt = rows.filter(r=>r.status==='Late').length;
      document.getElementById('sumOn').textContent=on;
      document.getElementById('sumLeave').textContent=lv;
      document.getElementById('sumLate').textContent=lt;
      document.getElementById('sumTotal').textContent=rows.length;

      // listeners after render
      tbody.querySelectorAll('select').forEach(sel=>{
        sel.addEventListener('change', e=>{
          const id=e.target.dataset.id;
          const staff=JSON.parse(localStorage.getItem(LS_KEY)||'[]');
          const row=staff.find(s=>s.id===id); if(!row) return;
          row.status=e.target.value;
          localStorage.setItem(LS_KEY, JSON.stringify(staff));
          render();
        });
      });

      tbody.querySelectorAll('[contenteditable]').forEach(cell=>{
        cell.addEventListener('blur', e=>{
          const id=e.target.dataset.id, field=e.target.dataset.field;
          const staff=JSON.parse(localStorage.getItem(LS_KEY)||'[]');
          const row=staff.find(s=>s.id===id); if(!row) return;
          row[field]=e.target.textContent.trim();
          localStorage.setItem(LS_KEY, JSON.stringify(staff));
        });
      });
    }

    // quick helpers
    document.getElementById('markAllOnDuty').onclick=()=>{
      const staff=JSON.parse(localStorage.getItem(LS_KEY)||'[]').map(s=>({...s,status:'On Duty'}));
      localStorage.setItem(LS_KEY, JSON.stringify(staff)); render();
    };
    document.getElementById('exportCsv').onclick=()=>{
      const rows=JSON.parse(localStorage.getItem(LS_KEY)||'[]');
      const csv=['id,name,role,status,checkin,notes',...rows.map(r=>[r.id,r.name,r.role,r.status,r.checkin,(r.notes||'').replaceAll(',',';')].join(','))].join('\n');
      const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download='staff.csv'; a.click();
    };

    render();
  </script>
</body>
</html>
