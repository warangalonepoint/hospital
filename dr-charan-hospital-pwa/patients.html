<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Patients ‚Äì Dr. Charan Hospital</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=32"/>
  <style>
    .section{margin:12px}
    .tint{border-radius:16px;padding:16px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,.08)}
    .tint-blue{background: color-mix(in srgb, #2563eb 20%, var(--card-bg))}
    .tint-green{background: color-mix(in srgb, #22c55e 18%, var(--card-bg))}
    html[data-theme="dark"] .tint{border-color:rgba(255,255,255,.10)}

    .filters{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .chip{height:40px;padding:0 14px;border-radius:999px;background:var(--card-bg);border:1px solid rgba(0,0,0,.08)}
    html[data-theme="dark"] .chip{border-color:rgba(255,255,255,.12)}

    table{width:100%;border-collapse:collapse;margin-top:10px;background:var(--card-bg);border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid rgba(0,0,0,.06);font-size:13px;text-align:left;vertical-align:top}
    th{background:rgba(0,0,0,.04)}
    html[data-theme="dark"] th{background:rgba(255,255,255,.06)}

    .input, textarea, select{
      width:100%;border-radius:10px;border:1px solid rgba(0,0,0,.12);padding:8px;font-size:13px;background:var(--card-bg)
    }
    html[data-theme="dark"] .input, html[data-theme="dark"] textarea, html[data-theme="dark"] select{
      border-color:rgba(255,255,255,.12)
    }
    .row-actions{display:flex;gap:8px;flex-wrap:wrap}

    /* small helpers */
    .muted{color:var(--muted);font-size:12px}
    .right{margin-left:auto}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <!-- Banner -->
  <header class="banner">
    <button id="themeToggle" class="chip floating-toggle" aria-label="Theme">üåô</button>
  </header>

  <!-- Actions under banner -->
  <nav class="fixed-actions">
    <a href="dashboard.html" class="chip">‚Üê Dashboard</a>
    <button id="logoutBtn" class="chip">Logout</button>
    <button id="clearCacheBtn" class="chip">Clear Cache</button>
  </nav>

  <!-- Upcoming (from supervisor tokens) -->
  <section class="section tint tint-blue">
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:space-between">
      <h2>Upcoming Patients</h2>
      <span class="muted right">Source: Bookings created by Supervisor</span>
    </div>

    <div class="filters">
      <button class="chip" data-filter="today">Today</button>
      <button class="chip" data-filter="all">All</button>
      <input id="searchTxt" class="input" placeholder="Search name/phone" style="max-width:220px">
    </div>

    <table>
      <thead>
        <tr>
          <th class="nowrap">Token</th><th>Name</th><th>Phone</th><th>Date</th><th>Time</th><th>Notes</th><th>Action</th>
        </tr>
      </thead>
      <tbody id="upcomingBody"></tbody>
    </table>
  </section>

  <!-- Served & follow-ups -->
  <section class="section tint tint-green">
    <h2>Served Patients & Follow-ups</h2>
    <table>
      <thead>
        <tr>
          <th class="nowrap">Token</th><th>Name</th><th>Date</th>
          <th style="width:36%">Treatment Notes</th>
          <th class="nowrap">Next Visit</th>
          <th>Save</th><th>Delete</th>
        </tr>
      </thead>
      <tbody id="servedBody"></tbody>
    </table>
  </section>

  <script type="module">
    // ===== Theme toggle =====
    const themeBtn=document.getElementById('themeToggle');
    if(localStorage.theme){document.documentElement.dataset.theme=localStorage.theme;themeBtn.textContent=localStorage.theme==='light'?'üåû':'üåô'}
    themeBtn.onclick=()=>{const cur=document.documentElement.dataset.theme||'light';const nxt=cur==='light'?'dark':'light';document.documentElement.dataset.theme=nxt;localStorage.theme=nxt;themeBtn.textContent=nxt==='light'?'üåû':'üåô'}

    // ===== Guard: doctor only =====
    const sess=JSON.parse(localStorage.getItem('session')||'{}');
    if(sess.role!=='doctor'){ location.replace('login.html'); }

    // ===== Header actions =====
    document.getElementById('logoutBtn').onclick=()=>{ localStorage.removeItem('session'); location.href='login.html'; };
    document.getElementById('clearCacheBtn').onclick=async()=>{ localStorage.clear(); if('caches' in window){ const ks=await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k))); } location.reload(); };

    // ===== Data helpers =====
    const todayISO = new Date().toISOString().slice(0,10);
    const getBookings  = () => JSON.parse(localStorage.getItem('bookings')||'[]');
    const saveBookings = (arr) => localStorage.setItem('bookings', JSON.stringify(arr));
    const getServed    = () => JSON.parse(localStorage.getItem('servedPatients')||'[]');
    const saveServed   = (arr) => localStorage.setItem('servedPatients', JSON.stringify(arr));

    // Default reminder date (+7 days)
    const plusDays = (iso, n=7) => {
      const d=new Date(iso); d.setDate(d.getDate()+n);
      return d.toISOString().slice(0,10);
    };

    // ===== Upcoming list =====
    let curFilter='today', query='';
    function renderUpcoming(){
      let list = getBookings().filter(b=>!b.served);
      if(curFilter==='today') list = list.filter(b=>b.date===todayISO);
      if(query) list = list.filter(b => (b.name+b.phone+(b.note||'')).toLowerCase().includes(query));

      list.sort((a,b)=> (a.date+a.time).localeCompare(b.date+b.time) || a.token - b.token);

      const rows = list.map(b=>`
        <tr>
          <td>${b.token}</td>
          <td>${b.name}</td>
          <td>${b.phone}</td>
          <td>${b.date}</td>
          <td>${b.time}</td>
          <td>${b.note||''}</td>
          <td>
            <div class="row-actions">
              <button class="btn serveBtn" data-id="${b.id}">Serve</button>
            </div>
          </td>
        </tr>`).join('');

      document.getElementById('upcomingBody').innerHTML = rows || `<tr><td colspan="7" class="muted">No bookings</td></tr>`;

      document.querySelectorAll('.serveBtn').forEach(btn=>{
        btn.onclick=()=>servePatient(btn.dataset.id);
      });
    }

    function servePatient(id){
      const books = getBookings();
      const rec   = books.find(x=>x.id===id);
      if(!rec) return;

      // Mark served in bookings (local)
      rec.served = true;
      saveBookings(books);

      // Add to servedPatients with empty notes + default reminder (+7d)
      const served = getServed();
      served.push({
        id: rec.id, token: rec.token, name: rec.name, phone: rec.phone,
        date: rec.date, time: rec.time, note: rec.note||'',
        treatment: '', reminderISO: plusDays(todayISO, 7)
      });
      saveServed(served);

      renderUpcoming();
      renderServed();
      // notify dashboard badge if open
      window.dispatchEvent(new StorageEvent('storage', { key: 'servedPatients' }));
    }

    // ===== Served list =====
    function renderServed(){
      const list = getServed().sort((a,b)=> (b.date+b.time).localeCompare(a.date+a.time));
      const rows = list.map(p=>`
        <tr>
          <td>${p.token||''}</td>
          <td>${p.name||''}</td>
          <td>${p.date||''}</td>
          <td><textarea class="input" rows="2" data-note="${p.id}">${p.treatment||''}</textarea></td>
          <td><input class="input" type="date" data-rem="${p.id}" value="${p.reminderISO||''}"></td>
          <td><button class="btn" data-save="${p.id}">Save</button></td>
          <td><button class="chip" data-del="${p.id}">Delete</button></td>
        </tr>`).join('');

      document.getElementById('servedBody').innerHTML = rows || `<tr><td colspan="7" class="muted">None yet</td></tr>`;

      // Save actions
      document.querySelectorAll('[data-save]').forEach(btn=>{
        btn.onclick=()=>{
          const id = btn.dataset.save;
          const all= getServed();
          const rec= all.find(x=>x.id===id);
          if(!rec) return;
          rec.treatment   = (document.querySelector(`[data-note="${id}"]`)?.value||'').trim();
          rec.reminderISO = (document.querySelector(`[data-rem="${id}"]`)?.value||'').trim();
          saveServed(all);
          alert('Saved');
          window.dispatchEvent(new StorageEvent('storage', { key: 'servedPatients' }));
        };
      });

      // Delete actions
      document.querySelectorAll('[data-del]').forEach(btn=>{
        btn.onclick=()=>{
          const id = btn.dataset.del;
          if(!confirm('Delete this served record?')) return;
          const all = getServed().filter(x=>x.id!==id);
          saveServed(all);
          renderServed();
          window.dispatchEvent(new StorageEvent('storage', { key: 'servedPatients' }));
        };
      });
    }

    // Filters & search
    document.querySelectorAll('[data-filter]').forEach(btn=>{
      btn.onclick=()=>{ curFilter = btn.dataset.filter; renderUpcoming(); };
    });
    document.getElementById('searchTxt').oninput=(e)=>{
      query = (e.target.value||'').toLowerCase().trim();
      renderUpcoming();
    };

    // Init
    renderUpcoming();
    renderServed();

    // SW
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(()=>{}) }
  </script>
</body>
</html>
