<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Patients ‚Äì Dr. Charan Hospital</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=27"/>
  <style>
    .section{margin:12px}
    .tint{border-radius:16px;padding:16px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,.06)}
    .tint-blue{background: color-mix(in srgb, #2563eb 14%, var(--card-bg))}
    .tint-green{background: color-mix(in srgb, #22c55e 14%, var(--card-bg))}
    .tint-rose{background: color-mix(in srgb, #f43f5e 14%, var(--card-bg))}
    .filters{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .chip{height:40px;padding:0 14px;border-radius:999px;background:var(--card-bg);border:1px solid rgba(0,0,0,.06)}
    table{width:100%;border-collapse:collapse;margin-top:10px;background:var(--card-bg);border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid rgba(0,0,0,.06);font-size:13px;text-align:left}
    th{background:rgba(0,0,0,.04)}
    html[data-theme="dark"] th{background:rgba(255,255,255,.06)}
    textarea{width:100%;border-radius:10px;border:1px solid rgba(0,0,0,.12);padding:8px;font-size:13px}
  </style>
</head>
<body>
  <!-- Banner -->
  <header class="banner">
    <button id="themeToggle" class="chip floating-toggle" aria-label="Theme">üåô</button>
  </header>

  <!-- Actions -->
  <nav class="fixed-actions">
    <a href="dashboard.html" class="chip">‚Üê Dashboard</a>
    <button id="logoutBtn" class="chip">Logout</button>
    <button id="clearCacheBtn" class="chip">Clear Cache</button>
  </nav>

  <!-- Patients -->
  <section class="section tint tint-blue">
    <h2>Upcoming Patients</h2>
    <div class="filters">
      <button class="chip" data-filter="today">Today</button>
      <button class="chip" data-filter="all">All</button>
    </div>
    <table>
      <thead>
        <tr><th>Token</th><th>Name</th><th>Phone</th><th>Date</th><th>Time</th><th>Notes</th><th>Action</th></tr>
      </thead>
      <tbody id="upcomingBody"></tbody>
    </table>
  </section>

  <section class="section tint tint-green">
    <h2>Served Patients</h2>
    <table>
      <thead>
        <tr><th>Token</th><th>Name</th><th>Date</th><th>Treatment Notes</th><th>Reminder</th></tr>
      </thead>
      <tbody id="servedBody"></tbody>
    </table>
  </section>

  <script type="module">
    // --- Theme
    const t=document.getElementById('themeToggle');
    if(localStorage.theme){document.documentElement.dataset.theme=localStorage.theme;t.textContent=localStorage.theme==='light'?'üåû':'üåô'}
    t.onclick=()=>{const cur=document.documentElement.dataset.theme||'light';const nxt=cur==='light'?'dark':'light';document.documentElement.dataset.theme=nxt;localStorage.theme=nxt;t.textContent=nxt==='light'?'üåû':'üåô'}

    // --- Guard: doctor only
    const sess=JSON.parse(localStorage.getItem('session')||'{}');
    if(sess.role!=='doctor'){location.replace('login.html')}

    // --- Actions
    logoutBtn.onclick=()=>{localStorage.removeItem('session');location.href='login.html'}
    clearCacheBtn.onclick=async()=>{localStorage.clear();if('caches'in window){const ks=await caches.keys();await Promise.all(ks.map(k=>caches.delete(k)))};location.reload()}

    // --- Data
    const bookings=()=>JSON.parse(localStorage.getItem('bookings')||'[]');
    const served=()=>JSON.parse(localStorage.getItem('servedPatients')||'[]');
    const saveServed=(arr)=>localStorage.setItem('servedPatients',JSON.stringify(arr));
    const today=new Date().toISOString().slice(0,10);

    function renderUpcoming(filter='today'){
      const all=bookings();
      let list=all;
      if(filter==='today'){list=all.filter(b=>b.date===today)}
      upcomingBody.innerHTML=list.map(b=>`
        <tr>
          <td>${b.token}</td>
          <td>${b.name}</td>
          <td>${b.phone}</td>
          <td>${b.date}</td>
          <td>${b.time}</td>
          <td>${b.note||''}</td>
          <td><button class="chip serveBtn" data-id="${b.id}">Serve</button></td>
        </tr>`).join('')||`<tr><td colspan="7">No bookings</td></tr>`;
      document.querySelectorAll('.serveBtn').forEach(btn=>{
        btn.onclick=()=>servePatient(btn.dataset.id);
      });
    }

    function renderServed(){
      const list=served();
      servedBody.innerHTML=list.map(p=>`
        <tr>
          <td>${p.token}</td>
          <td>${p.name}</td>
          <td>${p.date}</td>
          <td>${p.treatment||''}</td>
          <td>${p.reminder||''}</td>
        </tr>`).join('')||`<tr><td colspan="5">None yet</td></tr>`;
    }

    function servePatient(id){
      const all=bookings();
      const rec=all.find(b=>b.id===id);
      if(!rec) return;
      const notes=prompt("Treatment / Medicines for "+rec.name,"");
      const reminder=prompt("Next Visit Reminder (date or text)","");
      const newServed=served();
      newServed.push({...rec,treatment:notes,reminder});
      saveServed(newServed);
      renderServed();
    }

    // Filters
    document.querySelectorAll('[data-filter]').forEach(btn=>{
      btn.onclick=()=>renderUpcoming(btn.dataset.filter);
    });

    renderUpcoming('today');
    renderServed();

    if('serviceWorker' in navigator){navigator.serviceWorker.register('service-worker.js').catch(()=>{})}
  </script>
</body>
</html>
