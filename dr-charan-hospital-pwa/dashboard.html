<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Doctor Dashboard â€“ Dr. Charan</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=20"/>
</head>
<body>
  <header class="banner">
    <button id="themeToggle" class="chip floating-toggle small" aria-label="Theme">ðŸŒ™</button>
  </header>

  <!-- toolbar BELOW the banner -->
  <div class="toolbar">
    <a href="login.html" id="logoutBtn" class="chip small">Logout</a>
    <button id="clearCacheBtn" class="chip small">Clear Cache</button>
  </div>

  <main class="container">
    <!-- Tiles -->
    <section class="card" style="padding:18px">
      <div class="tile-grid">
        <a class="tile lilac" href="analytics.html">
          <div class="title">Analytics</div>
          <div class="sub">KPIs & weekly sales</div>
        </a>

        <a class="tile ice" href="pharmacy.html" id="pharmaTile">
          <div class="title">Pharmacy</div>
          <div class="sub" id="pharmaMeta">Today â‚¹0.00 â€¢ MTD â‚¹0.00 â€¢ Top: â€“</div>
        </a>

        <a class="tile mint" href="patient.html">
          <div class="title">Bookings</div>
          <div class="sub">Quick patient slots</div>
        </a>

        <a class="tile peach" href="portal.html">
          <div class="title">Patients</div>
          <div class="sub">Reminders & history</div>
        </a>

        <a class="tile mint" href="admin.html">
          <div class="title">Staff</div>
          <div class="sub">Roster & status</div>
        </a>

        <a class="tile lilac" href="settings.html">
          <div class="title">Settings</div>
          <div class="sub">PINs, Staff, Patients</div>
        </a>
      </div>
    </section>

    <!-- KPIs + mini chart -->
    <section class="card" style="margin-top:16px;padding:18px">
      <h3 class="section-title">Sales Analytics</h3>
      <div class="kpis">
        <div class="kpi"><div class="n" id="kToday">0.00</div><div class="muted">Today â‚¹</div></div>
        <div class="kpi"><div class="n" id="kMonth">0.00</div><div class="muted">This Month â‚¹</div></div>
        <div class="kpi"><div class="n" id="kTop">â€“</div><div class="muted">Top Item</div></div>
      </div>

      <div class="chart-card">
        <canvas id="miniChart" height="170" style="width:100%"></canvas>
      </div>
    </section>
  </main>

  <script type="module">
    import { requireRole, totalsToday, totalsMonth, topItemName, listInvoices, logout as doLogout } from './js/store.js?v=21';

    const u=requireRole('doctor'); if(!u){ location.href='login.html'; }

    // theme
    const t=document.getElementById('themeToggle');
    if(localStorage.theme){ document.documentElement.dataset.theme=localStorage.theme; t.textContent=localStorage.theme==='light'?'ðŸŒž':'ðŸŒ™'; }
    t.onclick=()=>{ const cur=document.documentElement.dataset.theme||'light'; const next=cur==='light'?'dark':'light'; document.documentElement.dataset.theme=next; localStorage.theme=next; t.textContent=next==='light'?'ðŸŒž':'ðŸŒ™'; };

    // cache + logout
    document.getElementById('clearCacheBtn').onclick=async()=>{
      try{
        localStorage.clear();
        if('caches' in window){ const ks=await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k))); }
        if('serviceWorker' in navigator){ const regs=await navigator.serviceWorker.getRegistrations(); for(const r of regs) await r.unregister(); }
        alert('Cache cleared. Reloadingâ€¦'); location.reload(true);
      }catch(e){ alert('Could not fully clear. Try hard reload.'); }
    };
    document.getElementById('logoutBtn').onclick=(e)=>{ e.preventDefault(); doLogout(); location.href='login.html'; };

    async function refreshKPIs(){
      const t=await totalsToday();
      const m=await totalsMonth();
      const top=await topItemName();
      document.getElementById('kToday').textContent=t.toFixed(2);
      document.getElementById('kMonth').textContent=m.toFixed(2);
      document.getElementById('kTop').textContent=top||'â€“';
      document.getElementById('pharmaMeta').textContent=`Today â‚¹${t.toFixed(2)} â€¢ MTD â‚¹${m.toFixed(2)} â€¢ Top: ${top||'â€“'}`;
      drawMini();
    }

    function drawMini(){
      const c=document.getElementById('miniChart'), ctx=c.getContext('2d');
      c.width=c.clientWidth*2; c.height=c.clientHeight*2; ctx.scale(2,2);
      const W=c.clientWidth, H=c.clientHeight, pad=24;
      ctx.clearRect(0,0,W,H);
      const border=getComputedStyle(document.documentElement).getPropertyValue('--border')||'#e9edf5';
      ctx.strokeStyle=border; ctx.beginPath(); ctx.moveTo(pad,H-pad); ctx.lineTo(W-pad,H-pad); ctx.stroke();

      const invs=listInvoices(); const today=new Date();
      const labels=[], data=[];
      for(let i=6;i>=0;i--){
        const d=new Date(today); d.setDate(today.getDate()-i);
        const key=d.toISOString().slice(0,10);
        labels.push(key.slice(5)); // MM-DD
        data.push(invs.filter(x=>x.date===key).reduce((s,r)=>s+(+r.total||0),0));
      }
      const max=Math.max(10,...data);
      const slot=(W-pad*2)/labels.length, bw=slot*0.6, base=H-pad;
      const primary=getComputedStyle(document.documentElement).getPropertyValue('--primary')||'#5166ff';

      data.forEach((v,i)=>{
        const h=Math.round((v/max)*(H-pad*2));
        const x=pad+i*slot+(slot-bw)/2;
        ctx.fillStyle=primary;
        ctx.fillRect(x,base-h,bw,h);
      });

      ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--muted')||'#7b8';
      ctx.font='11px system-ui'; ctx.textAlign='center';
      labels.forEach((lb,i)=>{ const x=pad+i*slot+slot/2; ctx.fillText(lb,x,H-6); });
    }

    refreshKPIs(); addEventListener('resize', drawMini);
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }
  </script>
</body>
</html>
