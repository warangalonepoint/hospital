<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Doctor Dashboard â€“ Dr. Charan Hospital</title>

  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css"/>

  <!-- Chart.js (local, offline-first) -->
  <script defer src="assets/chart.umd.min.js"></script>
</head>
<body>
  <!-- Banner -->
  <header class="banner" role="img" aria-label="Dr. Charan Hospital">
    <!-- theme toggle -->
    <button id="themeToggle" class="chip floating-toggle" aria-label="Theme">ðŸŒ™</button>
  </header>

  <!-- Top actions (NOT on the banner) -->
  <div class="top-actions container">
    <button id="logoutBtn" class="chip">Logout</button>
    <button id="clearCacheBtn" class="chip">Clear Cache</button>
  </div>

  <!-- Quick grid -->
  <main class="container">
    <section class="card grid-2 gap-16">
      <a class="tile tile--lav" href="analytics.html">
        <h3>Analytics</h3>
        <p>KPIs & weekly sales</p>
      </a>
      <a class="tile tile--sky" href="pharmacy.html">
        <h3>Pharmacy</h3>
        <p id="pharmaToday">Today â‚¹0.00 â€¢ MTD â‚¹0.00 â€¢ Top: â€”</p>
      </a>
      <a class="tile tile--mint" href="bookings.html">
        <h3>Bookings</h3>
        <p>Quick patient slots</p>
      </a>
      <a class="tile tile--peach" href="patient.html">
        <h3>Patients</h3>
        <p>Reminders & history</p>
      </a>
      <a class="tile tile--mint" href="staff.html">
        <h3>Staff</h3>
        <p>Roster & status</p>
      </a>
      <a class="tile tile--lav" href="settings.html">
        <h3>Settings</h3>
        <p>PINs, Staff, Patients</p>
      </a>
    </section>

    <!-- Sales Analytics -->
    <section class="card">
      <h2>Sales Analytics</h2>

      <div class="kpi-row">
        <div class="kpi">
          <div class="kpi-num" id="kpiToday">0.00</div>
          <div class="kpi-label">Today â‚¹</div>
        </div>
        <div class="kpi">
          <div class="kpi-num" id="kpiMonth">0.00</div>
          <div class="kpi-label">This Month â‚¹</div>
        </div>
        <div class="kpi">
          <div class="kpi-num" id="kpiTop">â€”</div>
          <div class="kpi-label">Top Item</div>
        </div>
      </div>

      <div class="charts">
        <div class="chart-card">
          <h4>Today by Item</h4>
          <canvas id="pieToday"></canvas>
        </div>
        <div class="chart-card">
          <h4>Last 7 Days Revenue</h4>
          <canvas id="line7"></canvas>
        </div>
      </div>
    </section>
  </main>

  <script>
    /* -------------------------
       Session guard (doctor only)
    -------------------------- */
    (function guard() {
      try {
        const s = JSON.parse(localStorage.getItem('session') || '{}');
        if (!s.role) location.replace('login.html');
        if (s.role !== 'doctor') {
          // Supervisors & others donâ€™t see doctor dashboard
          location.replace(s.role === 'supervisor' ? 'admin.html' : 'login.html');
        }
      } catch { location.replace('login.html'); }
    })();

    /* -------------------------
       Theme
    -------------------------- */
    const html = document.documentElement;
    const themeBtn = document.getElementById('themeToggle');
    function applyTheme(t) {
      html.dataset.theme = t;
      themeBtn.textContent = t === 'light' ? 'ðŸŒž' : 'ðŸŒ™';
      localStorage.theme = t;
    }
    applyTheme(localStorage.theme || 'light');
    themeBtn.addEventListener('click', () => {
      applyTheme((html.dataset.theme || 'light') === 'light' ? 'dark' : 'light');
    });

    /* -------------------------
       Actions
    -------------------------- */
    document.getElementById('logoutBtn').onclick = () => {
      localStorage.removeItem('session');
      location.href = 'login.html';
    };

    document.getElementById('clearCacheBtn').onclick = async () => {
      try {
        // keep session, nuke everything else
        const session = localStorage.getItem('session');
        localStorage.clear();
        if (session) localStorage.setItem('session', session);

        if ('caches' in window) {
          const ks = await caches.keys();
          await Promise.all(ks.map(k => caches.delete(k)));
        }
        if ('serviceWorker' in navigator) {
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r => r.unregister()));
        }
        alert('Cache cleared. Reloadingâ€¦');
        location.reload(true);
      } catch {
        alert('Could not fully clear cache.');
      }
    };

    /* -------------------------
       Data helpers
       Reads invoices from localStorage.invoices (array of:
       {date: "YYYY-MM-DD", lines: [{name, qty, price}], paid})
       Falls back to seeded demo so charts always render.
    -------------------------- */
    function fmtINR(n) {
      return Number(n || 0).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function startOfDayStr(d = new Date()) {
      const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      return x.toISOString().slice(0,10);
    }

    function getInvoices() {
      try {
        const raw = localStorage.getItem('invoices');
        const arr = raw ? JSON.parse(raw) : null;
        if (Array.isArray(arr) && arr.length) return arr;
      } catch {}
      // Seed 7 days of demo if nothing exists
      const names = ['Paracetamol 650', 'Amoxicillin', 'Cough Syrup', 'Vitamin D', 'Ibuprofen'];
      const today = new Date();
      const demo = [];
      for (let i=6;i>=0;i--) {
        const d = new Date(today); d.setDate(today.getDate()-i);
        const lines = Array.from({length: 3 + (i%3)}, () => {
          const name = names[Math.floor(Math.random()*names.length)];
          const qty = 1 + Math.floor(Math.random()*3);
          const price = 50 + Math.floor(Math.random()*250);
          return { name, qty, price };
        });
        demo.push({ date: startOfDayStr(d), lines, paid: true });
      }
      return demo;
    }

    function summarize(invoices) {
      const todayStr = startOfDayStr();
      let todayTotal = 0;
      const todayByItem = new Map();
      const monthPrefix = new Date().toISOString().slice(0,7); // YYYY-MM
      let monthTotal = 0;
      const dayMap = new Map(); // date -> total

      for (const inv of invoices) {
        const invTotal = (inv.lines || []).reduce((s,l)=>s + (l.qty||0)*(l.price||0), 0);
        // per-day
        dayMap.set(inv.date, (dayMap.get(inv.date)||0) + invTotal);
        // month
        if ((inv.date||'').startsWith(monthPrefix)) monthTotal += invTotal;
        // today
        if (inv.date === todayStr) {
          todayTotal += invTotal;
          for (const l of inv.lines || []) {
            const key = l.name || 'Item';
            const amount = (l.qty||0)*(l.price||0);
            todayByItem.set(key, (todayByItem.get(key)||0) + amount);
          }
        }
      }

      // top item label
      let topItem = 'â€”';
      if (todayByItem.size) {
        topItem = [...todayByItem.entries()].sort((a,b)=>b[1]-a[1])[0][0];
      }

      return { todayTotal, monthTotal, todayByItem, dayMap, topItem };
    }

    /* -------------------------
       Render KPIs + Charts
    -------------------------- */
    function render() {
      const invoices = getInvoices();
      const sum = summarize(invoices);

      // KPIs
      document.getElementById('kpiToday').textContent = fmtINR(sum.todayTotal);
      document.getElementById('kpiMonth').textContent = fmtINR(sum.monthTotal);
      document.getElementById('kpiTop').textContent = sum.topItem;
      const pharmaToday = document.getElementById('pharmaToday');
      if (pharmaToday) {
        pharmaToday.textContent = `Today â‚¹${fmtINR(sum.todayTotal)} â€¢ MTD â‚¹${fmtINR(sum.monthTotal)} â€¢ Top: ${sum.topItem || 'â€”'}`;
      }

      // Pie: today by item
      const pieCtx = document.getElementById('pieToday').getContext('2d');
      const pieLabels = [...sum.todayByItem.keys()];
      const pieValues = [...sum.todayByItem.values()];
      new Chart(pieCtx, {
        type: 'pie',
        data: {
          labels: pieLabels.length ? pieLabels : ['No sales'],
          datasets: [{
            data: pieValues.length ? pieValues : [1],
            borderWidth: 0
          }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { callbacks: { label: (c)=> `â‚¹${fmtINR(c.parsed)}` } }
          }
        }
      });

      // Line: last 7 days
      const lineCtx = document.getElementById('line7').getContext('2d');
      const labels = [];
      const values = [];
      for (let i=6;i>=0;i--) {
        const d = new Date(); d.setDate(d.getDate()-i);
        const key = startOfDayStr(d);
        labels.push(d.toLocaleDateString('en-IN', { day:'2-digit', month:'short' }));
        values.push(sum.dayMap.get(key) || 0);
      }
      new Chart(lineCtx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            data: values,
            fill: false,
            tension: 0.3,
            pointRadius: 3,
            borderWidth: 2
          }]
        },
        options: {
          scales: {
            y: { ticks: { callback: v => 'â‚¹' + fmtINR(v) } }
          },
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (c)=> 'â‚¹' + fmtINR(c.parsed.y) } }
          }
        }
      });
    }

    // Run when Chart.js is ready
    if (window.Chart) render(); else {
      document.addEventListener('DOMContentLoaded', () => {
        const iv = setInterval(() => {
          if (window.Chart) { clearInterval(iv); render(); }
        }, 30);
      });
    }
  </script>
</body>
</html>
