<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Doctor Dashboard â€“ Dr. Charan Hospital</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="assets/logo.png" />
  <link rel="stylesheet" href="styles.css?v=21" />
  <meta name="theme-color" content="#0b5a83" />
</head>
<body>
  <!-- Banner (fixed height, fully responsive) -->
  <header class="banner">
    <button id="themeToggle" class="chip floating-toggle" aria-label="Theme">ðŸŒ™</button>
  </header>

  <!-- Small sticky action chips (not on the banner) -->
  <div class="fixed-actions">
    <button id="logoutBtn" class="chip" type="button">Logout</button>
    <button id="clearCacheBtn" class="chip" type="button">Clear Cache</button>
  </div>

  <main class="container">
    <!-- Tiles -->
    <section class="card card--panel">
      <div class="tiles">
        <a class="tile tile--lav" href="analytics.html">
          <h3>Analytics</h3>
          <p>KPIs & weekly sales</p>
        </a>

        <a class="tile tile--ice" href="pharmacy.html" id="pharmacyCard">
          <h3>Pharmacy</h3>
          <p id="pharmaSummary">Loadingâ€¦</p>
        </a>

        <a class="tile tile--mint" href="portal.html#bookings">
          <h3>Bookings</h3>
          <p>Quick patient slots</p>
        </a>

        <a class="tile tile--peach" href="patient.html">
          <h3>Patients</h3>
          <p>Reminders & history</p>
        </a>

        <a class="tile tile--mint" href="settings.html#staff">
          <h3>Staff</h3>
          <p>Roster & status</p>
        </a>

        <a class="tile tile--lav" href="settings.html">
          <h3>Settings</h3>
          <p>PINs, Staff, Patients</p>
        </a>
      </div>
    </section>

    <!-- Sales analytics strip -->
    <section class="card">
      <h2>Sales Analytics</h2>
      <div class="stats">
        <div class="stat">
          <div class="stat__value" id="statToday">0.00</div>
          <div class="stat__label">Today â‚¹</div>
        </div>
        <div class="stat">
          <div class="stat__value" id="statMonth">0.00</div>
          <div class="stat__label">This Month â‚¹</div>
        </div>
        <div class="stat">
          <div class="stat__value" id="statTop">â€“</div>
          <div class="stat__label">Top Item</div>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
    /* ---------------- Role gate: only doctor ---------------- */
    (function enforceRole() {
      try {
        const s = JSON.parse(localStorage.getItem('session') || 'null');
        if (!s || !s.role) { location.replace('login.html'); return; }
        if (s.role !== 'doctor') {
          // Supervisors/Admins should not see dashboard
          location.replace('admin.html');
          return;
        }
      } catch {
        location.replace('login.html');
      }
    })();

    /* ---------------- Theme toggle ---------------- */
    const themeBtn = document.getElementById('themeToggle');
    const setTheme = (mode) => {
      document.documentElement.dataset.theme = mode;
      localStorage.theme = mode;
      themeBtn.textContent = mode === 'light' ? 'ðŸŒž' : 'ðŸŒ™';
    };
    setTheme(localStorage.theme || 'light');
    themeBtn.addEventListener('click', () => {
      setTheme((document.documentElement.dataset.theme || 'light') === 'light' ? 'dark' : 'light');
    });

    /* ---------------- Actions: logout / clear cache ---------------- */
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('session');
      location.replace('login.html');
    });

    document.getElementById('clearCacheBtn').addEventListener('click', async () => {
      try {
        const sess = localStorage.getItem('session'); // keep session if logged in
        localStorage.clear();
        if (sess) localStorage.setItem('session', sess);

        if ('caches' in window) {
          const names = await caches.keys();
          await Promise.all(names.map((n) => caches.delete(n)));
        }
        if ('serviceWorker' in navigator) {
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map((r) => r.unregister()));
        }
        alert('Cache cleared. Reloadingâ€¦');
        location.reload();
      } catch (e) {
        alert('Could not fully clear cache. Try a hard reload.');
      }
    });

    /* ---------------- Data: pharmacy summary ----------------
       Priority:
       1) If window.fetchPharmacySummary exists (Supabase), use it.
       2) Else derive from localStorage key "pharma_invoices"
          invoice shape: {date: "YYYY-MM-DD", items:[{name, qty, price}], total}
    ---------------------------------------------------------- */
    async function loadPharmacySummary() {
      let todayAmt = 0, mtdAmt = 0, topItemName = 'â€“';

      try {
        if (typeof window.fetchPharmacySummary === 'function') {
          // Hook for Supabase integration youâ€™ll add later
          const r = await window.fetchPharmacySummary();
          todayAmt = r.todayAmount ?? 0;
          mtdAmt = r.monthAmount ?? 0;
          topItemName = r.topItem ?? 'â€“';
        } else {
          const raw = JSON.parse(localStorage.getItem('pharma_invoices') || '[]');
          const todayStr = new Date().toISOString().slice(0,10);
          const ym = todayStr.slice(0,7); // YYYY-MM

          const itemQty = new Map();

          for (const inv of raw) {
            if (!inv || !inv.date) continue;
            const total = Number(inv.total || 0);
            if (inv.date === todayStr) todayAmt += total;
            if ((inv.date || '').startsWith(ym)) mtdAmt += total;

            (inv.items || []).forEach(it => {
              if (!it || !it.name) return;
              const q = Number(it.qty || 0);
              itemQty.set(it.name, (itemQty.get(it.name) || 0) + q);
            });
          }

          if (itemQty.size) {
            topItemName = [...itemQty.entries()].sort((a,b)=>b[1]-a[1])[0][0];
          }
        }
      } catch (e) {
        console.warn('Summary calc failed', e);
      }

      // Update UI
      const fmt = (n) => (Number(n || 0)).toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:2});
      document.getElementById('pharmaSummary').textContent =
        `Today â‚¹${fmt(todayAmt)} â€¢ MTD â‚¹${fmt(mtdAmt)} â€¢ Top: ${topItemName}`;

      document.getElementById('statToday').textContent = fmt(todayAmt);
      document.getElementById('statMonth').textContent = fmt(mtdAmt);
      document.getElementById('statTop').textContent = topItemName;
    }

    loadPharmacySummary();

    /* --------------- Register Service Worker (quiet) --------------- */
    if ('serviceWorker' in navigator) {
      setTimeout(() => {
        navigator.serviceWorker.register('service-worker.js').catch(()=>{});
      }, 300);
    }
  </script>
</body>
</html>
