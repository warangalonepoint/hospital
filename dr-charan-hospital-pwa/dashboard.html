<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Doctor Dashboard â€“ Dr. Charan Hospital</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=22"/>
</head>
<body>
  <!-- Banner -->
  <header class="banner">
    <button id="themeToggle" class="chip floating-toggle" aria-label="Theme">ðŸŒ™</button>
  </header>

  <!-- Top actions -->
  <div class="fixed-actions">
    <button class="chip" id="logoutBtn">Logout</button>
    <button class="chip" id="clearCacheBtn">Clear Cache</button>
  </div>

  <!-- Feature cards -->
  <section class="section section--surface">
    <div class="card-grid">
      <a class="card card--lavender" href="analytics.html">
        <h2>Analytics</h2><p>KPIs & weekly sales</p>
      </a>
      <a class="card card--blue" href="pharmacy.html">
        <h2>Pharmacy</h2><p id="phSnap">Today â‚¹0.00 â€¢ MTD â‚¹0.00 â€¢ Top: â€”</p>
      </a>
      <a class="card card--mint" href="bookings.html">
        <h2>Bookings</h2><p>Quick patient slots</p>
      </a>
      <a class="card card--peach" href="patients.html">
        <h2>Patients</h2><p>Reminders & history</p>
      </a>
      <a class="card card--mint2" href="staff.html">
        <h2>Staff</h2><p>Roster & status</p>
      </a>
      <a class="card card--lavender2" href="settings.html">
        <h2>Settings</h2><p>PINs, Staff, Patients</p>
      </a>
    </div>
  </section>

  <!-- Charts -->
  <section class="section section--surface">
    <div class="section__head"><h2>Sales Analytics (Today)</h2></div>
    <div class="section__body">
      <div class="chart-grid">
        <div class="chart-card"><canvas id="lineChart"></canvas></div>
        <div class="chart-card"><canvas id="pieChart"></canvas></div>
      </div>
      <div class="stat-grid">
        <div class="stat"><div class="stat__value" id="todayAmt">0.00</div><div class="stat__label">Today â‚¹</div></div>
        <div class="stat"><div class="stat__value" id="monthAmt">0.00</div><div class="stat__label">This Month â‚¹</div></div>
        <div class="stat"><div class="stat__value" id="topItem">â€”</div><div class="stat__label">Top Item</div></div>
      </div>
    </div>
  </section>

  <script src="assets/chart.umd.min.js"></script>
  <script type="module">
    // Theme
    const t=document.getElementById('themeToggle');
    if(localStorage.theme){ document.documentElement.dataset.theme=localStorage.theme; t.textContent=localStorage.theme==='light'?'ðŸŒž':'ðŸŒ™'; }
    t.onclick=()=>{ const cur=document.documentElement.dataset.theme||'light'; const next=cur==='light'?'dark':'light'; document.documentElement.dataset.theme=next; localStorage.theme=next; t.textContent=next==='light'?'ðŸŒž':'ðŸŒ™'; };

    // Guard: doctor only
    try{
      const s = JSON.parse(localStorage.getItem('session')||'{}');
      if(s.role!=='doctor'){ location.href='login.html'; }
    }catch{ location.href='login.html'; }

    // Buttons
    document.getElementById('clearCacheBtn').onclick=async()=>{
      localStorage.clear();
      if('caches' in window){ const ks=await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k))); }
      if('serviceWorker' in navigator){ const regs=await navigator.serviceWorker.getRegistrations(); for(const r of regs) await r.unregister(); }
      alert('Cache cleared'); location.reload();
    };
    document.getElementById('logoutBtn').onclick=()=>{ localStorage.removeItem('session'); location.href='login.html'; };

    // Data helpers
    const fmt = n => (n||0).toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:2});
    const todayKey = new Date().toISOString().slice(0,10);
    const monthKey = new Date().toISOString().slice(0,7);
    const invoices = JSON.parse(localStorage.getItem('invoices')||'[]'); // {date, items:[{name, qty, price}], total}

    // Snap
    let todayTotal = 0, monthTotal = 0, byItem = {};
    invoices.forEach(inv=>{
      if((inv.date||'').startsWith(monthKey)) monthTotal += Number(inv.total||0);
      if(inv.date===todayKey){
        todayTotal += Number(inv.total||0);
        (inv.items||[]).forEach(it=>{
          byItem[it.name] = (byItem[it.name]||0) + (Number(it.qty||0)*Number(it.price||0));
        });
      }
    });
    const topItem = Object.entries(byItem).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'â€”';
    document.getElementById('todayAmt').textContent = fmt(todayTotal);
    document.getElementById('monthAmt').textContent = fmt(monthTotal);
    document.getElementById('topItem').textContent  = topItem;
    document.getElementById('phSnap').textContent   = `Today â‚¹${fmt(todayTotal)} â€¢ MTD â‚¹${fmt(monthTotal)} â€¢ Top: ${topItem}`;

    // Charts (simple placeholders if no data)
    const hours = Array.from({length:12}, (_,i)=> (i*2).toString().padStart(2,'0') + ':00');
    const hourData = Array.from({length:12}, ()=>0);
    invoices.filter(i=>i.date===todayKey).forEach(inv=>{
      const h = (inv.time||'00:00').slice(0,2);
      const idx = Math.floor(Number(h)/2);
      hourData[idx] += Number(inv.total||0);
    });

    new Chart(document.getElementById('lineChart'),{
      type:'line',
      data:{ labels:hours, datasets:[{ label:'Revenue (â‚¹)', data:hourData, tension:.35, fill:false }]},
      options:{ responsive:true, plugins:{ legend:{display:false} } }
    });

    const pieLabels = Object.keys(byItem).length? Object.keys(byItem):['No Sales'];
    const pieVals   = Object.keys(byItem).length? Object.values(byItem):[1];
    new Chart(document.getElementById('pieChart'),{
      type:'pie',
      data:{ labels:pieLabels, datasets:[{ data:pieVals }]},
      options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } }
    });

    // SW
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }
  </script>
</body>
</html>
