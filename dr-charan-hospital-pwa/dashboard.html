<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Doctor Dashboard â€“ Dr. Charan Hospital</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=15"/>
</head>
<body>
  <!-- Banner with bottom-left chips -->
  <header class="banner clean">
    <div class="floating-actions">
      <a class="chip" id="logoutBtn">Logout</a>
      <button class="chip" id="clearCacheBtn">Clear Cache</button>
    </div>
    <button id="themeToggle" class="chip floating-toggle">ðŸŒ™</button>
  </header>

  <main class="container n8">

    <!-- Big tiles -->
    <section class="card" style="padding:18px">
      <div class="tile-grid">
        <a class="tile analytics" id="tileAnalytics" href="analytics.html">
          <div class="title">Analytics</div>
          <div class="sub">KPIs & weekly sales</div>
        </a>

        <a class="tile pharma" id="tilePharma" href="pharmacy-report.html">
          <div class="title">Pharmacy</div>
          <div class="sub" id="pharmaMeta">Sales & invoices</div>
        </a>

        <a class="tile bookings" href="patient.html">
          <div class="title">Bookings</div>
          <div class="sub">Quick patient slots</div>
        </a>

        <a class="tile patients" href="portal.html">
          <div class="title">Patients</div>
          <div class="sub">Reminders & history</div>
        </a>

        <a class="tile staff" href="admin.html#hr">
          <div class="title">Staff</div>
          <div class="sub">Roster & status</div>
        </a>

        <a class="tile settings" href="settings.html">
          <div class="title">Settings</div>
          <div class="sub">PINs, Staff, Patients</div>
        </a>
      </div>
    </section>

    <!-- Sales Analytics snapshot -->
    <section class="card" style="margin-top:16px">
      <h3 style="margin:0 0 12px">Sales Analytics</h3>
      <div class="kpi-wrap">
        <div class="kpi">
          <span class="n" id="kToday">0.00</span>
          <span class="label">Today â‚¹</span>
        </div>
        <div class="kpi">
          <span class="n" id="kMonth">0.00</span>
          <span class="label">This Month â‚¹</span>
        </div>
        <div class="kpi">
          <span class="n" id="kTop">â€“</span>
          <span class="label">Top Item</span>
        </div>
      </div>
    </section>

  </main>

  <!-- Page logic -->
  <script type="module">
    import { requireRole, logout, totalsToday, totalsMonth, topItemName, currentUser } from './js/store.js?v=21';
    requireRole('doctor');

    // theme
    const tbtn=document.getElementById('themeToggle');
    if(localStorage.theme){ document.documentElement.dataset.theme=localStorage.theme; tbtn.textContent=localStorage.theme==='light'?'ðŸŒž':'ðŸŒ™'; }
    tbtn.onclick=()=>{ const cur=document.documentElement.dataset.theme||'light'; const next=cur==='light'?'dark':'light'; document.documentElement.dataset.theme=next; localStorage.theme=next; tbtn.textContent=next==='light'?'ðŸŒž':'ðŸŒ™'; };

    // logout
    document.getElementById('logoutBtn').onclick=()=>{ logout(); location.href='login.html'; };

    // clear cache
    document.getElementById('clearCacheBtn').onclick=async ()=>{
      try{
        localStorage.clear();
        if('caches' in window){ const ks=await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k))); }
        if('serviceWorker' in navigator){ const regs=await navigator.serviceWorker.getRegistrations(); for(const r of regs) await r.unregister(); }
        alert('Cache cleared. Reloadingâ€¦'); location.reload(true);
      }catch(e){ console.error(e); alert('Couldnâ€™t clear everything; try a hard reload.'); }
    };

    // doctor-only tiles already linked:
    // Analytics -> analytics.html
    // Pharmacy -> pharmacy-report.html

    // snapshot KPIs
    async function refreshKPIs(){
      const [td, tm, top] = await Promise.all([totalsToday(), totalsMonth(), topItemName()]);
      document.getElementById('kToday').textContent = Number(td||0).toFixed(2);
      document.getElementById('kMonth').textContent = Number(tm||0).toFixed(2);
      document.getElementById('kTop').textContent = top || 'â€“';

      // small meta on the Pharmacy tile
      const meta = `Today â‚¹${Number(td||0).toFixed(2)} â€¢ MTD â‚¹${Number(tm||0).toFixed(2)} â€¢ Top: ${top||'â€“'}`;
      const el = document.getElementById('pharmaMeta'); if (el) el.textContent = meta;
    }
    refreshKPIs();

    // Optional: safety role-aware redirect if someone lands here without doctor role
    const u = currentUser();
    if(u && u.role!=='doctor'){ location.href = u.role==='supervisor' ? 'admin.html' : 'portal.html'; }
  </script>

  <!-- PWA SW -->
  <script>
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }
  </script>
</body>
</html>
