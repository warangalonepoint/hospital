<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Doctor Dashboard â€“ Dr. Charan Hospital</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="assets/logo.png" />
  <link rel="stylesheet" href="styles.css?v=24" />
</head>
<body>
  <!-- Banner -->
  <header class="banner">
    <button id="themeToggle" class="chip floating-toggle" aria-label="Toggle theme">ðŸŒ™</button>
  </header>

  <!-- Sticky actions (NOT on the banner) -->
  <div class="fixed-actions">
    <button id="logoutBtn" class="chip">Logout</button>
    <button id="clearCacheBtn" class="chip">Clear Cache</button>
  </div>

  <!-- App tiles -->
  <section class="card-grid" style="max-width:1120px;margin:0 auto;">
    <a class="card" href="analytics.html">
      <h2>Analytics</h2>
      <p>KPIs & weekly sales</p>
    </a>

    <a class="card" href="pharmacy.html">
      <h2>Pharmacy</h2>
      <p id="pharmacySummary">Today â‚¹0.00 â€¢ MTD â‚¹0.00 â€¢ Top: â€”</p>
    </a>

    <a class="card" href="bookings.html">
      <h2>Bookings</h2>
      <p>Quick patient slots</p>
    </a>

    <a class="card" href="patient.html">
      <h2>Patients</h2>
      <p>Reminders & history</p>
    </a>

    <a class="card" href="staff.html">
      <h2>Staff</h2>
      <p>Roster & status</p>
    </a>

    <a class="card" href="settings.html">
      <h2>Settings</h2>
      <p>PINs, Staff, Patients</p>
    </a>
  </section>

  <!-- Sales Analytics -->
  <section style="max-width:1120px;margin:12px auto;padding:12px;">
    <div class="card" style="padding:18px;">
      <h2 style="text-align:left;margin-bottom:12px;font-size:18px;">Sales Analytics (Today)</h2>

      <div style="display:grid;grid-template-columns:1fr;gap:18px;">
        <div class="card" style="padding:16px;">
          <canvas id="todayLine" height="160"></canvas>
        </div>
        <div class="card" style="padding:16px;">
          <canvas id="todayPie" height="160"></canvas>
        </div>
      </div>

      <div class="card-grid" style="margin-top:14px;">
        <div class="card">
          <h2 id="kpiToday">0.00</h2><p>Today â‚¹</p>
        </div>
        <div class="card">
          <h2 id="kpiMonth">0.00</h2><p>This Month â‚¹</p>
        </div>
        <div class="card">
          <h2 id="kpiTopItem">â€”</h2><p>Top Item</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Local Chart.js for offline-first -->
  <script src="assets/chart.umd.min.js"></script>

  <script type="module">
    // -------- Session gate (doctor only) ----------
    const session = (() => {
      try { return JSON.parse(localStorage.getItem('session') || 'null'); }
      catch { return null; }
    })();

    if (!session) {
      location.replace('login.html'); // no session
    } else if (session.role !== 'doctor') {
      // Redirect non-doctor roles
      if (session.role === 'supervisor') location.replace('admin.html');
      else location.replace('portal.html');
    }

    // -------- Theme toggle ----------
    const themeBtn = document.getElementById('themeToggle');
    const applyTheme = (t) => {
      document.documentElement.dataset.theme = t;
      themeBtn.textContent = t === 'light' ? 'ðŸŒž' : 'ðŸŒ™';
      localStorage.theme = t;
    };
    applyTheme(localStorage.theme || 'light');
    themeBtn.addEventListener('click', () => {
      applyTheme((document.documentElement.dataset.theme || 'light') === 'light' ? 'dark' : 'light');
    });

    // -------- Logout / Clear Cache ----------
    document.getElementById('logoutBtn').onclick = () => {
      localStorage.removeItem('session');
      location.replace('login.html');
    };

    document.getElementById('clearCacheBtn').onclick = async () => {
      try {
        // keep session, only clear app data/caches
        const keepSession = localStorage.getItem('session');
        localStorage.clear();
        if (keepSession) localStorage.setItem('session', keepSession);

        if ('caches' in window) {
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
        }
        alert('Cache cleared. Reloadingâ€¦');
        location.reload(true);
      } catch(e) {
        alert('Could not fully clear cache. Try hard reload.');
      }
    };

    // -------- Mock data loader (replace later with Supabase/store.js) ----------
    // Expect localStorage.sales like:
    // { todayByHour:[n,n,...24], todayByItem:[{label, value}], todayTotal, monthTotal, topItem }
    const sales = (() => {
      try { return JSON.parse(localStorage.getItem('sales') || '{}'); } catch { return {}; }
    })();

    const byHour = Array.isArray(sales.todayByHour) ? sales.todayByHour : new Array(12).fill(0);
    const byItem = Array.isArray(sales.todayByItem) ? sales.todayByItem : [
      { label: 'Paracetamol', value: 0 },
      { label: 'Cough Syrup',  value: 0 },
      { label: 'Antibiotic',   value: 0 }
    ];
    const todayTotal = Number(sales.todayTotal || 0);
    const monthTotal = Number(sales.monthTotal || 0);
    const topItem = sales.topItem || (byItem.sort((a,b)=>b.value-a.value)[0]?.label ?? 'â€”');

    // Update summaries
    document.getElementById('pharmacySummary').textContent =
      `Today â‚¹${todayTotal.toFixed(2)} â€¢ MTD â‚¹${monthTotal.toFixed(2)} â€¢ Top: ${topItem}`;
    document.getElementById('kpiToday').textContent = todayTotal.toFixed(2);
    document.getElementById('kpiMonth').textContent = monthTotal.toFixed(2);
    document.getElementById('kpiTopItem').textContent = topItem;

    // -------- Charts ----------
    // Line chart: today by time buckets
    const lineCtx = document.getElementById('todayLine');
    new Chart(lineCtx, {
      type: 'line',
      data: {
        labels: byHour.map((_,i)=>`T${i+1}`),
        datasets: [{
          label: 'Sales (â‚¹)',
          data: byHour,
          tension: 0.35,
          fill: false
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, ticks: { callback:v=>'â‚¹'+v } }
        }
      }
    });

    // Pie chart: item share today
    const pieCtx = document.getElementById('todayPie');
    new Chart(pieCtx, {
      type: 'pie',
      data: {
        labels: byItem.map(i=>i.label),
        datasets: [{
          data: byItem.map(i=>i.value)
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'bottom' } }
      }
    });

    // -------- Service Worker (silent) ----------
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').catch(()=>{});
    }
  </script>
</body>
</html>
