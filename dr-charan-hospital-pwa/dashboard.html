<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Doctor Dashboard â€“ Dr. Charan Hospital</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=15"/>
  <style>
    .tile-grid{display:grid;gap:14px;grid-template-columns:1fr 1fr}
  </style>
</head>
<body>
  <header class="banner clean"></header>
  <div class="floating-actions">
    <a href="login.html" id="logout" class="chip">Logout</a>
    <button id="clearCacheBtn" class="chip">Clear Cache</button>
  </div>
  <button id="themeToggle" class="chip floating-toggle">ðŸŒ™</button>

  <main class="container n8">

    <!-- Tiles -->
    <section class="card" style="padding:18px">
      <div class="tile-grid">
        <a class="tile lilac" href="analytics.html">
          <div class="title">Analytics</div>
          <div class="sub">KPIs & weekly sales</div>
        </a>

        <a class="tile ice" href="pharmacy-report.html" id="pharmaTile">
          <div class="title">Pharmacy</div>
          <div class="sub" id="pharmaMeta">Today â‚¹0.00 â€¢ MTD â‚¹0.00 â€¢ Top: â€“</div>
        </a>

        <a class="tile mint" href="patient.html">
          <div class="title">Bookings</div>
          <div class="sub">Quick patient slots</div>
        </a>

        <a class="tile peach" href="portal.html">
          <div class="title">Patients</div>
          <div class="sub">Reminders & history</div>
        </a>

        <a class="tile mint" href="admin.html">
          <div class="title">Staff</div>
          <div class="sub">Roster & status</div>
        </a>

        <a class="tile lilac" href="settings.html">
          <div class="title">Settings</div>
          <div class="sub">PINs, Staff, Patients</div>
        </a>
      </div>
    </section>

    <!-- KPIs -->
    <section class="card" style="margin-top:16px;padding:18px">
      <h3 style="margin:0 0 8px">Sales Analytics</h3>
      <div class="kpis">
        <div class="kpi"><div class="n" id="kToday">0.00</div><div class="muted">Today â‚¹</div></div>
        <div class="kpi"><div class="n" id="kMonth">0.00</div><div class="muted">This Month â‚¹</div></div>
        <div class="kpi"><div class="n" id="kTop">â€“</div><div class="muted">Top Item</div></div>
      </div>

      <div class="chart-card">
        <canvas id="miniChart" height="170" style="width:100%"></canvas>
      </div>
    </section>

  </main>

  <script type="module">
    import { requireRole, totalsToday, totalsMonth, topItemName, listInvoices } from './js/store.js?v=21';
    const u=requireRole('doctor'); if(!u) return;

    // theme
    const tb=document.getElementById('themeToggle');
    if(localStorage.theme){ document.documentElement.dataset.theme=localStorage.theme; tb.textContent=localStorage.theme==='light'?'ðŸŒž':'ðŸŒ™'; }
    tb.onclick=()=>{ const cur=document.documentElement.dataset.theme||'light'; const next=cur==='light'?'dark':'light'; document.documentElement.dataset.theme=next; localStorage.theme=next; tb.textContent=next==='light'?'ðŸŒž':'ðŸŒ™'; };

    // clear cache
    document.getElementById('clearCacheBtn').onclick=async()=>{
      try{
        localStorage.clear();
        if('caches' in window){ const ks=await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k))); }
        if('serviceWorker' in navigator){ const regs=await navigator.serviceWorker.getRegistrations(); for(const r of regs) await r.unregister(); }
        alert('Cache cleared. Reloadingâ€¦'); location.reload(true);
      }catch(e){ alert('Could not fully clear. Try hard reload.'); }
    };

    // KPIs + tile meta
    async function refreshKPIs(){
      const t=await totalsToday();
      const m=await totalsMonth();
      const top=await topItemName();
      kToday.textContent=t.toFixed(2);
      kMonth.textContent=m.toFixed(2);
      kTop.textContent=top||'â€“';
      document.getElementById('pharmaMeta').textContent = `Today â‚¹${t.toFixed(2)} â€¢ MTD â‚¹${m.toFixed(2)} â€¢ Top: ${top||'â€“'}`;
      drawMini();
    }

    function drawMini(){
      const c=document.getElementById('miniChart'), ctx=c.getContext('2d');
      c.width=c.clientWidth*2; c.height=c.clientHeight*2; ctx.scale(2,2);
      const W=c.clientWidth, H=c.clientHeight, pad=24;
      ctx.clearRect(0,0,W,H);
      const border=getComputedStyle(document.documentElement).getPropertyValue('--border')||'#e9edf5';
      ctx.strokeStyle=border; ctx.beginPath(); ctx.moveTo(pad,H-pad); ctx.lineTo(W-pad,H-pad); ctx.stroke();

      // last 7 days totals
      const invs=listInvoices(); const today=new Date();
      const labels=[], data=[];
      for(let i=6;i>=0;i--){
        const d=new Date(today); d.setDate(today.getDate()-i);
        const key=d.toISOString().slice(0,10);
        labels.push(key.slice(5)); // MM-DD
        const sum=invs.filter(x=>x.date===key).reduce((s,r)=>s+(+r.total||0),0);
        data.push(sum);
      }

      const max=Math.max(10,...data);
      const slot=(W-pad*2)/labels.length, bw=slot*0.6, base=H-pad;
      const primary=getComputedStyle(document.documentElement).getPropertyValue('--primary')||'#5166ff';

      data.forEach((v,i)=>{
        const h=Math.round((v/max)*(H-pad*2));
        const x=pad+i*slot+(slot-bw)/2;
        ctx.fillStyle=primary;
        ctx.fillRect(x,base-h,bw,h);
      });

      ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--muted')||'#7b8';
      ctx.font='11px system-ui'; ctx.textAlign='center';
      labels.forEach((lb,i)=>{ const x=pad+i*slot+slot/2; ctx.fillText(lb,x,H-6); });
    }

    refreshKPIs();
    addEventListener('resize', drawMini);
  </script>

  <script>
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }
  </script>
</body>
</html>
