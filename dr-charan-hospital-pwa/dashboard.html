<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Doctor Dashboard â€“ Dr. Charan Hospital</title>

  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=26"/>

  <!-- Local Chart.js (offline-first) -->
  <script defer src="assets/chart.umd.min.js"></script>
  <!-- Data layer -->
  <script defer src="js/store.js"></script>
</head>
<body>
  <!-- Banner -->
  <header class="banner">
    <button id="themeToggle" class="chip floating-toggle" aria-label="Toggle theme">ðŸŒ™</button>
  </header>

  <!-- Sticky actions (NOT on the banner) -->
  <div class="fixed-actions">
    <button id="logoutBtn" class="chip">Logout</button>
    <button id="clearCacheBtn" class="chip">Clear Cache</button>
  </div>

  <!-- App tiles -->
  <section class="card-grid" style="max-width:1120px;margin:0 auto;">
    <a class="card card--lavender" href="analytics.html">
      <h2>Analytics</h2>
      <p>KPIs & weekly sales</p>
    </a>

    <a class="card card--blue" href="pharmacy-report.html">
      <h2>Pharmacy</h2>
      <p id="pharmacySummary">Today â‚¹0.00 â€¢ MTD â‚¹0.00 â€¢ Top: â€”</p>
    </a>

    <a class="card card--mint" href="bookings.html">
      <h2>Bookings</h2>
      <p>Quick patient slots</p>
    </a>

    <a class="card card--peach" href="patient.html">
      <h2>Patients</h2>
      <p>Reminders & history</p>
    </a>

    <a class="card card--mint" href="staff.html">
      <h2>Staff</h2>
      <p>Roster & status</p>
    </a>

    <a class="card card--vio" href="settings.html">
      <h2>Settings</h2>
      <p>PINs, Staff, Patients</p>
    </a>
  </section>

  <!-- Sales Analytics -->
  <section class="section">
    <div class="card" style="padding:18px;">
      <h2 style="text-align:left;margin-bottom:12px;font-size:18px;">Sales Analytics (Today)</h2>

      <div class="card-grid" style="grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;">
        <div class="card"><h2 id="kpiToday">0.00</h2><p>Today â‚¹</p></div>
        <div class="card"><h2 id="kpiMonth">0.00</h2><p>This Month â‚¹</p></div>
        <div class="card"><h2 id="kpiTopItem">â€”</h2><p>Top Item</p></div>
      </div>

      <div style="display:grid;grid-template-columns:1fr;gap:18px;margin-top:14px;">
        <div class="card" style="padding:16px;">
          <h3 style="margin-bottom:6px;font-size:15px;">Today by Hour</h3>
          <canvas id="todayLine" height="160"></canvas>
        </div>
        <div class="card" style="padding:16px;">
          <h3 style="margin-bottom:6px;font-size:15px;">Today by Item</h3>
          <canvas id="todayPie" height="160"></canvas>
        </div>
      </div>
    </div>
  </section>

  <script type="module">
    // -------- Session gate (doctor only) ----------
    const session = (() => { try { return JSON.parse(localStorage.getItem('session')||'null'); } catch { return null; } })();
    if (!session) location.replace('login.html');
    if (session.role !== 'doctor') {
      if (session.role === 'supervisor') location.replace('admin.html');
      else location.replace('login.html');
    }

    // -------- Theme ----------
    const themeBtn = document.getElementById('themeToggle');
    const applyTheme = (t) => { document.documentElement.dataset.theme = t; themeBtn.textContent = t==='light'?'ðŸŒž':'ðŸŒ™'; localStorage.theme=t; };
    applyTheme(localStorage.theme || 'light');
    themeBtn.addEventListener('click', ()=> applyTheme((document.documentElement.dataset.theme||'light')==='light'?'dark':'light'));

    // -------- Logout / Clear Cache ----------
    document.getElementById('logoutBtn').onclick = () => { localStorage.removeItem('session'); location.replace('login.html'); };
    document.getElementById('clearCacheBtn').onclick = async () => {
      try{
        const keep = localStorage.getItem('session');
        localStorage.clear(); if(keep) localStorage.setItem('session', keep);
        if('caches' in window){ const ks=await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k))); }
        alert('Cache cleared. Reloadingâ€¦'); location.reload(true);
      }catch{}
    };

    // -------- Charts helpers ----------
    let lineChart, pieChart;
    const tickColor = () => (document.documentElement.dataset.theme||'light')==='light' ? '#0f172a' : '#e6edf7';

    function drawLine(labels, values){
      lineChart?.destroy();
      const ctx = document.getElementById('todayLine').getContext('2d');
      lineChart = new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[{ data: values, tension:.35, borderWidth:2, fill:false }] },
        options:{
          responsive:true,
          plugins:{ legend:{ display:false }},
          scales:{ x:{ ticks:{ color: tickColor() } }, y:{ ticks:{ color: tickColor(), callback:v=>'â‚¹'+v } } }
        }
      });
    }

    function drawPie(labels, values){
      pieChart?.destroy();
      const ctx = document.getElementById('todayPie').getContext('2d');
      pieChart = new Chart(ctx, {
        type:'pie',
        data:{ labels: labels.length?labels:['No sales'], datasets:[{ data: values.length?values:[1], borderWidth:0 }] },
        options:{ responsive:true, plugins:{ legend:{ position:'bottom', labels:{ color: tickColor() } } } }
      });
    }

    // -------- Render from Store --------
    async function renderFromStore(){
      try{
        // Ensure Store is ready (in case script is still loading)
        if (!window.Store || !Store.getTodayBreakdown) {
          setTimeout(renderFromStore, 40);
          return;
        }
        const s = await Store.getTodayBreakdown();

        // KPIs
        document.getElementById('kpiToday').textContent = (s.todayTotal||0).toFixed(2);
        document.getElementById('kpiMonth').textContent = (s.monthTotal||0).toFixed(2);
        document.getElementById('kpiTopItem').textContent = s.topItem || 'â€”';
        document.getElementById('pharmacySummary').textContent =
          `Today â‚¹${(s.todayTotal||0).toFixed(2)} â€¢ MTD â‚¹${(s.monthTotal||0).toFixed(2)} â€¢ Top: ${s.topItem||'â€”'}`;

        // Line: 24 buckets (â‚¹ per hour)
        const labels = Array.from({length:24}, (_,h)=> (h<10?'0':'')+h+':00');
        const values = (s.todayByHour || new Array(24).fill(0)).slice(0,24);
        drawLine(labels, values);

        // Pie: item amounts today
        const pieLabels = (s.todayByItem||[]).map(x=>x.label);
        const pieValues = (s.todayByItem||[]).map(x=>x.value);
        drawPie(pieLabels, pieValues);
      } catch (e) {
        // Fallback to zeros if something goes off
        drawLine(['00:00','06:00','12:00','18:00','24:00'], [0,0,0,0,0]);
        drawPie(['No sales'], [1]);
      }
    }

    // Repaint charts after theme change
    const observer = new MutationObserver(()=> renderFromStore());
    observer.observe(document.documentElement, { attributes:true, attributeFilter:['data-theme'] });

    // Kick off once Chart + Store are ready
    if (window.Chart) renderFromStore();
    else document.addEventListener('DOMContentLoaded', ()=>{
      const iv=setInterval(()=>{ if(window.Chart){ clearInterval(iv); renderFromStore(); }}, 30);
    });

    // SW register (quiet)
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }
  </script>
</body>
</html>
