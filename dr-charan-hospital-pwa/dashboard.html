<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Doctor Dashboard â€“ Dr. Charan Hospital</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=27"/>
</head>
<body>
  <!-- Banner -->
  <header class="banner">
    <button id="themeToggle" class="floating-toggle" aria-label="Theme">ðŸŒ™</button>
  </header>

  <!-- Fixed actions -->
  <div class="fixed-actions">
    <button class="chip" id="logoutBtn">Logout</button>
    <button class="chip" id="clearCacheBtn">Clear Cache</button>
  </div>

  <!-- Main app cards -->
  <section class="section">
    <div class="card-grid">
      <a href="analytics.html" class="card panel--lilac">
        <h3>Analytics</h3>
        <p>KPIs & weekly sales</p>
      </a>

      <a href="pharmacy-report.html" class="card panel--blue">
        <h3>Pharmacy</h3>
        <p id="pharmacySummary">Today â‚¹0.00 â€¢ MTD â‚¹0.00 â€¢ Top: â€”</p>
      </a>

      <!-- Bookings âžœ Booking Status -->
      <a href="bookings-status.html" class="card panel--mint">
        <h3>Booking Status</h3>
        <p>Today / Week / Month counts</p>
      </a>

      <a href="patients.html" class="card panel--rose">
        <h3>Patients</h3>
        <p>Reminders & history</p>
      </a>

      <a href="staff.html" class="card panel--peach">
        <h3>Staff</h3>
        <p>Roster & status</p>
      </a>

      <a href="settings.html" class="card panel--lilac">
        <h3>Settings</h3>
        <p>PINs, Staff, Patients</p>
      </a>
    </div>
  </section>

  <!-- Sales analytics snapshot -->
  <section class="section">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <h2>Sales Analytics (Today)</h2>
      <div class="chips range">
        <button class="chip chip--blue"  data-range="today">Today</button>
        <button class="chip chip--mint"  data-range="7d">7D</button>
        <button class="chip chip--peach" data-range="30d">30D</button>
        <button class="chip chip--lilac" data-range="ytd">YTD</button>
      </div>
    </div>

    <div class="kpi-grid mt12">
      <div class="kpi panel--blue">
        <h4>Total (â‚¹)</h4>
        <div class="num" id="kpiTotal">0.00</div>
      </div>
      <div class="kpi panel--lilac">
        <h4>Avg / Day (â‚¹)</h4>
        <div class="num" id="kpiAvg">0.00</div>
      </div>
      <div class="kpi panel--mint">
        <h4>Invoices</h4>
        <div class="num" id="kpiInv">0</div>
      </div>
      <div class="kpi panel--rose">
        <h4>Top Item</h4>
        <div class="num" id="kpiTop">â€“</div>
      </div>
    </div>

    <div class="chart-wrap">
      <div class="chart-title">Revenue by Day</div>
      <canvas id="lineChart" height="160"></canvas>
    </div>
    <div class="chart-wrap">
      <div class="chart-title">Top Items (Share)</div>
      <canvas id="pieChart" height="160"></canvas>
    </div>
  </section>

  <!-- Local Chart.js -->
  <script src="assets/chart.umd.min.js"></script>
  <script>
    // --- Theme toggle
    const t = document.getElementById('themeToggle');
    if (localStorage.theme) {
      document.documentElement.dataset.theme = localStorage.theme;
      t.textContent = localStorage.theme === 'light' ? 'ðŸŒž' : 'ðŸŒ™';
    }
    t.onclick = () => {
      const cur = document.documentElement.dataset.theme || 'light';
      const next = cur === 'light' ? 'dark' : 'light';
      document.documentElement.dataset.theme = next;
      localStorage.theme = next;
      t.textContent = next === 'light' ? 'ðŸŒž' : 'ðŸŒ™';
    };

    // --- Session guard
    (() => {
      const s = JSON.parse(localStorage.getItem('session') || 'null');
      if (!s || s.role !== 'doctor') location.replace('login.html');
    })();

    // --- Actions
    document.getElementById('logoutBtn').onclick = () => {
      localStorage.removeItem('session');
      location.href = 'login.html';
    };
    document.getElementById('clearCacheBtn').onclick = async () => {
      try {
        const keep = localStorage.getItem('session');
        localStorage.clear();
        if (keep) localStorage.setItem('session', keep);
        if ('caches' in window) {
          const ks = await caches.keys();
          await Promise.all(ks.map(k => caches.delete(k)));
        }
        alert('Cache cleared.');
        location.reload();
      } catch(e){ alert('Could not clear all caches.'); }
    };

    // --- Data helpers
    function getInvoices() {
      try { return JSON.parse(localStorage.getItem('invoices') || '[]'); }
      catch { return []; }
    }
    function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
    function isSameDay(a,b){ return startOfDay(a).getTime()===startOfDay(b).getTime(); }
    function money(n){ return (Number(n)||0).toFixed(2); }

    function summarize(range='today'){
      const inv = getInvoices();
      const now = new Date();
      let from;
      if (range==='today') from = startOfDay(now);
      else if (range==='7d') { from = new Date(now); from.setDate(now.getDate()-6); from = startOfDay(from); }
      else if (range==='30d'){ from = new Date(now); from.setDate(now.getDate()-29); from = startOfDay(from); }
      else if (range==='ytd'){ from = new Date(now.getFullYear(),0,1); }
      else from = startOfDay(now);

      const picked = inv.filter(i=>{
        const t = new Date(i.date||i.createdAt||Date.now());
        return t>=from && t<=now;
      });

      const total = picked.reduce((s,i)=> s + (Number(i.total)||0), 0);
      const days = Math.max(1, Math.round( (startOfDay(now)-from)/86400000 ) + 1);
      const avg = total / days;
      const count = picked.length;

      const itemMap = {};
      picked.forEach(i=>{
        (i.items||[]).forEach(it=>{
          const key = (it.name||'Item').trim();
          const amt = (Number(it.qty)||0) * (Number(it.price)||0);
          itemMap[key] = (itemMap[key]||0)+amt;
        });
      });
      const top = Object.entries(itemMap).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'â€”';

      const byDay = {};
      for(let i=0;i<days;i++){
        const d = new Date(from); d.setDate(from.getDate()+i);
        const key = d.toISOString().slice(0,10);
        byDay[key] = 0;
      }
      picked.forEach(i=>{
        const d = new Date(i.date||i.createdAt||Date.now());
        const key = d.toISOString().slice(0,10);
        if (byDay[key] != null) byDay[key] += Number(i.total)||0;
      });

      return { total, avg, count, top, lineLabels:Object.keys(byDay), lineData:Object.values(byDay), pieData:itemMap };
    }

    function paintSummary(range='today'){
      const s = summarize(range);
      // KPIs
      document.getElementById('kpiTotal').textContent = money(s.total);
      document.getElementById('kpiAvg').textContent = money(s.avg);
      document.getElementById('kpiInv').textContent = s.count;
      document.getElementById('kpiTop').textContent = s.top;

      // Pharmacy snippet
      const inv = getInvoices();
      const today = inv.filter(i=>isSameDay(new Date(i.date||i.createdAt||Date.now()), new Date())).reduce((a,i)=>a+(+i.total||0),0);
      const mStart = new Date(); mStart.setDate(1); mStart.setHours(0,0,0,0);
      const mtd = inv.filter(i=> new Date(i.date||i.createdAt||Date.now())>=mStart).reduce((a,i)=>a+(+i.total||0),0);
      const top = s.top || 'â€”';
      document.getElementById('pharmacySummary').textContent = `Today â‚¹${money(today)} â€¢ MTD â‚¹${money(mtd)} â€¢ Top: ${top}`;

      // Charts
      line.data.labels = s.lineLabels;
      line.data.datasets[0].data = s.lineData;
      line.update();

      const pieLabels = Object.keys(s.pieData);
      const pieVals = Object.values(s.pieData);
      pie.data.labels = pieLabels.length? pieLabels: ['No data'];
      pie.data.datasets[0].data = pieVals.length? pieVals: [1];
      pie.update();
    }

    // Charts init
    const line = new Chart(document.getElementById('lineChart'), {
      type: 'line',
      data: { labels: [], datasets: [{ label:'Revenue', data: [], borderWidth:2, tension:.3 }] },
      options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
    });
    const pie = new Chart(document.getElementById('pieChart'), {
      type: 'pie',
      data: { labels: [], datasets: [{ data: [] }] },
      options: { responsive:true, maintainAspectRatio:false }
    });

    // Range chips
    const rangeBar = document.querySelector('.range');
    function setActive(name){
      rangeBar.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      const el = rangeBar.querySelector(`[data-range="${name}"]`);
      if (el) el.classList.add('active');
      paintSummary(name);
    }
    rangeBar.addEventListener('click', (e)=>{
      const btn = e.target.closest('.chip'); if (!btn) return;
      setActive(btn.dataset.range);
    });
    setActive('today');

    // SW
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }
  </script>
</body>
</html>
