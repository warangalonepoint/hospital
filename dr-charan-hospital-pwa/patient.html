<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Patients ‚Äì Doctor</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=22"/>
</head>
<body>
  <!-- Banner -->
  <header class="banner">
    <button id="themeToggle" class="chip floating-toggle" aria-label="Theme">üåô</button>
  </header>

  <!-- Top actions -->
  <div class="fixed-actions">
    <button class="chip" onclick="location.href='dashboard.html'">‚Üê Dashboard</button>
    <button class="chip" id="logoutBtn">Logout</button>
    <button class="chip" id="clearCacheBtn">Clear Cache</button>
  </div>

  <!-- Upcoming (from supervisor tokens) -->
  <section class="section section--peach">
    <div class="section__head">
      <h2>Upcoming Patients</h2>
      <div class="pill-group">
        <button class="pill pill--on" data-filter="today">Today</button>
        <button class="pill" data-filter="all">All</button>
        <input id="searchTxt" class="input" placeholder="Search name/phone" style="max-width:220px;margin-left:8px">
      </div>
    </div>

    <div class="card section__body">
      <table class="table" id="upTable">
        <thead>
          <tr><th>#</th><th>Name</th><th>Phone</th><th>Date</th><th>Time</th><th>Notes</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Served & notes -->
  <section class="section section--mint">
    <div class="section__head"><h2>Served Patients & Notes</h2></div>
    <div class="card section__body">
      <table class="table" id="servedTable">
        <thead>
          <tr><th>#</th><th>Name</th><th>Phone</th><th>Visit</th><th>Notes</th><th>Next Visit</th><th>Save</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

<script type="module">
  // Theme
  const t=document.getElementById('themeToggle');
  if(localStorage.theme){ document.documentElement.dataset.theme=localStorage.theme; t.textContent=localStorage.theme==='light'?'üåû':'üåô'; }
  t.onclick=()=>{ const cur=document.documentElement.dataset.theme||'light'; const next=cur==='light'?'dark':'light'; document.documentElement.dataset.theme=next; localStorage.theme=next; t.textContent=next==='light'?'üåû':'üåô'; };

  // Guard
  try{
    const s = JSON.parse(localStorage.getItem('session')||'{}');
    if(s.role!=='doctor'){ location.href='login.html'; }
  }catch{ location.href='login.html'; }

  // Buttons
  document.getElementById('clearCacheBtn').onclick=async()=>{
    localStorage.clear();
    if('caches' in window){ const ks=await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k))); }
    if('serviceWorker' in navigator){ const regs=await navigator.serviceWorker.getRegistrations(); for(const r of regs) await r.unregister(); }
    alert('Cache cleared'); location.reload();
  };
  document.getElementById('logoutBtn').onclick=()=>{ localStorage.removeItem('session'); location.href='login.html'; };

  // Data stores
  const getBookings = ()=> JSON.parse(localStorage.getItem('bookings')||'[]');
  const setBookings = v => localStorage.setItem('bookings', JSON.stringify(v));
  const getServed   = ()=> JSON.parse(localStorage.getItem('servedPatients')||'[]');
  const setServed   = v => localStorage.setItem('servedPatients', JSON.stringify(v));

  const todayStr = new Date().toISOString().slice(0,10);
  let curFilter = 'today', search = '';

  // Render upcoming
  function renderUpcoming(){
    let list = getBookings().filter(b=>!b.served);
    if(curFilter==='today') list = list.filter(b=>b.date===todayStr);
    if(search) list = list.filter(b=> (b.name+b.phone+b.note).toLowerCase().includes(search));
    list.sort((a,b)=> (a.date+a.time).localeCompare(b.date+b.time));

    const body = document.querySelector('#upTable tbody');
    body.innerHTML='';
    list.forEach((b,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${b.name}</td>
        <td>${b.phone}</td>
        <td>${b.date}</td>
        <td>${b.time}</td>
        <td>${b.note||''}</td>
        <td><button class="chip" data-serve="${b.id}">Mark Served</button></td>`;
      body.appendChild(tr);
    });
  }

  // Render served
  function renderServed(){
    const list = getServed().sort((a,b)=> b.servedAt - a.servedAt);
    const body = document.querySelector('#servedTable tbody');
    body.innerHTML='';
    list.forEach((p,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${p.name}</td>
        <td>${p.phone}</td>
        <td>${p.date} ${p.time}</td>
        <td><input class="input" value="${p.treatment||''}" data-note="${p.id}" placeholder="Treatment / Medicines / Notes"></td>
        <td><input class="input" type="date" value="${p.nextVisit||''}" data-next="${p.id}"></td>
        <td><button class="btn" data-save="${p.id}">Save</button></td>`;
      body.appendChild(tr);
    });
  }

  // Actions
  document.addEventListener('click', (e)=>{
    const id = e.target.dataset.serve;
    if(id){
      const list = getBookings();
      const idx = list.findIndex(x=>x.id===id);
      if(idx>-1){
        const b = list[idx];
        b.served = true;
        setBookings(list);
        const served = getServed();
        served.push({ id:b.id, name:b.name, phone:b.phone, date:b.date, time:b.time, note:b.note||'', treatment:'', nextVisit:'', servedAt:Date.now() });
        setServed(served);
        renderUpcoming(); renderServed();
      }
    }
    const saveId = e.target.dataset.save;
    if(saveId){
      const served = getServed();
      const s = served.find(x=>x.id===saveId);
      if(s){
        s.treatment = document.querySelector(`input[data-note="${saveId}"]`).value.trim();
        s.nextVisit  = document.querySelector(`input[data-next="${saveId}"]`).value;
        setServed(served);
        alert('Saved');
      }
    }
  });

  document.querySelectorAll('.pill-group .pill[data-filter]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.pill-group .pill').forEach(b=>b.classList.remove('pill--on'));
      btn.classList.add('pill--on');
      curFilter = btn.dataset.filter;
      renderUpcoming();
    });
  });
  document.getElementById('searchTxt').addEventListener('input', (e)=>{ search = e.target.value.trim().toLowerCase(); renderUpcoming(); });

  // Initial render
  renderUpcoming();
  renderServed();

  // SW
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }
</script>
</body>
</html>
