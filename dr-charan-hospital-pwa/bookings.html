<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bookings ‚Äì Supervisor</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=22"/>
</head>
<body>
  <!-- Banner -->
  <header class="banner">
    <button id="themeToggle" class="chip floating-toggle" aria-label="Theme">üåô</button>
  </header>

  <!-- Top actions -->
  <div class="fixed-actions">
    <button class="chip" onclick="location.href='admin.html'">‚Üê Supervisor</button>
    <button class="chip" onclick="location.href='dashboard.html'">Doctor</button>
    <button class="chip" id="logoutBtn">Logout</button>
    <button class="chip" id="clearCacheBtn">Clear Cache</button>
  </div>

  <!-- Create Booking -->
  <section class="section section--blue">
    <div class="section__head">
      <h2>Create Booking (Token)</h2>
    </div>

    <div class="card section__body">
      <form id="bookingForm" class="form-grid">
        <label>Patient Name
          <input id="bkName" class="input" placeholder="Full name" required>
        </label>
        <label>Phone
          <input id="bkPhone" class="input" placeholder="10-digit" minlength="10" maxlength="10" inputmode="numeric" required>
        </label>

        <label>Visit Date
          <input id="bkDate" class="input" type="date" required>
        </label>
        <label>Time
          <input id="bkTime" class="input" type="time" required>
        </label>

        <label class="col-span-2">Reason / Notes
          <input id="bkNote" class="input" placeholder="Reason or short note">
        </label>

        <div class="row">
          <button class="btn" type="submit">Create Token</button>
          <button class="chip" type="button" id="waShare">Share via WhatsApp</button>
        </div>
        <p class="muted" style="margin-top:8px">Supervisor creates tokens. Doctor sees them in Patients/Bookings views.</p>
      </form>
    </div>
  </section>

  <!-- Upcoming list -->
  <section class="section section--purple">
    <div class="section__head">
      <h2>Upcoming Tokens</h2>
      <div class="pill-group">
        <button class="pill pill--on" data-filter="today">Today</button>
        <button class="pill" data-filter="all">All</button>
        <button class="pill pill--danger" id="clearList">Clear List</button>
      </div>
    </div>

    <div class="card section__body">
      <table class="table" id="tokensTable">
        <thead>
          <tr><th>#</th><th>Name</th><th>Phone</th><th>Date</th><th>Time</th><th>Notes</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

<script type="module">
  // --- Theme toggle
  const t = document.getElementById('themeToggle');
  if(localStorage.theme){ document.documentElement.dataset.theme = localStorage.theme; t.textContent = localStorage.theme==='light'?'üåû':'üåô'; }
  t.onclick=()=>{ const cur=document.documentElement.dataset.theme||'light'; const next=cur==='light'?'dark':'light'; document.documentElement.dataset.theme=next; localStorage.theme=next; t.textContent = next==='light'?'üåû':'üåô'; };

  // --- Guard: supervisor only
  try{
    const s = JSON.parse(localStorage.getItem('session')||'{}');
    if(s.role!=='supervisor'){ location.href='login.html'; }
  }catch{ location.href='login.html'; }

  // --- Clear cache + logout
  document.getElementById('clearCacheBtn').onclick = async ()=>{
    localStorage.clear();
    if('caches' in window){ const ks=await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k))); }
    if('serviceWorker' in navigator){ const regs=await navigator.serviceWorker.getRegistrations(); for(const r of regs) await r.unregister(); }
    alert('Cache cleared'); location.reload();
  };
  document.getElementById('logoutBtn').onclick=()=>{ localStorage.removeItem('session'); location.href='login.html'; };

  // --- Helpers
  const fmtDate = d=> new Date(d).toISOString().slice(0,10);
  const todayStr = fmtDate(new Date());

  const getBookings = ()=> JSON.parse(localStorage.getItem('bookings')||'[]');
  const setBookings = (list)=> localStorage.setItem('bookings', JSON.stringify(list));

  // --- Defaults
  const d = new Date();
  document.getElementById('bkDate').value = fmtDate(d);
  document.getElementById('bkTime').value = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

  // --- Create booking
  const form = document.getElementById('bookingForm');
  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    const rec = {
      id: 'bk_'+Date.now(),
      name: bkName.value.trim(),
      phone: bkPhone.value.trim(),
      date: bkDate.value,
      time: bkTime.value,
      note: bkNote.value.trim(),
      createdAt: Date.now(),
      served: false
    };
    const list = getBookings();
    list.push(rec);
    setBookings(list);
    render();
    form.reset();
    bkDate.value = todayStr;
    alert('Token created');
  });

  // WhatsApp share (last token)
  document.getElementById('waShare').onclick=()=>{
    const list = getBookings();
    if(!list.length){ alert('Create a token first'); return; }
    const b = list[list.length-1];
    const msg = `Dr. Charan Hospital Token%nName: ${b.name}%nWhen: ${b.date} ${b.time}%nNote: ${b.note||'-'}`;
    const u = 'https://wa.me/?text='+encodeURIComponent(msg.replace(/%n/g,"\n"));
    window.open(u,'_blank');
  };

  // --- Table render with filters
  let curFilter = 'today';
  document.querySelectorAll('.pill-group .pill[data-filter]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.pill-group .pill').forEach(b=>b.classList.remove('pill--on'));
      btn.classList.add('pill--on');
      curFilter = btn.dataset.filter;
      render();
    });
  });

  document.getElementById('clearList').onclick=()=>{
    if(confirm('Clear all tokens?')){ setBookings([]); render(); }
  };

  function render(){
    const body = document.querySelector('#tokensTable tbody');
    body.innerHTML = '';
    let list = getBookings().sort((a,b)=> (a.date+a.time).localeCompare(b.date+b.time));
    if(curFilter==='today'){ list = list.filter(b=>b.date===todayStr); }
    list.forEach((b,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${b.name}</td><td>${b.phone}</td><td>${b.date}</td><td>${b.time}</td><td>${b.note||''}</td>`;
      body.appendChild(tr);
    });
  }
  render();

  // SW register silently
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }
</script>
</body>
</html>
