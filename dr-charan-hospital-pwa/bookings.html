<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bookings ‚Äì Dr. Charan Hospital</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=26"/>
</head>
<body>
  <!-- Banner -->
  <header class="banner">
    <button id="themeToggle" class="chip floating-toggle" aria-label="Theme">üåô</button>
  </header>

  <!-- Fixed actions -->
  <div class="fixed-actions">
    <a class="chip" href="admin.html">‚Üê Supervisor</a>
    <a class="chip" href="dashboard.html">Doctor</a>
    <button id="logoutBtn" class="chip">Logout</button>
    <button id="clearCacheBtn" class="chip">Clear Cache</button>
  </div>

  <main class="section" style="max-width:1100px">
    <!-- Create booking -->
    <section class="card">
      <h2 style="font-size:18px;margin-bottom:8px">Create Booking (Token)</h2>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px">
        <div>
          <label class="muted">Patient Name</label>
          <input id="bName" class="input" placeholder="Full name"/>
        </div>
        <div>
          <label class="muted">Phone</label>
          <input id="bPhone" class="input" inputmode="numeric" maxlength="10" placeholder="10-digit"/>
        </div>
        <div>
          <label class="muted">Visit Date</label>
          <input id="bDate" class="input" type="date"/>
        </div>
        <div>
          <label class="muted">Time</label>
          <input id="bTime" class="input" type="time"/>
        </div>
        <div style="grid-column:1/-1">
          <label class="muted">Reason / Notes</label>
          <input id="bReason" class="input" placeholder="Reason or short note"/>
        </div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <button id="createBtn" class="btn">Create Token</button>
        <button id="waBtn" class="chip" disabled>Share via WhatsApp</button>
      </div>
      <p class="help" style="margin-top:8px">Supervisor creates tokens. Doctor sees them on Patients/Bookings views.</p>
    </section>

    <!-- Today queue -->
    <section class="card">
      <h2 style="font-size:18px;margin-bottom:8px">Today‚Äôs Queue</h2>
      <table class="table" id="todayTable">
        <thead>
          <tr>
            <th>Token</th><th>Patient</th><th>Phone</th><th>Time</th><th>Status</th><th style="width:180px">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- All bookings (recent) -->
    <section class="card">
      <h2 style="font-size:18px;margin-bottom:8px">Recent Bookings</h2>
      <table class="table" id="allTable">
        <thead>
          <tr>
            <th>Date</th><th>Token</th><th>Patient</th><th>Phone</th><th>Time</th><th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script type="module">
    /* ---------- Role gate: supervisor creates; doctor can view ---------- */
    const sess = JSON.parse(localStorage.getItem('session')||'null');
    if(!sess || !sess.role) location.replace('login.html');
    const isSupervisor = sess.role === 'supervisor';
    // Doctor can view this page read-only; others -> login
    if(!['supervisor','doctor'].includes(sess.role)) location.replace('login.html');

    /* ---------- Theme ---------- */
    const t = document.getElementById('themeToggle');
    const setTheme = m => { document.documentElement.dataset.theme = m; localStorage.theme = m; t.textContent = m==='light'?'üåû':'üåô'; };
    setTheme(localStorage.theme || 'light');
    t.onclick = () => setTheme((document.documentElement.dataset.theme||'light')==='light'?'dark':'light');

    /* ---------- Logout / Clear ---------- */
    document.getElementById('logoutBtn').onclick = () => { localStorage.removeItem('session'); location.replace('login.html'); };
    document.getElementById('clearCacheBtn').onclick = async () => {
      try{ const s=localStorage.getItem('session'); localStorage.clear(); if(s) localStorage.setItem('session',s);
        if('caches'in window){const ks=await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k)));} alert('Cache cleared. Reloading‚Ä¶'); location.reload(true);
      }catch{}

    };

    /* ---------- Storage helpers ---------- */
    const LS_KEY = 'bookings';
    const read = () => { try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ return []; } };
    const write = (arr) => localStorage.setItem(LS_KEY, JSON.stringify(arr));

    function todayStr(d=new Date()){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10); }

    /* ---------- Token generator (per day) ---------- */
    function nextToken(forDate){
      const all = read().filter(b => (b.date===forDate));
      const max = all.reduce((m,b)=> Math.max(m, b.token||0), 0);
      return max + 1;
    }

    /* ---------- Create booking ---------- */
    const el = id => document.getElementById(id);
    const bName=el('bName'), bPhone=el('bPhone'), bDate=el('bDate'), bTime=el('bTime'), bReason=el('bReason');
    const waBtn = el('waBtn');

    // defaults
    bDate.value = todayStr();
    bTime.value = new Date().toTimeString().slice(0,5);

    el('createBtn').onclick = () => {
      if(!isSupervisor){ alert('Only supervisor can create tokens'); return; }
      const date = bDate.value || todayStr();
      const token = nextToken(date);
      const obj = {
        id: `BK-${Date.now()}`,
        date,
        time: bTime.value || '00:00',
        token,
        name: (bName.value||'').trim(),
        phone: (bPhone.value||'').trim(),
        reason: (bReason.value||'').trim(),
        status: 'Pending', // Pending | Checked-in | Completed | Cancelled
        createdAt: new Date().toISOString()
      };
      const arr = read(); arr.push(obj); write(arr);
      // enable WA share
      waBtn.disabled = false;
      waBtn.dataset.payload = JSON.stringify(obj);
      render();
    };

    // WhatsApp share (prefilled)
    waBtn.onclick = () => {
      const payload = JSON.parse(waBtn.dataset.payload || 'null');
      if(!payload){ return; }
      const msg =
`Hello ${payload.name || ''},
Your appointment is booked at Dr. Charan Hospital.
Date: ${payload.date}
Time: ${payload.time}
Token: ${payload.token}
Please arrive 10 minutes early.`;
      const num = (bPhone.value||'').trim();
      const url = `https://wa.me/${num ? '91'+num : ''}?text=${encodeURIComponent(msg)}`;
      window.open(url, '_blank');
    };

    /* ---------- Render tables ---------- */
    function setActions(row, booking){
      const makeBtn = (label)=>{ const x=document.createElement('button'); x.className='chip'; x.textContent=label; return x; };
      const cell = row.querySelector('td.actions');
      cell.innerHTML = '';
      // Supervisor controls
      if(isSupervisor){
        const s1 = makeBtn('Check-in');
        const s2 = makeBtn('Complete');
        const s3 = makeBtn('Cancel');
        s1.onclick = ()=>updateStatus(booking.id,'Checked-in');
        s2.onclick = ()=>updateStatus(booking.id,'Completed');
        s3.onclick = ()=>updateStatus(booking.id,'Cancelled');
        cell.append(s1,s2,s3);
      } else {
        cell.textContent = '‚Äî';
      }
    }

    function updateStatus(id, status){
      const arr = read();
      const i = arr.findIndex(b=>b.id===id);
      if(i>=0){ arr[i].status=status; write(arr); render(); }
    }

    function render(){
      const all = read().sort((a,b)=> (a.date<b.date?1:-1) || (a.time>b.time?1:-1));
      const today = todayStr();

      // today table
      const tBody = document.querySelector('#todayTable tbody');
      tBody.innerHTML='';
      all.filter(b=>b.date===today).sort((a,b)=> (a.token||0)-(b.token||0)).forEach(b=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${b.token}</td>
          <td>${b.name||''}</td>
          <td>${b.phone||''}</td>
          <td>${b.time||''}</td>
          <td>${b.status}</td>
          <td class="actions" style="display:flex;gap:6px"></td>`;
        tBody.appendChild(tr);
        setActions(tr,b);
      });

      // recent table
      const aBody = document.querySelector('#allTable tbody');
      aBody.innerHTML='';
      all.slice(0,25).forEach(b=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${b.date}</td><td>${b.token}</td><td>${b.name||''}</td><td>${b.phone||''}</td><td>${b.time||''}</td><td>${b.status}</td>`;
        aBody.appendChild(tr);
      });
    }

    render();

    // SW register
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }
  </script>
</body>
</html>
