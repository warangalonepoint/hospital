<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bookings / Tokens</title>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=22"/>
</head>
<body>
  <!-- Banner -->
  <header class="banner">
    <button id="themeToggle" class="floating-toggle" aria-label="Theme">üåô</button>
  </header>

  <!-- Fixed Actions -->
  <div class="fixed-actions">
    <a class="chip" href="admin.html">‚Üê Supervisor</a>
    <a class="chip" href="dashboard.html">Doctor</a>
    <button class="chip" id="logoutBtn">Logout</button>
    <button class="chip" id="clearCacheBtn">Clear Cache</button>
  </div>

  <!-- Create Booking -->
  <section class="section">
    <h2>Create Booking (Token)</h2>

    <div class="kpi panel--blue mt12">
      <label class="muted">Patient Name</label>
      <input id="bName" class="input" placeholder="Full name"/>
      <label class="muted">Phone</label>
      <input id="bPhone" class="input" placeholder="10-digit" inputmode="numeric" maxlength="10"/>
      <label class="muted">Visit Date</label>
      <input id="bDate" class="input" type="date"/>
      <label class="muted">Time</label>
      <input id="bTime" class="input" type="time"/>
      <label class="muted">Reason / Notes</label>
      <input id="bNote" class="input" placeholder="Reason or short note"/>

      <div class="chips mt12">
        <button class="btn" id="createBtn">Create Token</button>
        <button class="chip chip--mint" id="waBtn">Share via WhatsApp</button>
      </div>
      <p class="muted mt8">Supervisor creates tokens. Doctor sees them on Patients/Bookings views.</p>
    </div>
  </section>

  <!-- Today / Upcoming list -->
  <section class="section">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <h2>Upcoming Tokens</h2>
      <div class="chips">
        <button class="chip chip--blue" id="filterToday">Today</button>
        <button class="chip chip--lilac" id="filterAll">All</button>
        <button class="chip chip--peach" id="clearList">Clear List</button>
      </div>
    </div>

    <table class="table mt12" id="tbl">
      <thead>
        <tr><th>#</th><th>Name</th><th>Phone</th><th>Date</th><th>Time</th><th>Notes</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <script>
    // Theme
    const t=document.getElementById('themeToggle');
    if(localStorage.theme){document.documentElement.dataset.theme=localStorage.theme;t.textContent=localStorage.theme==='light'?'üåû':'üåô'}
    t.onclick=()=>{const cur=document.documentElement.dataset.theme||'light';const next=cur==='light'?'dark':'light';document.documentElement.dataset.theme=next;localStorage.theme=next;t.textContent=next==='light'?'üåû':'üåô'}

    // Guard (supervisor can create; doctor can view)
    (()=>{
      const s=JSON.parse(localStorage.getItem('session')||'null');
      if(!s || !['supervisor','doctor'].includes(s.role)) location.replace('login.html');
    })();

    // Actions
    logoutBtn.onclick=()=>{localStorage.removeItem('session');location.href='login.html'}
    clearCacheBtn.onclick=async()=>{try{const keep=localStorage.getItem('session');localStorage.clear();if(keep)localStorage.setItem('session',keep); if('caches'in window){const ks=await caches.keys();await Promise.all(ks.map(k=>caches.delete(k)))} alert('Cache cleared.');location.reload()}catch{}}

    // Data helpers
    function bookings(){try{return JSON.parse(localStorage.getItem('bookings')||'[]')}catch{return []}}
    function saveBookings(arr){localStorage.setItem('bookings',JSON.stringify(arr))}
    function pad(n){return n<10?'0'+n:n}

    // Defaults (date/time)
    const now=new Date();
    bDate.value = now.toISOString().slice(0,10);
    bTime.value = pad(now.getHours())+':'+pad(now.getMinutes());

    // Create token
    createBtn.onclick=()=>{
      const name=bName.value.trim();
      const phone=bPhone.value.trim();
      const date=bDate.value;
      const time=bTime.value;
      const note=bNote.value.trim();

      if(!name || !date || !time) return alert('Name, date and time are required.');
      const list=bookings();
      const token={id:Date.now(), name, phone, date, time, note, createdAt:new Date().toISOString(), status:'booked'};
      list.push(token); saveBookings(list);
      render(); alert('Token created.');
      bName.value=''; bPhone.value=''; bNote.value='';
    };

    // Share via WhatsApp
    waBtn.onclick=()=>{
      const name=bName.value.trim()||'Patient';
      const d=bDate.value; const tt=bTime.value;
      const txt=`Hello ${name}, your appointment is booked for ${d} at ${tt} at Dr. Charan Hospital.`;
      const url='https://wa.me/?text='+encodeURIComponent(txt);
      window.open(url,'_blank');
    };

    // Render table
    function render(mode='today'){
      const tbody=document.querySelector('#tbl tbody'); tbody.innerHTML='';
      let list=bookings();
      if(mode==='today'){
        const today=new Date().toISOString().slice(0,10);
        list=list.filter(x=>x.date===today);
      }
      list.sort((a,b)=> (a.date+a.time).localeCompare(b.date+b.time) );
      list.forEach((x,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${i+1}</td><td>${x.name}</td><td>${x.phone||''}</td><td>${x.date}</td><td>${x.time}</td><td>${x.note||''}</td>`;
        tbody.appendChild(tr);
      });
    }
    filterToday.onclick=()=>render('today');
    filterAll.onclick=()=>render('all');
    clearList.onclick=()=>{
      if(confirm('Clear all stored tokens on this device?')){ saveBookings([]); render(); }
    };
    render();
  </script>
</body>
</html>
