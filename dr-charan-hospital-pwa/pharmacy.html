<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Pharmacy Billing ‚Äì Dr. Charan Hospital</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=26"/>
</head>
<body>
  <!-- Banner -->
  <header class="banner">
    <button id="themeToggle" class="chip floating-toggle" aria-label="Theme">üåô</button>
  </header>

  <!-- Fixed actions -->
  <div class="fixed-actions">
    <a class="chip" href="dashboard.html">‚Üê Dashboard</a>
    <a class="chip" href="pharmacy-report.html">üìä Reports</a>
    <button class="chip" id="logoutBtn">Logout</button>
    <button class="chip" id="clearCacheBtn">Clear Cache</button>
  </div>

  <main class="section" style="max-width:1100px">
    <!-- Header + meta -->
    <div class="card" style="display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
      <div>
        <label class="muted">Invoice #</label>
        <input id="invNo" class="input" placeholder="e.g., INV-001"/>
      </div>
      <div>
        <label class="muted">Date</label>
        <input id="invDate" class="input" type="date"/>
      </div>
      <div>
        <label class="muted">Doctor (optional)</label>
        <input id="doctorName" class="input" placeholder="Dr. Name"/>
      </div>
      <div>
        <label class="muted">Patient Name</label>
        <input id="patientName" class="input" placeholder="Full name"/>
      </div>
      <div>
        <label class="muted">Patient Phone</label>
        <input id="patientPhone" class="input" inputmode="numeric" maxlength="10" placeholder="10-digit"/>
      </div>
    </div>

    <!-- Items table -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h2 style="font-size:18px">Items</h2>
        <div style="display:flex;gap:8px">
          <button class="chip" id="addRowBtn">Ôºã Add Item</button>
          <button class="chip" id="clearRowsBtn">üóë Clear</button>
        </div>
      </div>

      <table class="table" id="itemsTable">
        <thead>
          <tr>
            <th style="width:26%">Item</th>
            <th style="width:12%">Batch</th>
            <th style="width:12%">Expiry</th>
            <th style="width:10%">Qty</th>
            <th style="width:12%">Price ‚Çπ</th>
            <th style="width:12%">Amount ‚Çπ</th>
            <th style="width:8%"></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="muted" style="margin-top:8px">Tip: quantity √ó price is computed automatically.</p>
    </div>

    <!-- Totals -->
    <div class="card" style="display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
      <div>
        <label class="muted">Discount %</label>
        <input id="discPct" class="input" inputmode="decimal" placeholder="0"/>
      </div>
      <div>
        <label class="muted">Discount ‚Çπ</label>
        <input id="discAmt" class="input" inputmode="decimal" placeholder="0"/>
      </div>
      <div>
        <label class="muted">Paid ‚Çπ</label>
        <input id="paidAmt" class="input" inputmode="decimal" placeholder="0"/>
      </div>
      <div>
        <label class="muted">Total ‚Çπ</label>
        <input id="totalAmt" class="input" readonly/>
      </div>
      <div>
        <label class="muted">Balance ‚Çπ</label>
        <input id="balanceAmt" class="input" readonly/>
      </div>
    </div>

    <!-- Actions -->
    <div class="card" style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
      <button class="chip" id="newInvBtn">New Invoice</button>
      <button class="chip" id="saveDraftBtn">Save Draft</button>
      <button class="btn"  id="finalizeBtn">Finalize & Save</button>
    </div>

    <!-- Recent invoices -->
    <div class="card">
      <h2 style="font-size:18px;margin-bottom:8px">Recent Invoices</h2>
      <table class="table" id="recentTable">
        <thead><tr><th>Date</th><th>#</th><th>Patient</th><th>Lines</th><th>Total ‚Çπ</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <script>
  /******** Theme toggle ********/
  const t = document.getElementById('themeToggle');
  const setIcon = () => t.textContent = (document.documentElement.dataset.theme||'light')==='light' ? 'üåû' : 'üåô';
  if(localStorage.theme){ document.documentElement.dataset.theme = localStorage.theme; }
  setIcon();
  t.onclick = () => {
    const cur = document.documentElement.dataset.theme || 'light';
    const next = cur === 'light' ? 'dark' : 'light';
    document.documentElement.dataset.theme = next;
    localStorage.theme = next;
    setIcon();
  };

  /******** Session guard: supervisor only ********/
  const session = JSON.parse(localStorage.getItem('session')||'{}');
  if(session.role !== 'supervisor'){ location.replace('login.html'); }

  /******** Logout + Clear cache ********/
  document.getElementById('logoutBtn').onclick = () => {
    localStorage.removeItem('session'); location.href='login.html';
  };
  document.getElementById('clearCacheBtn').onclick = async () => {
    try{
      const keepSession = localStorage.getItem('session');
      localStorage.clear();
      if(keepSession) localStorage.setItem('session', keepSession);
      if('caches' in window){ const ks=await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k))); }
      if('serviceWorker' in navigator){ const regs=await navigator.serviceWorker.getRegistrations(); for(const r of regs) await r.unregister(); }
      alert('Cache cleared. Reloading‚Ä¶'); location.reload(true);
    }catch(e){ alert('Could not fully clear. Try hard reload.'); }
  };

  /******** Utilities ********/
  const q = sel => document.querySelector(sel);
  const tb = q('#itemsTable tbody');
  const money = n => (Number(n||0)).toFixed(2);

  function lineTemplate() {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="input itemName" placeholder="e.g., Paracetamol 650"/></td>
      <td><input class="input itemBatch" placeholder="Batch"/></td>
      <td><input class="input itemExp" type="month"/></td>
      <td><input class="input itemQty" inputmode="decimal" value="1"/></td>
      <td><input class="input itemPrice" inputmode="decimal" value="0"/></td>
      <td><input class="input itemAmt" readonly/></td>
      <td><button class="chip delRow">‚úñ</button></td>
    `;
    return tr;
  }

  function recalcRow(tr){
    const qty = Number(tr.querySelector('.itemQty').value||0);
    const price = Number(tr.querySelector('.itemPrice').value||0);
    tr.querySelector('.itemAmt').value = money(qty*price);
    recalcTotals();
  }

  function recalcTotals(){
    // sum lines
    let sub = 0;
    tb.querySelectorAll('.itemAmt').forEach(i => sub += Number(i.value||0));
    const pct = Number(q('#discPct').value||0);
    const flat = Number(q('#discAmt').value||0);
    const disc = (sub*(pct/100)) + flat;
    const total = Math.max(0, sub - disc);
    const paid = Number(q('#paidAmt').value||0);
    const bal = Math.max(0, total - paid);
    q('#totalAmt').value = money(total);
    q('#balanceAmt').value = money(bal);
  }

  function addRow(prefill){
    const tr = lineTemplate();
    tb.appendChild(tr);
    if(prefill){
      tr.querySelector('.itemName').value = prefill.name||'';
      tr.querySelector('.itemBatch').value = prefill.batch||'';
      tr.querySelector('.itemExp').value = (prefill.expiry||'').slice(0,7);
      tr.querySelector('.itemQty').value = prefill.qty||1;
      tr.querySelector('.itemPrice').value = prefill.price||0;
    }
    // wire
    tr.querySelectorAll('.itemQty,.itemPrice').forEach(inp=>inp.addEventListener('input',()=>recalcRow(tr)));
    tr.querySelector('.delRow').addEventListener('click',()=>{ tr.remove(); recalcTotals(); });
    recalcRow(tr);
  }

  function clearRows(){ tb.innerHTML=''; recalcTotals(); }

  /******** Buttons ********/
  q('#addRowBtn').addEventListener('click', ()=> addRow());
  q('#clearRowsBtn').addEventListener('click', clearRows);
  q('#newInvBtn').addEventListener('click', ()=>{
    q('#invNo').value = '';
    q('#doctorName').value = '';
    q('#patientName').value = '';
    q('#patientPhone').value = '';
    q('#discPct').value = '';
    q('#discAmt').value = '';
    q('#paidAmt').value = '';
    clearRows();
    addRow();
    setToday();
  });

  q('#discPct').addEventListener('input', recalcTotals);
  q('#discAmt').addEventListener('input', recalcTotals);
  q('#paidAmt').addEventListener('input', recalcTotals);

  /******** Save & Finalize ********/
  function collectInvoice(status){
    const items = Array.from(tb.querySelectorAll('tr')).map(tr=>({
      name: tr.querySelector('.itemName').value.trim(),
      batch: tr.querySelector('.itemBatch').value.trim(),
      expiry: tr.querySelector('.itemExp').value,
      qty: Number(tr.querySelector('.itemQty').value||0),
      price: Number(tr.querySelector('.itemPrice').value||0),
      amount: Number(tr.querySelector('.itemAmt').value||0)
    })).filter(x=>x.name);

    const obj = {
      id: (q('#invNo').value||'').trim() || `INV-${Date.now()}`,
      dateISO: q('#invDate').value ? new Date(q('#invDate').value).toISOString() : new Date().toISOString(),
      doctor: (q('#doctorName').value||'').trim(),
      patient: (q('#patientName').value||'').trim(),
      phone: (q('#patientPhone').value||'').trim(),
      items,
      discountPct: Number(q('#discPct').value||0),
      discountAmt: Number(q('#discAmt').value||0),
      paid: Number(q('#paidAmt').value||0),
      total: Number(q('#totalAmt').value||0),
      balance: Number(q('#balanceAmt').value||0),
      status // 'draft' | 'final'
    };
    return obj;
  }

  function saveLocal(inv){
    const arr = JSON.parse(localStorage.getItem('invoices')||'[]');
    // replace if same id
    const idx = arr.findIndex(x=>x.id===inv.id);
    if(idx>=0) arr[idx]=inv; else arr.push(inv);
    localStorage.setItem('invoices', JSON.stringify(arr));
  }

  async function persist(inv){
    saveLocal(inv);
    if(window.Store && Store.saveInvoice){
      try{ await Store.saveInvoice(inv); }catch(e){ /* ignore offline */ }
    }
  }

  q('#saveDraftBtn').addEventListener('click', async ()=>{
    const inv = collectInvoice('draft');
    await persist(inv);
    alert('Draft saved.');
    loadRecent();
  });

  q('#finalizeBtn').addEventListener('click', async ()=>{
    if(tb.children.length===0){ alert('Add at least one item.'); return; }
    const inv = collectInvoice('final');
    await persist(inv);
    alert('Invoice saved.');
    // reset for next
    q('#newInvBtn').click();
    loadRecent();
  });

  /******** Recent table ********/
  function loadRecent(){
    const tbody = q('#recentTable tbody');
    tbody.innerHTML='';
    const arr = JSON.parse(localStorage.getItem('invoices')||'[]')
      .sort((a,b)=>new Date(b.dateISO||b.date)-new Date(a.dateISO||a.date))
      .slice(0,10);
    for(const inv of arr){
      const tr = document.createElement('tr');
      const iso = inv.dateISO || inv.date || new Date().toISOString();
      tr.innerHTML = `
        <td>${new Date(iso).toLocaleDateString()}</td>
        <td>${inv.id}</td>
        <td>${inv.patient||''}</td>
        <td>${(inv.items||[]).length}</td>
        <td>${money(inv.total||0)}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  function setToday(){
    const d = new Date();
    q('#invDate').value = d.toISOString().slice(0,10);
  }

  /******** Init ********/
  setToday();
  addRow(); // start with one row
  loadRecent();

  // Register SW quietly
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }
  </script>
</body>
</html>
