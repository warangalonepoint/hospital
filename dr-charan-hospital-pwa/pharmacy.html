<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Pharmacy ‚Äì Billing</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=21"/>
  <style>
    /* Page-scoped color fills for sections (safe even if styles.css lacks them) */
    .tint { border-radius: 16px; padding: 16px; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,.06); }
    .tint-blue    { background: color-mix(in srgb, #3b82f6 12%, var(--card-bg)); }
    .tint-purple  { background: color-mix(in srgb, #8b5cf6 12%, var(--card-bg)); }
    .tint-green   { background: color-mix(in srgb, #22c55e 12%, var(--card-bg)); }
    .tint-peach   { background: color-mix(in srgb, #fb923c 12%, var(--card-bg)); }
    .section { margin: 12px; }
    .section h2 { font-size: 18px; margin-bottom: 10px; }
    .grid-2 { display:grid; gap:10px; grid-template-columns: 1fr; }
    @media (min-width: 720px){ .grid-2 { grid-template-columns: 1fr 1fr; } }
    .field { display:grid; gap:6px; }
    .label { font-size: 12px; color: var(--muted); }
    .input, select { width:100%; height:44px; border-radius:12px; border:1px solid rgba(0,0,0,.12); padding:0 12px; background: var(--card-bg); }
    .input:focus, select:focus { outline:none; border-color: var(--accent); box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 20%, transparent); }
    .toolbar { display:flex; flex-wrap:wrap; gap:10px; margin: 10px 12px; }
    .btn { height:44px; padding:0 16px; border-radius:12px; }
    .chip { height:40px; padding:0 14px; border-radius:999px; }
    .items-head { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .table { width:100%; border-collapse: collapse; background: var(--card-bg); border-radius:12px; overflow:hidden; }
    .table th, .table td { padding:10px; border-bottom:1px solid rgba(0,0,0,.06); font-size:13px; }
    .table th { text-align:left; background:rgba(0,0,0,.04); font-weight:600; }
    html[data-theme="dark"] .table th { background: rgba(255,255,255,.06); }
    .totals { display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); }
    .pill { display:inline-flex; align-items:center; gap:8px; height:40px; padding:0 14px; border-radius:999px; background: var(--card-bg); border:1px solid rgba(0,0,0,.06); }
  </style>
</head>
<body>
  <!-- Banner -->
  <header class="banner">
    <button id="themeToggle" class="chip floating-toggle" aria-label="Theme">üåô</button>
  </header>

  <!-- Toolbar -->
  <nav class="toolbar">
    <a class="chip" href="admin.html">‚Üê Dashboard</a>
    <a class="chip" href="pharmacy-report.html">üìä Reports</a>
    <button id="logoutBtn" class="chip">Logout</button>
    <button id="clearCacheBtn" class="chip">Clear Cache</button>
  </nav>

  <!-- Invoice Meta -->
  <section class="section tint tint-blue">
    <h2>Invoice Details</h2>
    <div class="grid-2">
      <div class="field">
        <label class="label" for="invoiceNo">Invoice #</label>
        <input id="invoiceNo" class="input" placeholder="e.g., INV-001"/>
      </div>
      <div class="field">
        <label class="label" for="invoiceDate">Date</label>
        <input id="invoiceDate" class="input" type="date"/>
      </div>
      <div class="field">
        <label class="label" for="doctorName">Doctor (optional)</label>
        <input id="doctorName" class="input" placeholder="Dr. Name"/>
      </div>
      <div class="field">
        <label class="label" for="paymentMode">Payment Mode</label>
        <select id="paymentMode">
          <option>Cash</option>
          <option>UPI</option>
          <option>Card</option>
          <option>Split</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Patient -->
  <section class="section tint tint-purple">
    <h2>Patient</h2>
    <div class="grid-2">
      <div class="field">
        <label class="label" for="patientName">Patient Name</label>
        <input id="patientName" class="input" placeholder="Full name"/>
      </div>
      <div class="field">
        <label class="label" for="patientPhone">Patient Phone</label>
        <input id="patientPhone" class="input" inputmode="numeric" placeholder="10-digit"/>
      </div>
    </div>
  </section>

  <!-- Items -->
  <section class="section tint tint-green">
    <div class="items-head">
      <h2>Items</h2>
      <div style="display:flex; gap:10px;">
        <button id="addItemBtn" class="btn">Ôºã Add Item</button>
        <button id="clearItemsBtn" class="chip">üóëÔ∏è Clear</button>
      </div>
    </div>

    <table class="table" id="itemsTable">
      <thead>
        <tr>
          <th style="width:28%">Item</th>
          <th>Batch</th>
          <th>Expiry</th>
          <th>Qty</th>
          <th>MRP</th>
          <th>Price</th>
          <th>Line Total</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="itemsBody">
        <!-- rows injected by JS -->
      </tbody>
    </table>
  </section>

  <!-- Totals -->
  <section class="section tint tint-peach">
    <h2>Summary</h2>
    <div class="totals">
      <div class="field">
        <label class="label" for="discountPct">Invoice Discount %</label>
        <input id="discountPct" class="input" type="number" step="0.01" value="0"/>
      </div>
      <div class="field">
        <label class="label" for="discountAmt">Invoice Discount ‚Çπ</label>
        <input id="discountAmt" class="input" type="number" step="0.01" value="0"/>
      </div>
      <div class="field">
        <label class="label" for="totalAmt">Total ‚Çπ</label>
        <input id="totalAmt" class="input" type="number" step="0.01" value="0" readonly/>
      </div>
      <div class="field">
        <label class="label" for="paidAmt">Paid ‚Çπ</label>
        <input id="paidAmt" class="input" type="number" step="0.01" value="0"/>
      </div>
      <div class="field">
        <label class="label" for="balanceAmt">Balance ‚Çπ</label>
        <input id="balanceAmt" class="input" type="number" step="0.01" value="0" readonly/>
      </div>
    </div>

    <div style="display:flex; gap:10px; margin-top:14px; flex-wrap:wrap;">
      <button id="saveDraftBtn" class="chip">üíæ Save Draft</button>
      <button id="finalizeBtn" class="btn">Finalize & Save</button>
      <button id="printBtn" class="chip">üñ®Ô∏è Print</button>
      <button id="whatsBtn" class="chip">‚Üó Share</button>
    </div>
  </section>

  <script type="module">
    // Theme toggle
    const t=document.getElementById('themeToggle');
    if(localStorage.theme){ document.documentElement.dataset.theme=localStorage.theme; t.textContent=localStorage.theme==='light'?'üåû':'üåô'; }
    t.onclick=()=>{ const cur=document.documentElement.dataset.theme||'light'; const next=cur==='light'?'dark':'light'; document.documentElement.dataset.theme=next; localStorage.theme=next; t.textContent=next==='light'?'üåû':'üåô'; };

    // Session guard: supervisor only for billing v1
    const sess = JSON.parse(localStorage.getItem('session')||'{}');
    if(sess.role!=='supervisor'){ location.replace('login.html'); }

    // Buttons
    document.getElementById('logoutBtn').onclick=()=>{ localStorage.removeItem('session'); location.href='login.html'; };
    document.getElementById('clearCacheBtn').onclick=async()=>{
      localStorage.clear(); sessionStorage.clear();
      if('caches' in window){ const ks = await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k))); }
      alert('Cleared. Reloading‚Ä¶'); location.reload();
    };

    // ===== Items table logic (minimal; keep IDs for your existing store.js) =====
    const body = document.getElementById('itemsBody');
    const addRow = (line={item:'',batch:'',expiry:'',qty:1,mrp:0,price:0})=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><input class="input" placeholder="Paracetamol 650" value="${line.item}"></td>
        <td><input class="input" placeholder="Batch" value="${line.batch}"></td>
        <td><input class="input" type="month" value="${line.expiry}"></td>
        <td><input class="input qty" type="number" min="1" value="${line.qty}"></td>
        <td><input class="input mrp" type="number" step="0.01" value="${line.mrp}"></td>
        <td><input class="input price" type="number" step="0.01" value="${line.price}"></td>
        <td class="lineTotal">0.00</td>
        <td><button class="chip remove">‚úñ</button></td>`;
      body.appendChild(tr);
      wireRow(tr);
      recalc();
    };
    const wireRow = (tr)=>{
      tr.querySelectorAll('.qty,.mrp,.price,input').forEach(el=>el.addEventListener('input', recalc));
      tr.querySelector('.remove').onclick=()=>{ tr.remove(); recalc(); };
    };
    const recalc = ()=>{
      let total=0;
      body.querySelectorAll('tr').forEach(tr=>{
        const qty=+tr.querySelector('.qty').value||0;
        const price=+tr.querySelector('.price').value||0;
        const line=qty*price;
        tr.querySelector('.lineTotal').textContent=line.toFixed(2);
        total+=line;
      });
      // discounts
      const pct=+document.getElementById('discountPct').value||0;
      const amt=+document.getElementById('discountAmt').value||0;
      let discounted=total - (total*(pct/100)) - amt;
      if(discounted<0) discounted=0;
      document.getElementById('totalAmt').value = discounted.toFixed(2);
      const paid=+document.getElementById('paidAmt').value||0;
      document.getElementById('balanceAmt').value = Math.max(0, discounted-paid).toFixed(2);
    };
    document.getElementById('addItemBtn').onclick=()=>addRow();
    document.getElementById('clearItemsBtn').onclick=()=>{ body.innerHTML=''; recalc(); };
    ['discountPct','discountAmt','paidAmt'].forEach(id=>{
      document.getElementById(id).addEventListener('input', recalc);
    });

    // Seed one line for convenience
    addRow();

    // Save / Finalize (stub hooks ‚Äî wire to Supabase later)
    document.getElementById('saveDraftBtn').onclick=()=>alert('Draft saved (placeholder).');
    document.getElementById('finalizeBtn').onclick=()=>alert('Invoice saved (placeholder).');
    document.getElementById('printBtn').onclick=()=>window.print();
    document.getElementById('whatsBtn').onclick=()=>alert('Share link copied (placeholder).');

    // Set default date today
    document.getElementById('invoiceDate').value = new Date().toISOString().slice(0,10);

    // SW register
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }
  </script>
</body>
</html>
