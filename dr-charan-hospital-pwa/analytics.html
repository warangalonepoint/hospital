<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sales Analytics ‚Äì Dr. Charan Hospital</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=30"/>
  <style>
    /* keep UI consistent; compact analytics */
    .container { max-width: 1100px; margin: 0 auto; padding: 12px; }
    .charts-grid { display:grid; grid-template-columns: 1fr; gap:16px; }
    @media (min-width: 900px){ .charts-grid { grid-template-columns: 1fr 1fr; } }
    .chart-wrap { height: 320px; }
    .toolbar { display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:space-between; }
    .chips { display:flex; gap:8px; flex-wrap:wrap; }
    .filters { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .filters input[type="date"]{ padding:8px 10px; border-radius:10px; border:1px solid rgba(0,0,0,.1); }
    .filters .chip { cursor:pointer; }
    .kpi-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:12px; margin-top:12px; }
    .kpi { padding:12px; border-radius:14px; text-align:center; }
    .kpi h4{ font-size:.9rem; margin:0 0 6px; }
    .kpi .num{ font-size:1.2rem; font-weight:700; }
  </style>
</head>
<body>
  <!-- Banner -->
  <header class="banner">
    <button id="themeToggle" class="floating-toggle" aria-label="Theme">üåô</button>
  </header>

  <!-- Fixed actions -->
  <div class="fixed-actions">
    <a href="dashboard.html" class="chip">‚Üê Dashboard</a>
    <button class="chip" id="logoutBtn">Logout</button>
    <button class="chip" id="clearCacheBtn">Clear Cache</button>
  </div>

  <main class="container section card">
    <div class="toolbar">
      <h2 style="margin:0">Sales Analytics</h2>
      <div class="chips">
        <button class="chip chip--blue"  data-range="today">Today</button>
        <button class="chip chip--mint"  data-range="7d">7D</button>
        <button class="chip chip--peach" data-range="30d">30D</button>
        <button class="chip chip--lilac" data-range="ytd">YTD</button>
      </div>
    </div>

    <!-- Custom date / single date -->
    <div class="filters mt12">
      <label>From <input id="fromDate" type="date"></label>
      <label>To <input id="toDate" type="date"></label>
      <button id="applyRange" class="chip chip--blue">Apply</button>
      <button id="singleToday" class="chip">Set Today</button>
      <small id="periodLabel" style="opacity:.75;margin-left:auto"></small>
    </div>

    <div class="kpi-grid mt12">
      <div class="kpi panel--blue">
        <h4>Total (‚Çπ)</h4>
        <div class="num" id="kpiTotal">0.00</div>
      </div>
      <div class="kpi panel--lilac">
        <h4>Avg / Day (‚Çπ)</h4>
        <div class="num" id="kpiAvg">0.00</div>
      </div>
      <div class="kpi panel--mint">
        <h4>Invoices</h4>
        <div class="num" id="kpiInv">0</div>
      </div>
      <div class="kpi panel--rose">
        <h4>Top Item</h4>
        <div class="num" id="kpiTop">‚Äì</div>
      </div>
    </div>

    <div class="charts-grid mt12">
      <div class="chart-wrap panel--sky card">
        <div class="chart-title">Revenue by Day <span id="rangeSpan" style="float:right;opacity:.7"></span></div>
        <canvas id="lineChart"></canvas>
      </div>
      <div class="chart-wrap panel--lilac card">
        <div class="chart-title">Top Items (Share) <span id="pieSpan" style="float:right;opacity:.7"></span></div>
        <canvas id="pieChart"></canvas>
      </div>
    </div>
  </main>

  <script src="assets/chart.umd.min.js"></script>
  <script>
    // === Theme ===
    const t=document.getElementById('themeToggle');
    if(localStorage.theme){ document.documentElement.dataset.theme=localStorage.theme; t.textContent=localStorage.theme==='light'?'üåû':'üåô'; }
    t.onclick=()=>{ const cur=document.documentElement.dataset.theme||'light'; const next=cur==='light'?'dark':'light'; document.documentElement.dataset.theme=next; localStorage.theme=next; t.textContent=next==='light'?'üåû':'üåô'; };

    // === Guard ===
    (()=>{ const s=JSON.parse(localStorage.getItem('session')||'null'); if(!s||s.role!=='doctor') location.replace('login.html'); })();

    // === Actions ===
    logoutBtn.onclick=()=>{ localStorage.removeItem('session'); location.href='login.html'; };
    clearCacheBtn.onclick=async()=>{ const keep=localStorage.getItem('session'); localStorage.clear(); if(keep) localStorage.setItem('session',keep); if('caches' in window){const ks=await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k)));} alert('Cache cleared.'); location.reload(); };

    // === Data access (Pharmacy first) ===
    function getPharmacyRecords(){
      const keys=['pharmacyRecords','pharmacyInvoices','invoices'];
      for(const k of keys){
        try{ const arr=JSON.parse(localStorage.getItem(k)||'[]'); if(Array.isArray(arr) && arr.length) return arr; }catch{}
      }
      try{ return JSON.parse(localStorage.getItem('pharmacyRecords')||'[]'); }catch{ return []; }
    }
    function getDate(obj){
      return new Date(obj.date || obj.dateISO || obj.createdAt || obj.slotISO || Date.now());
    }
    const money=n=>(Number(n)||0).toFixed(2);
    const isoDate=d=>new Date(d).toISOString().slice(0,10);

    // === Summarize between from..to (inclusive) ===
    function summarizeRange(from, to){
      const data=getPharmacyRecords();
      const picked=data.filter(r=>{
        const d=getDate(r);
        return d>=from && d<=to;
      });

      const total=picked.reduce((s,r)=>s+(+r.total||0),0);
      const days=Math.max(1, Math.round((new Date(isoDate(to)) - new Date(isoDate(from)))/86400000)+1);
      const avg=total/days;

      // items
      const items={};
      picked.forEach(r=>{
        (r.items||[]).forEach(it=>{
          const name=it.name||'Item';
          const amt=(+it.qty||0)*(+it.price||0);
          items[name]=(items[name]||0)+amt;
        });
      });
      const top=Object.entries(items).sort((a,b)=>b[1]-a[1])[0]?.[0]||'‚Äî';

      // by day
      const byDay={};
      for(let d=new Date(isoDate(from)); d<=to; d.setDate(d.getDate()+1)){
        byDay[isoDate(d)]=0;
      }
      picked.forEach(r=>{
        const k=isoDate(getDate(r));
        if(byDay[k]!=null) byDay[k]+=+r.total||0;
      });

      return { total, avg, count:picked.length, top, lineLabels:Object.keys(byDay), lineData:Object.values(byDay), pieData:items };
    }

    // === Charts ===
    const line=new Chart(document.getElementById('lineChart'),{
      type:'line',
      data:{labels:[],datasets:[{label:'Revenue',data:[],borderWidth:2,tension:.3}]},
      options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}
    });
    const pie=new Chart(document.getElementById('pieChart'),{
      type:'pie',
      data:{labels:[],datasets:[{data:[]}]},
      options:{responsive:true,maintainAspectRatio:false}
    });

    function apply(from, to, label){
      const s=summarizeRange(from, to);
      document.getElementById('kpiTotal').textContent=money(s.total);
      document.getElementById('kpiAvg').textContent=money(s.avg);
      document.getElementById('kpiInv').textContent=s.count;
      document.getElementById('kpiTop').textContent=s.top;

      line.data.labels=s.lineLabels; line.data.datasets[0].data=s.lineData; line.update();
      const labels=Object.keys(s.pieData), vals=Object.values(s.pieData);
      pie.data.labels=labels.length?labels:['No data']; pie.data.datasets[0].data=vals.length?vals:[1]; pie.update();

      const span = `${isoDate(from)} ‚Üí ${isoDate(to)}`;
      document.getElementById('rangeSpan').textContent=span;
      document.getElementById('pieSpan').textContent=label||'';
      document.getElementById('periodLabel').textContent=label?`${label}: ${span}`:span;
    }

    // === Quick ranges ===
    const rangeBar=document.querySelectorAll('[data-range]');
    rangeBar.forEach(btn=>btn.addEventListener('click',()=>{
      rangeBar.forEach(x=>x.classList.remove('active')); btn.classList.add('active');
      const now=new Date(); const today=new Date(isoDate(now));
      let from=today;
      if(btn.dataset.range==='7d'){ from=new Date(today); from.setDate(from.getDate()-6); }
      else if(btn.dataset.range==='30d'){ from=new Date(today); from.setDate(from.getDate()-29); }
      else if(btn.dataset.range==='ytd'){ from=new Date(today.getFullYear(),0,1); }
      // set inputs to show the range
      document.getElementById('fromDate').value=isoDate(from);
      document.getElementById('toDate').value=isoDate(today);
      apply(from, today, btn.textContent.trim());
    }));

    // === Custom range ===
    document.getElementById('applyRange').onclick=()=>{
      const f=document.getElementById('fromDate').value;
      const t=document.getElementById('toDate').value;
      if(!f || !t){ alert('Pick both From and To dates.'); return; }
      const from=new Date(f+'T00:00:00');
      const to=new Date(t+'T23:59:59');
      rangeBar.forEach(x=>x.classList.remove('active'));
      apply(from, to, 'Selected');
    };

    // Single day helper
    document.getElementById('singleToday').onclick=()=>{
      const today=isoDate(new Date());
      document.getElementById('fromDate').value=today;
      document.getElementById('toDate').value=today;
      apply(new Date(today+'T00:00:00'), new Date(today+'T23:59:59'), 'Today');
      rangeBar.forEach(x=>x.classList.remove('active'));
    };

    // === Init ===
    (function init(){
      const today=isoDate(new Date());
      document.getElementById('fromDate').value=today;
      document.getElementById('toDate').value=today;
      apply(new Date(today+'T00:00:00'), new Date(today+'T23:59:59'), 'Today');
    })();

    // Live refresh if pharmacy data changes
    window.addEventListener('storage', e=>{
      if(['pharmacyRecords','pharmacyInvoices','invoices'].includes(e.key)){
        const f=document.getElementById('fromDate').value;
        const t=document.getElementById('toDate').value;
        if(f && t) apply(new Date(f+'T00:00:00'), new Date(t+'T23:59:59'), 'Selected');
      }
    });
  </script>
</body>
</html>
