<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Analytics ‚Äì Dr. Charan Hospital</title>

  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=24">

  <!-- Local Chart.js (offline-first) -->
  <script defer src="assets/chart.umd.min.js"></script>
</head>
<body>
  <!-- Banner -->
  <header class="banner" role="img" aria-label="Dr. Charan Hospital">
    <button id="themeToggle" class="chip floating-toggle" aria-label="Theme">üåô</button>
  </header>

  <!-- Top actions (kept small, under banner) -->
  <div class="top-actions container">
    <a class="chip" href="dashboard.html">‚Üê Dashboard</a>
    <span class="spacer"></span>
    <button id="logoutBtn" class="chip">Logout</button>
    <button id="clearCacheBtn" class="chip">Clear Cache</button>
  </div>

  <main class="container">
    <!-- Filters -->
    <section class="card">
      <h2>Sales Analytics</h2>
      <div class="filters">
        <div class="seg">
          <button class="seg-btn is-active" data-range="today">Today</button>
          <button class="seg-btn" data-range="7d">7D</button>
          <button class="seg-btn" data-range="30d">30D</button>
          <button class="seg-btn" data-range="ytd">YTD</button>
          <button class="seg-btn" data-range="custom">Custom</button>
        </div>
        <div class="dates" id="customDates" style="display:none">
          <label>From <input type="date" id="fromDate"></label>
          <label>To <input type="date" id="toDate"></label>
          <button class="btn" id="applyBtn">Apply</button>
        </div>
      </div>

      <!-- KPIs -->
      <div class="kpi-row">
        <div class="kpi">
          <div class="kpi-num" id="kpiTotal">0.00</div>
          <div class="kpi-label">Total ‚Çπ</div>
        </div>
        <div class="kpi">
          <div class="kpi-num" id="kpiAvg">0.00</div>
          <div class="kpi-label">Avg / Day ‚Çπ</div>
        </div>
        <div class="kpi">
          <div class="kpi-num" id="kpiInvoices">0</div>
          <div class="kpi-label">Invoices</div>
        </div>
        <div class="kpi">
          <div class="kpi-num" id="kpiTop">‚Äî</div>
          <div class="kpi-label">Top Item</div>
        </div>
      </div>

      <!-- Charts -->
      <div class="charts">
        <div class="chart-card">
          <h4>Revenue by Day</h4>
          <canvas id="lineByDay"></canvas>
        </div>
        <div class="chart-card">
          <h4>Top Items</h4>
          <canvas id="pieItems"></canvas>
        </div>
      </div>
    </section>
  </main>

  <script>
    /* -------------------------
       Access guard: doctor or supervisor
    -------------------------- */
    (function guard() {
      try {
        const s = JSON.parse(localStorage.getItem('session') || '{}');
        if (!s.role) location.replace('login.html');
        if (!['doctor','supervisor'].includes(s.role)) location.replace('login.html');
      } catch { location.replace('login.html'); }
    })();

    /* -------------------------
       Theme toggle
    -------------------------- */
    const html = document.documentElement;
    const themeBtn = document.getElementById('themeToggle');
    function applyTheme(t){ html.dataset.theme=t; themeBtn.textContent=t==='light'?'üåû':'üåô'; localStorage.theme=t; }
    applyTheme(localStorage.theme || 'light');
    themeBtn.onclick = ()=> applyTheme((html.dataset.theme||'light')==='light'?'dark':'light');

    /* -------------------------
       Actions
    -------------------------- */
    document.getElementById('logoutBtn').onclick = () => {
      localStorage.removeItem('session');
      location.href = 'login.html';
    };
    document.getElementById('clearCacheBtn').onclick = async () => {
      try {
        const session = localStorage.getItem('session');
        localStorage.clear(); if (session) localStorage.setItem('session', session);
        if ('caches' in window) { const ks = await caches.keys(); await Promise.all(ks.map(k => caches.delete(k))); }
        if ('serviceWorker' in navigator) { const regs = await navigator.serviceWorker.getRegistrations(); await Promise.all(regs.map(r=>r.unregister())); }
        alert('Cache cleared. Reloading‚Ä¶'); location.reload(true);
      } catch { alert('Could not fully clear cache.'); }
    };

    /* -------------------------
       Data helpers
    -------------------------- */
    function fmtINR(n){ return Number(n||0).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2}); }
    function dateStr(d){ return new Date(d.getFullYear(),d.getMonth(),d.getDate()).toISOString().slice(0,10); }

    function seedIfEmpty(){
      const raw = localStorage.getItem('invoices');
      if (raw) return;
      const items = ['Paracetamol 650','Amoxicillin','Cough Syrup','Vitamin D','Ibuprofen','Antacid'];
      const today = new Date();
      const arr = [];
      for (let i=0;i<30;i++){
        const d = new Date(today); d.setDate(today.getDate()-i);
        const lines = Array.from({length: 2 + (i%3)}, () => {
          const name = items[Math.floor(Math.random()*items.length)];
          const qty = 1 + Math.floor(Math.random()*3);
          const price = 60 + Math.floor(Math.random()*240);
          return {name, qty, price};
        });
        arr.push({date: dateStr(d), lines, paid:true});
      }
      localStorage.setItem('invoices', JSON.stringify(arr));
    }
    seedIfEmpty();

    function getInvoices(){ try{ const a=JSON.parse(localStorage.getItem('invoices')||'[]'); return Array.isArray(a)?a:[]; }catch{ return []; } }

    /* -------------------------
       Range handling
    -------------------------- */
    const segBtns = [...document.querySelectorAll('.seg-btn')];
    const customDates = document.getElementById('customDates');
    const fromInput = document.getElementById('fromDate');
    const toInput = document.getElementById('toDate');
    const applyBtn = document.getElementById('applyBtn');

    function setActive(btn){
      segBtns.forEach(b=>b.classList.toggle('is-active', b===btn));
    }

    function getRange(kind){
      const today = new Date();
      let from, to;
      if (kind==='today'){ from = to = today; }
      else if (kind==='7d'){ to=today; from = new Date(today); from.setDate(today.getDate()-6); }
      else if (kind==='30d'){ to=today; from = new Date(today); from.setDate(today.getDate()-29); }
      else if (kind==='ytd'){ to=today; from = new Date(today.getFullYear(),0,1); }
      else { // custom
        const f = fromInput.value, t = toInput.value;
        if (!f || !t) return null;
        from = new Date(f+'T00:00:00'); to = new Date(t+'T00:00:00');
      }
      return { from: dateStr(from), to: dateStr(to) };
    }

    segBtns.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        setActive(btn);
        const k = btn.dataset.range;
        customDates.style.display = k==='custom' ? 'flex' : 'none';
        if (k!=='custom') render(k);
      });
    });
    applyBtn.onclick = ()=> render('custom');

    /* -------------------------
       Summaries + charts
    -------------------------- */
    let lineChart, pieChart;

    function summarize(range){
      const invoices = getInvoices();
      const mapByDate = new Map(); // date -> total
      const byItem = new Map();    // item -> total
      let total = 0, invCount = 0;

      for (const inv of invoices){
        if (!inv.date || inv.date < range.from || inv.date > range.to) continue;
        const t = (inv.lines||[]).reduce((s,l)=> s + (l.qty||0)*(l.price||0), 0);
        invCount += 1;
        total += t;
        mapByDate.set(inv.date, (mapByDate.get(inv.date)||0) + t);
        for (const l of inv.lines||[]){
          const k = l.name || 'Item';
          const amt = (l.qty||0)*(l.price||0);
          byItem.set(k, (byItem.get(k)||0) + amt);
        }
      }

      let topItem = '‚Äî';
      if (byItem.size){
        topItem = [...byItem.entries()].sort((a,b)=>b[1]-a[1])[0][0];
      }
      return { total, invCount, byItem, mapByDate, topItem };
    }

    function buildLabels(range){
      const labels = [];
      const d0 = new Date(range.from+'T00:00:00');
      const d1 = new Date(range.to+'T00:00:00');
      for (let d=new Date(d0); d<=d1; d.setDate(d.getDate()+1)){
        labels.push({ key: dateStr(d), label: d.toLocaleDateString('en-IN',{day:'2-digit',month:'short'}) });
      }
      return labels;
    }

    function render(kind='today'){
      const range = getRange(kind);
      if (!range) return;

      // KPIs
      const sum = summarize(range);
      const dayLabels = buildLabels(range);
      const dayValues = dayLabels.map(x=> sum.mapByDate.get(x.key) || 0);

      document.getElementById('kpiTotal').textContent = fmtINR(sum.total);
      const days = Math.max(1, dayLabels.length);
      document.getElementById('kpiAvg').textContent = fmtINR(sum.total / days);
      document.getElementById('kpiInvoices').textContent = sum.invCount;
      document.getElementById('kpiTop').textContent = sum.topItem;

      // Line chart
      const lineCtx = document.getElementById('lineByDay').getContext('2d');
      if (lineChart) lineChart.destroy();
      lineChart = new Chart(lineCtx, {
        type: 'line',
        data: {
          labels: dayLabels.map(x=>x.label),
          datasets: [{
            data: dayValues,
            borderWidth: 2,
            tension: .3,
            pointRadius: 2
          }]
        },
        options: {
          plugins: { legend: { display:false }, tooltip: { callbacks:{ label:(c)=>'‚Çπ'+fmtINR(c.parsed.y) } } },
          scales: { y: { ticks: { callback: v=>'‚Çπ'+fmtINR(v) } } }
        }
      });

      // Pie chart
      const pieCtx = document.getElementById('pieItems').getContext('2d');
      if (pieChart) pieChart.destroy();
      const labels = [...sum.byItem.keys()];
      const vals = [...sum.byItem.values()];
      pieChart = new Chart(pieCtx, {
        type: 'pie',
        data: {
          labels: labels.length?labels:['No data'],
          datasets: [{ data: vals.length?vals:[1], borderWidth:0 }]
        },
        options: {
          plugins: {
            legend: { position:'bottom' },
            tooltip: { callbacks:{ label:(c)=> '‚Çπ'+fmtINR(c.parsed) } }
          }
        }
      });
    }

    // Initialize
    if (window.Chart) render('today');
    else document.addEventListener('DOMContentLoaded', ()=>{
      const iv=setInterval(()=>{ if(window.Chart){ clearInterval(iv); render('today'); }}, 30);
    });
  </script>

  <style>
    /* tiny page-specific helpers reusing your palette */
    .filters{display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:12px}
    .seg{display:flex; gap:6px; background:var(--card); padding:6px; border-radius:999px}
    .seg-btn{border:0; padding:8px 14px; border-radius:999px; background:transparent; color:var(--text); font-weight:600}
    .seg-btn.is-active{background:var(--brand-500); color:#fff}
    .dates{display:flex; gap:8px; align-items:center}
    .spacer{flex:1}
  </style>
</body>
</html>
