<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Analytics â€“ Dr. Charan</title>
  <link rel="stylesheet" href="styles.css?v=20"/>
</head>
<body>
  <header class="banner">
    <button id="themeToggle" class="chip floating-toggle small">ðŸŒ™</button>
  </header>
  <main class="container">
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <h3 class="section-title">Analytics</h3>
        <div class="pillbar">
          <button class="pill active" data-range="day">Daily</button>
          <button class="pill" data-range="week">Weekly</button>
          <button class="pill" data-range="month">Monthly</button>
          <button class="pill" data-range="year">Yearly</button>
        </div>
      </div>

      <div class="grid-2" style="margin-top:12px">
        <div class="stat good">
          <div class="k" id="kTotal">0.00</div>
          <div class="muted">Total Sales (selected)</div>
        </div>
        <div class="stat warn">
          <div class="k" id="kCount">0</div>
          <div class="muted">Invoices (selected)</div>
        </div>
      </div>

      <div class="chart-card">
        <canvas id="rangeChart" height="240" style="width:100%"></canvas>
      </div>
    </section>
  </main>

  <script type="module">
    import { listInvoices } from './js/store.js?v=21';

    // theme
    const t=document.getElementById('themeToggle');
    if(localStorage.theme){ document.documentElement.dataset.theme=localStorage.theme; t.textContent=localStorage.theme==='light'?'ðŸŒž':'ðŸŒ™'; }
    t.onclick=()=>{ const cur=document.documentElement.dataset.theme||'light'; const next=cur==='light'?'dark':'light'; document.documentElement.dataset.theme=next; localStorage.theme=next; t.textContent=next==='light'?'ðŸŒž':'ðŸŒ™'; };

    let range='day';
    document.querySelectorAll('.pill').forEach(p=>{
      p.onclick=()=>{ document.querySelectorAll('.pill').forEach(x=>x.classList.remove('active')); p.classList.add('active'); range=p.dataset.range; draw(); }
    });

    function group(invs){
      const map=new Map();
      invs.forEach(x=>{ const k=x.date; map.set(k, (map.get(k)||0)+(+x.total||0)); });
      const arr=[...map.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
      return {labels:arr.map(a=>a[0].slice(5)), data:arr.map(a=>a[1])};
    }

    function draw(){
      const invs=listInvoices();
      const now=new Date();
      let start=new Date(now);

      if(range==='day'){ start.setDate(now.getDate()-6); }
      if(range==='week'){ start.setDate(now.getDate()-27); }
      if(range==='month'){ start=new Date(now.getFullYear(), now.getMonth()-11, 1); }
      if(range==='year'){ start=new Date(now.getFullYear()-5, 0, 1); }

      const sISO=start.toISOString().slice(0,10);
      const filtered=invs.filter(i=>i.date>=sISO);
      const {labels,data}=group(filtered);

      const total=data.reduce((s,v)=>s+v,0);
      document.getElementById('kTotal').textContent=total.toFixed(2);
      document.getElementById('kCount').textContent=filtered.length;

      const c=document.getElementById('rangeChart'), ctx=c.getContext('2d');
      c.width=c.clientWidth*2; c.height=c.clientHeight*2; ctx.scale(2,2);
      const W=c.clientWidth, H=c.clientHeight, pad=30;
      ctx.clearRect(0,0,W,H);
      const border=getComputedStyle(document.documentElement).getPropertyValue('--border');
      const primary=getComputedStyle(document.documentElement).getPropertyValue('--primary');
      ctx.strokeStyle=border; ctx.beginPath(); ctx.moveTo(pad,H-pad); ctx.lineTo(W-pad,H-pad); ctx.stroke();

      const max=Math.max(10,...data);
      const slot=(W-pad*2)/(Math.max(1,labels.length)); const bw=slot*0.6; const base=H-pad;
      data.forEach((v,i)=>{ const h=Math.round((v/max)*(H-pad*2)); const x=pad+i*slot+(slot-bw)/2; ctx.fillStyle=primary; ctx.fillRect(x,base-h,bw,h); });
      ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--muted'); ctx.font='11px system-ui'; ctx.textAlign='center';
      labels.forEach((lb,i)=>{ const x=pad+i*slot+slot/2; ctx.fillText(lb,x,H-8); });
    }

    draw(); addEventListener('resize', draw);
  </script>
</body>
</html>
