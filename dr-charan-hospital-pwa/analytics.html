<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sales Analytics ‚Äì Dr. Charan Hospital</title>

  <!-- PWA + styles -->
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=20"/>

  <!-- Local Chart.js for offline-first -->
  <script defer src="assets/chart.umd.min.js"></script>
</head>
<body>
  <!-- Banner (shared) -->
  <header class="banner">
    <button id="themeToggle" class="chip floating-toggle" aria-label="Theme">üåô</button>
  </header>

  <!-- Fixed actions (shared) -->
  <nav class="fixed-actions container">
    <a href="dashboard.html" class="chip">‚Üê Dashboard</a>
    <button id="logoutBtn" class="chip">Logout</button>
    <button id="clearCacheBtn" class="chip">Clear Cache</button>
  </nav>

  <main class="container">

    <!-- Header + Range pills -->
    <section class="section tint tint-blue">
      <div class="section-header" style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <h2 style="font-size:20px">Sales Analytics</h2>
        <div class="pills" id="rangePills">
          <button class="pill is-active" data-range="7d">7D</button>
          <button class="pill" data-range="30d">30D</button>
          <button class="pill" data-range="ytd">YTD</button>
          <button class="pill" data-range="custom">Custom</button>
        </div>
      </div>

      <!-- Custom date range (hidden until chosen) -->
      <div id="customRange" style="display:none;gap:10px;align-items:center;margin-top:6px">
        <input id="fromDate" type="date" class="input" style="max-width:200px"/>
        <span class="muted">to</span>
        <input id="toDate" type="date" class="input" style="max-width:200px"/>
        <button id="applyCustom" class="btn">Apply</button>
      </div>
    </section>

    <!-- KPIs -->
    <section class="section">
      <div class="card-grid">
        <div class="card kpi-card kpi-blue">
          <h3>Total (‚Çπ)</h3>
          <div class="kpi-value" id="kpiTotal">0.00</div>
        </div>
        <div class="card kpi-card kpi-violet">
          <h3>Avg / Day (‚Çπ)</h3>
          <div class="kpi-value" id="kpiAvg">0.00</div>
        </div>
        <div class="card kpi-card kpi-green">
          <h3>Invoices</h3>
          <div class="kpi-value" id="kpiInv">0</div>
        </div>
        <div class="card kpi-card kpi-rose">
          <h3>Top Item</h3>
          <div class="kpi-sub" id="kpiTop">‚Äî</div>
        </div>
      </div>
    </section>

    <!-- Charts -->
    <section class="section tint tint-green">
      <h2 style="margin-bottom:10px">Revenue by Day</h2>
      <div class="chart-card">
        <canvas id="lineChart" height="280"></canvas>
      </div>
    </section>

    <section class="section tint tint-rose">
      <h2 style="margin-bottom:10px">Top Items (Selected Range)</h2>
      <div class="chart-card">
        <canvas id="pieChart" height="280"></canvas>
      </div>
    </section>

    <!-- Items table -->
    <section class="section tint tint-amber">
      <h2 style="margin-bottom:10px">Item Breakdown</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Item</th>
              <th>Qty</th>
              <th>Revenue ‚Çπ</th>
            </tr>
          </thead>
          <tbody id="itemsTbody">
            <tr><td colspan="3" class="muted">No data</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script type="module">
    /* ===== Theme bootstrap (shared) ===== */
    const t=document.getElementById('themeToggle');
    if(localStorage.theme){
      document.documentElement.dataset.theme=localStorage.theme;
      t.textContent=localStorage.theme==='light'?'üåû':'üåô';
    }
    t.onclick=()=>{const cur=document.documentElement.dataset.theme||'light';
      const next=cur==='light'?'dark':'light';
      document.documentElement.dataset.theme=next; localStorage.theme=next;
      t.textContent=next==='light'?'üåû':'üåô';};

    // Logout & cache
    document.getElementById('logoutBtn').onclick=()=>{ localStorage.removeItem('session'); location.href='login.html'; };
    document.getElementById('clearCacheBtn').onclick=async()=>{
      try{
        localStorage.clear();
        if('caches' in window){ for(const k of await caches.keys()) await caches.delete(k); }
        if('serviceWorker' in navigator){ for(const r of await navigator.serviceWorker.getRegistrations()) await r.unregister(); }
      }finally{ location.reload(); }
    };

    /* ===== Data helpers ===== */
    function getInvoices(){
      // Expecting invoices array in localStorage (from pharmacy billing):
      // [{id,date:'YYYY-MM-DD', items:[{name,qty,price}], total:number}, ...]
      try { return JSON.parse(localStorage.getItem('invoices')||'[]'); }
      catch { return []; }
    }
    function startOfYear(d){ return new Date(d.getFullYear(),0,1); }
    function fmt(n){ return (Number(n)||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }

    /* ===== Range handling ===== */
    const pills=document.querySelectorAll('#rangePills .pill');
    const customWrap=document.getElementById('customRange');
    let currentRange='7d';
    pills.forEach(p=>p.addEventListener('click',()=>{
      pills.forEach(x=>x.classList.remove('is-active'));
      p.classList.add('is-active');
      currentRange=p.dataset.range;
      customWrap.style.display = currentRange==='custom' ? 'flex' : 'none';
      if(currentRange!=='custom') refresh();
    }));
    document.getElementById('applyCustom').onclick=refresh;

    function computeWindow(){
      const now=new Date();
      let from, to;
      if(currentRange==='7d'){ to=now; from=new Date(now); from.setDate(from.getDate()-6); }
      else if(currentRange==='30d'){ to=now; from=new Date(now); from.setDate(from.getDate()-29); }
      else if(currentRange==='ytd'){ from=startOfYear(now); to=now; }
      else { // custom
        const f=document.getElementById('fromDate').value;
        const t=document.getElementById('toDate').value;
        from=f?new Date(f):startOfYear(now);
        to=t?new Date(t):now;
      }
      // normalize to YYYY-MM-DD strings for compare
      const s = d => d.toISOString().slice(0,10);
      return {from: s(from), to: s(to)};
    }

    /* ===== Charts ===== */
    let lineChart, pieChart;
    function ensureCharts(){
      if(!lineChart){
        lineChart=new Chart(document.getElementById('lineChart').getContext('2d'),{
          type:'line',
          data:{labels:[], datasets:[{label:'Revenue ‚Çπ', data:[], tension:.3, fill:false}]},
          options:{responsive:true, maintainAspectRatio:false,
            plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}}}
        });
      }
      if(!pieChart){
        pieChart=new Chart(document.getElementById('pieChart').getContext('2d'),{
          type:'pie',
          data:{labels:[], datasets:[{data:[]}]},
          options:{responsive:true, maintainAspectRatio:false,
            plugins:{legend:{position:'bottom'}}}
        });
      }
    }

    /* ===== Refresh UI ===== */
    function refresh(){
      const {from,to}=computeWindow();
      const invs=getInvoices().filter(i=>i.date>=from && i.date<=to);

      // KPIs
      const total=invs.reduce((s,i)=>s+(i.total||0),0);
      const days=Math.max(1,(new Date(to)-new Date(from))/86400000 + 1);
      document.getElementById('kpiTotal').textContent=fmt(total);
      document.getElementById('kpiAvg').textContent=fmt(total/days);
      document.getElementById('kpiInv').textContent=invs.length.toString();

      // Items aggregation
      const itemMap=new Map(); // name -> {qty, revenue}
      invs.forEach(i=> (i.items||[]).forEach(it=>{
        const key=it.name||'Unknown';
        const prev=itemMap.get(key)||{qty:0, revenue:0};
        prev.qty += Number(it.qty)||0;
        prev.revenue += (Number(it.price)||0)*(Number(it.qty)||0);
        itemMap.set(key,prev);
      }));
      const items=[...itemMap.entries()].map(([name,{qty,revenue}])=>({name,qty,revenue}))
                   .sort((a,b)=>b.revenue-a.revenue);

      document.getElementById('kpiTop').textContent = items[0]?.name || '‚Äî';

      // Table
      const tb=document.getElementById('itemsTbody');
      tb.innerHTML = items.length
        ? items.map(r=>`<tr><td>${r.name}</td><td>${r.qty}</td><td>${fmt(r.revenue)}</td></tr>`).join('')
        : `<tr><td colspan="3" class="muted">No data</td></tr>`;

      // Charts
      ensureCharts();

      // line by date
      const byDateMap=new Map(); // 'YYYY-MM-DD' -> sum
      invs.forEach(i=>byDateMap.set(i.date,(byDateMap.get(i.date)||0)+(i.total||0)));
      const dates=[...byDateMap.keys()].sort();
      lineChart.data.labels = dates;
      lineChart.data.datasets[0].data = dates.map(d=>byDateMap.get(d));
      lineChart.update();

      // pie by top items (cap at 8, group rest)
      const top=items.slice(0,7);
      const rest=items.slice(7).reduce((s,x)=>s+x.revenue,0);
      if(rest>0) top.push({name:'Others', revenue:rest});
      pieChart.data.labels = top.map(x=>x.name);
      pieChart.data.datasets[0].data = top.map(x=>x.revenue);
      pieChart.update();
    }

    // init
    refresh();

    // SW quietly
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('service-worker.js').catch(()=>{});
    }
  </script>
</body>
</html>
