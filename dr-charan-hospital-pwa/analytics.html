<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Analytics ‚Äì Dr. Charan Hospital</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=14"/>
  <style>
    .seg {display:inline-flex;gap:6px;background:var(--surface);padding:6px;border:1px solid var(--border);border-radius:999px}
    .seg button{border:none;padding:8px 12px;border-radius:999px;background:transparent}
    .seg .on{background:var(--primary);color:#fff}
    .kpis{display:grid;gap:10px;grid-template-columns:repeat(4,1fr)}
    .kpi{padding:14px;border:1px solid var(--border);border-radius:16px;background:var(--surface-2)}
    .kpi .n{font-size:22px;font-weight:700}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
    .muted{color:var(--muted)}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-top:1px solid var(--border);text-align:left}
    .floating-actions{position:absolute;left:14px;bottom:14px;z-index:10;display:flex;gap:8px}
    .banner{position:relative}
  </style>
</head>
<body>
  <header class="banner clean"></header>
  <div class="floating-actions">
    <a href="dashboard.html" class="chip">‚Üê Dashboard</a>
    <button id="clearCacheBtn" class="chip">Clear Cache</button>
  </div>
  <button id="themeToggle" class="chip floating-toggle">üåô</button>

  <main class="container n8">
    <section class="card">
      <div class="toolbar">
        <div class="seg" id="seg">
          <button data-mode="day"   class="on">Daily</button>
          <button data-mode="week">Weekly</button>
          <button data-mode="month">Monthly</button>
          <button data-mode="year">Yearly</button>
        </div>
        <input id="pickDay"   type="date"/>
        <input id="pickMonth" type="month" style="display:none"/>
        <input id="pickYear"  type="number" min="2000" max="2099" step="1" style="width:100px;display:none"/>
        <button id="prev" class="chip">‚óÄ</button>
        <button id="next" class="chip">‚ñ∂</button>
        <span id="label" class="muted"></span>
        <button id="exportCsv" class="chip">Export CSV</button>
      </div>

      <div class="kpis">
        <div class="kpi"><div class="n" id="kTotal">0</div><div class="muted">Total ‚Çπ (period)</div></div>
        <div class="kpi"><div class="n" id="kInv">0</div><div class="muted">Invoices</div></div>
        <div class="kpi"><div class="n" id="kAvg">0</div><div class="muted">Avg ‚Çπ/invoice</div></div>
        <div class="kpi"><div class="n" id="kTop">‚Äì</div><div class="muted">Top Item</div></div>
      </div>

      <canvas id="mainChart" height="200" style="width:100%;margin:16px 0"></canvas>

      <div class="tile-grid" style="grid-template-columns:1fr 1fr">
        <div class="card" style="margin:0">
          <h4 style="margin:0 0 6px">This vs Last Period</h4>
          <div class="kpis" style="grid-template-columns:repeat(2,1fr)">
            <div class="kpi"><div class="n" id="thisTotal">0</div><div class="muted">This Period ‚Çπ</div></div>
            <div class="kpi"><div class="n" id="lastTotal">0</div><div class="muted">Last Period ‚Çπ</div></div>
          </div>
        </div>
        <div class="card" style="margin:0">
          <h4 style="margin:0 0 6px">Revenue by Item</h4>
          <canvas id="donut" height="200" style="width:100%"></canvas>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <h4 style="margin:0 0 6px">Top Items (period)</h4>
        <table class="table" id="itemsTable">
          <thead><tr><th>Item</th><th>Qty</th><th>Revenue ‚Çπ</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <script type="module">
    import { requireRole, listInvoices, listSales } from './js/store.js?v=21';
    requireRole('doctor');

    // --- UI helpers ---
    const seg=document.getElementById('seg');
    const day=document.getElementById('pickDay');
    const mon=document.getElementById('pickMonth');
    const year=document.getElementById('pickYear');
    const label=document.getElementById('label');
    const t=document.getElementById('themeToggle');
    if(localStorage.theme){ document.documentElement.dataset.theme=localStorage.theme; t.textContent=localStorage.theme==='light'?'üåû':'üåô'; }
    t.onclick=()=>{ const cur=document.documentElement.dataset.theme||'light'; const next=cur==='light'?'dark':'light'; document.documentElement.dataset.theme=next; localStorage.theme=next; t.textContent=next==='light'?'üåû':'üåô'; };
    document.getElementById('clearCacheBtn').onclick=async()=>{ localStorage.clear(); if('caches'in window){(await caches.keys()).map(k=>caches.delete(k))}; alert('Cache cleared'); location.reload(); };

    // --- period state ---
    let mode='day';
    day.value = new Date().toISOString().slice(0,10);
    mon.value = new Date().toISOString().slice(0,7);
    year.value = new Date().getFullYear();

    seg.addEventListener('click',e=>{
      if(e.target.tagName!=='BUTTON') return;
      seg.querySelectorAll('button').forEach(b=>b.classList.remove('on'));
      e.target.classList.add('on');
      mode = e.target.dataset.mode;
      day.style.display = mode==='day'?'':'none';
      mon.style.display = mode==='month' || mode==='week' ? '' : 'none';
      year.style.display = mode==='year' ? '' : 'none';
      if(mode==='week'){ if(!mon.value) mon.value=new Date().toISOString().slice(0,7); }
      render();
    });

    document.getElementById('prev').onclick=()=>{ shift(-1); render(); };
    document.getElementById('next').onclick=()=>{ shift(1); render(); };
    day.onchange=mon.onchange=year.onchange=render;

    function shift(delta){
      if(mode==='day'){
        const d=new Date(day.value); d.setDate(d.getDate()+delta); day.value=d.toISOString().slice(0,10);
      }else if(mode==='week' || mode==='month'){
        const [y,m]=mon.value.split('-').map(n=>+n); const d=new Date(y,m-1,1); d.setMonth(d.getMonth()+delta); mon.value=d.toISOString().slice(0,7);
      }else{
        year.value = (+year.value||new Date().getFullYear()) + delta;
      }
    }

    // --- data slicing ---
    function sliceInvoices(){
      const invs = listInvoices();
      if(mode==='day'){
        const d=day.value;
        label.textContent = d;
        return invs.filter(i=>i.date===d);
      }
      if(mode==='week'){
        const ym = mon.value; // YYYY-MM
        // group by ISO week inside the month
        return invs.filter(i=> (i.date||'').startsWith(ym));
      }
      if(mode==='month'){
        const ym = mon.value;
        label.textContent = ym;
        return invs.filter(i=> (i.date||'').startsWith(ym));
      }
      const yy = String(year.value);
      label.textContent = yy;
      return invs.filter(i=> (i.date||'').startsWith(yy));
    }

    // --- charts (vanilla canvas) ---
    function drawBars(canvas, labels, data){
      const c=canvas, ctx=c.getContext('2d'); c.width=c.clientWidth*2; c.height=c.clientHeight*2; ctx.scale(2,2);
      const W=c.clientWidth, H=c.clientHeight, pad=24; ctx.clearRect(0,0,W,H);
      const border=getComputedStyle(document.documentElement).getPropertyValue('--border')||'#e9edf5';
      ctx.strokeStyle=border; ctx.beginPath(); ctx.moveTo(pad,H-pad); ctx.lineTo(W-pad,H-pad); ctx.stroke();
      const max=Math.max(10,...data); const slot=(W-pad*2)/labels.length, bw=slot*0.7, base=H-pad;
      const primary=getComputedStyle(document.documentElement).getPropertyValue('--primary')||'#5166ff';
      const muted=getComputedStyle(document.documentElement).getPropertyValue('--muted')||'#738';
      labels.forEach((lb,i)=>{ const x=pad+i*slot+(slot-bw)/2; const h=Math.round((data[i]/max)*(H-pad*2));
        ctx.fillStyle=primary; ctx.fillRect(x,base-h,bw,h); ctx.fillStyle=muted; ctx.font='11px system-ui'; ctx.textAlign='center'; ctx.fillText(lb,x+bw/2,H-6);
      });
    }
    function drawDonut(canvas, slices){
      const c=canvas, ctx=c.getContext('2d'); c.width=c.clientWidth*2; c.height=c.clientHeight*2; ctx.scale(2,2);
      const W=c.clientWidth, H=c.clientHeight, cx=W/2, cy=H/2, r=Math.min(W,H)/2-12; ctx.clearRect(0,0,W,H);
      const colors=['#5b8cff','#65d6ad','#f39c9c','#f7c948','#8a7ff5','#56ccf2','#ff9f43','#00c4cc'];
      const tot=slices.reduce((s,x)=>s+x.value,0)||1; let ang=-Math.PI/2;
      slices.forEach((s,i)=>{ const a=2*Math.PI*(s.value/tot); ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,ang,ang+a); ctx.closePath(); ctx.fillStyle=colors[i%colors.length]; ctx.fill(); ang+=a; });
      // hole
      ctx.globalCompositeOperation='destination-out'; ctx.beginPath(); ctx.arc(cx,cy,r*0.55,0,2*Math.PI); ctx.fill(); ctx.globalCompositeOperation='source-over';
    }

    // --- render ---
    function render(){
      const invs=sliceInvoices();
      // KPIs
      const total=invs.reduce((s,i)=>s+(+i.total||0),0);
      const count=invs.length;
      const avg=count? total/count : 0;
      const sales=listSales().filter(r=> invs.some(i=>i.number===r.invoice));
      const agg={}; for(const r of sales){ agg[r.item]=(agg[r.item]||0)+(+r.amount||0); }
      let top='‚Äì',best=-1; for(const [k,v] of Object.entries(agg)){ if(v>best){best=v; top=k;} }
      kTotal.textContent=total.toFixed(2); kInv.textContent=count; kAvg.textContent=avg.toFixed(2); kTop.textContent=top;

      // This vs Last period
      const {thisTotal,lastTotal}=compareTotals();
      document.getElementById('thisTotal').textContent=thisTotal.toFixed(2);
      document.getElementById('lastTotal').textContent=lastTotal.toFixed(2);

      // Bars
      const labels=[], data=[];
      if(mode==='day'){
        // hours (simple 4 buckets)
        const buckets=[0,0,0,0]; invs.forEach(i=>{ const h=12; buckets[0]+=+i.total||0; }); // keep simple for demo
        ['AM','Noon','PM','Eve'].forEach((l,i)=>{ labels.push(l); data.push(buckets[i]); });
      }else if(mode==='week'){
        // 4 weeks inside month
        const week=[0,0,0,0]; invs.forEach(i=>{ const d=new Date(i.date).getDate(); const idx=Math.min(3,Math.floor((d-1)/7)); week[idx]+=+i.total||0; });
        ['W1','W2','W3','W4'].forEach((l,i)=>{ labels.push(l); data.push(week[i]); });
      }else if(mode==='month'){
        const ym=mon.value; const daysInMonth=new Date(+ym.slice(0,4),+ym.slice(5)+0,0).getDate();
        for(let d=1; d<=daysInMonth; d++){ const k=String(d).padStart(2,'0'); labels.push(k); data.push(invs.filter(i=>i.date.endsWith('-'+k)).reduce((s,x)=>s+(+x.total||0),0)); }
      }else{
        const yy=String(year.value);
        for(let m=1;m<=12;m++){ const k=String(m).padStart(2,'0'); labels.push(k); data.push(listInvoices().filter(i=>i.date.startsWith(`${yy}-${k}`)).reduce((s,x)=>s+(+x.total||0),0)); }
      }
      drawBars(document.getElementById('mainChart'), labels, data);

      // Donut
      const slices=Object.entries(agg).sort((a,b)=>b[1]-a[1]).slice(0,6).map(([name,value])=>({name,value}));
      drawDonut(document.getElementById('donut'), slices);

      // Table
      const tb=document.querySelector('#itemsTable tbody'); tb.innerHTML='';
      const rows=Object.entries(agg).map(([item,rev])=>{
        const qty=sales.filter(s=>s.item===item).reduce((s,x)=>s+(+x.qty||0),0);
        return {item,qty,rev};
      }).sort((a,b)=>b.rev-a.rev).slice(0,20);
      rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.item}</td><td>${r.qty}</td><td>‚Çπ${r.rev.toFixed(2)}</td>`; tb.appendChild(tr); });
    }

    function compareTotals(){
      const invs=listInvoices();
      if(mode==='day'){
        const d=new Date(day.value); const cur=invs.filter(i=>i.date===day.value);
        const prevDate=new Date(d); prevDate.setDate(d.getDate()-1);
        const prev=invs.filter(i=>i.date===prevDate.toISOString().slice(0,10));
        return {thisTotal:sum(cur), lastTotal:sum(prev)};
      }
      if(mode==='week' || mode==='month'){
        const ym=mon.value, [y,m]=ym.split('-').map(Number);
        const cur=invs.filter(i=> (i.date||'').startsWith(ym));
        const prevMonth=new Date(y,m-2,1).toISOString().slice(0,7);
        const prev=invs.filter(i=> (i.date||'').startsWith(prevMonth));
        return {thisTotal:sum(cur), lastTotal:sum(prev)};
      }
      const yy=String(year.value); const cur=invs.filter(i=> (i.date||'').startsWith(yy));
      const prev=invs.filter(i=> (i.date||'').startsWith(String(+yy-1)));
      return {thisTotal:sum(cur), lastTotal:sum(prev)};
    }
    function sum(rows){ return rows.reduce((s,i)=>s+(+i.total||0),0); }

    document.getElementById('exportCsv').onclick=()=>{
      const sales=listSales().filter(r=> sliceInvoices().some(i=>i.number===r.invoice));
      const head=['date','item','qty','price','amount','invoice'];
      const csv=[head,...sales.map(r=>[r.date,r.item,r.qty,r.price,r.amount,r.invoice])].map(a=>a.join(',')).join('\n');
      const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='analytics_period.csv'; a.click();
    };

    render();
    addEventListener('resize', render);
  </script>
</body>
</html>
