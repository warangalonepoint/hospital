<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Analytics ‚Äì Dr. Charan Hospital</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=25"/>
</head>
<body>
  <!-- Banner -->
  <header class="banner">
    <button id="themeToggle" class="chip floating-toggle" aria-label="Theme">üåô</button>
  </header>

  <!-- Small fixed actions (kept off the banner) -->
  <div class="fixed-actions">
    <a class="chip" href="dashboard.html">‚Üê Dashboard</a>
    <button id="logoutBtn" class="chip">Logout</button>
    <button id="clearCacheBtn" class="chip">Clear Cache</button>
  </div>

  <main style="max-width:1100px;margin:0 auto;padding:0 12px 28px;">
    <section class="login-card" style="max-width:none;">
      <h1 class="login-title" style="margin-bottom:6px;">Sales Analytics</h1>

      <!-- Range chips -->
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin:6px 0 14px;">
        <button class="chip" data-range="7d">7D</button>
        <button class="chip" data-range="30d">30D</button>
        <button class="chip" data-range="ytd">YTD</button>
        <button class="chip" data-range="custom" id="customBtn">Custom</button>
        <input id="from" type="date" class="input" style="width:auto;padding:6px 10px;display:none;">
        <input id="to" type="date" class="input" style="width:auto;padding:6px 10px;display:none;">
        <button id="applyCustom" class="btn" style="display:none;">Apply</button>
      </div>

      <!-- KPIs -->
      <div class="card-grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;">
        <div class="card"><h2>Total ‚Çπ</h2><p id="kpiTotal">0.00</p></div>
        <div class="card"><h2>Avg / Day ‚Çπ</h2><p id="kpiAvg">0.00</p></div>
        <div class="card"><h2>Invoices</h2><p id="kpiInv">0</p></div>
        <div class="card"><h2>Top Item</h2><p id="kpiTop">‚Äî</p></div>
      </div>

      <!-- Charts -->
      <div class="card" style="margin-top:16px;">
        <h2 style="text-align:left;margin-bottom:8px;">Revenue by Day</h2>
        <canvas id="revLine" height="140"></canvas>
      </div>

      <div class="card" style="margin-top:16px;">
        <h2 style="text-align:left;margin-bottom:8px;">Top Items (Today)</h2>
        <canvas id="topPie" height="140"></canvas>
      </div>
    </section>
  </main>

  <script src="assets/chart.umd.min.js"></script>
  <script type="module">
    /* ---------- Session guard (doctor only) ---------- */
    const session = JSON.parse(localStorage.getItem('session')||'null');
    if (!session || session.role !== 'doctor') {
      location.replace('login.html');
    }

    /* ---------- Theme toggle ---------- */
    const t = document.getElementById('themeToggle');
    function applyTheme(mode){
      document.documentElement.dataset.theme = mode;
      t.textContent = mode === 'light' ? 'üåû' : 'üåô';
      localStorage.theme = mode;
    }
    applyTheme(localStorage.theme || 'light');
    t.onclick=()=>applyTheme((document.documentElement.dataset.theme||'light')==='light'?'dark':'light');

    /* ---------- Logout & Clear cache ---------- */
    document.getElementById('logoutBtn').onclick=()=>{
      localStorage.removeItem('session'); location.href='login.html';
    };
    document.getElementById('clearCacheBtn').onclick=async()=>{
      try {
        if ('caches' in window) { const ks=await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k))); }
        alert('Cache cleared. Reloading‚Ä¶'); location.reload(true);
      } catch { alert('Could not fully clear. Try hard reload.'); }
    };

    /* ---------- Demo data (replace with Supabase later) ---------- */
    // In PROD, fetch aggregated sales from store/supabase.
    function demoRange(days=7){
      const out=[];
      const today=new Date();
      for(let i=days-1;i>=0;i--){
        const d=new Date(today); d.setDate(today.getDate()-i);
        const label = d.toISOString().slice(5,10); // MM-DD
        // synthetic curve
        const val=Math.max(0, Math.round(500 + 300*Math.sin((i/5)*Math.PI) + (Math.random()*120-60)));
        out.push({label, value:val});
      }
      return out;
    }
    function demoTopToday(){
      return [
        { name:'Paracetamol', value: 12 },
        { name:'Cetrizine',   value: 8  },
        { name:'Amoxicillin', value: 5  },
        { name:'ORS',         value: 4  }
      ];
    }

    /* ---------- Charts ---------- */
    const ctxLine = document.getElementById('revLine');
    const ctxPie  = document.getElementById('topPie');
    let lineChart, pieChart;

    function render(rangeKey='7d'){
      // decide dataset by range
      let data = demoRange(rangeKey==='30d' ? 30 : (rangeKey==='ytd' ? 180 : 7));
      const labels = data.map(d=>d.label);
      const values = data.map(d=>d.value);
      const total = values.reduce((a,b)=>a+b,0);
      const avg   = values.length ? total/values.length : 0;

      // KPIs
      document.getElementById('kpiTotal').textContent = total.toFixed(2);
      document.getElementById('kpiAvg').textContent   = avg.toFixed(2);
      document.getElementById('kpiInv').textContent   = values.length.toString();

      // Top item (dummy from pie)
      const tops = demoTopToday();
      document.getElementById('kpiTop').textContent = tops[0]?.name || '‚Äî';

      // Line
      lineChart?.destroy();
      lineChart = new Chart(ctxLine, {
        type:'line',
        data:{ labels, datasets:[{ label:'Revenue ‚Çπ', data:values, tension:.35, borderWidth:2, fill:false }] },
        options:{
          responsive:true,
          plugins:{ legend:{display:false} },
          scales:{ x:{ grid:{display:false}}, y:{ beginAtZero:true } }
        }
      });

      // Pie
      pieChart?.destroy();
      pieChart = new Chart(ctxPie, {
        type:'pie',
        data:{
          labels: tops.map(t=>t.name),
          datasets:[{ data: tops.map(t=>t.value) }]
        },
        options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } }
      });
    }

    // Range chip handlers
    const chips = document.querySelectorAll('[data-range]');
    chips.forEach(c=>c.addEventListener('click', ()=>{
      const k = c.getAttribute('data-range');
      if (k==='custom'){
        document.getElementById('from').style.display='inline-block';
        document.getElementById('to').style.display='inline-block';
        document.getElementById('applyCustom').style.display='inline-block';
      } else {
        document.getElementById('from').style.display='none';
        document.getElementById('to').style.display='none';
        document.getElementById('applyCustom').style.display='none';
        render(k);
      }
    }));

    // Apply custom (for now just treats as 14d demo)
    document.getElementById('applyCustom').onclick = ()=>{
      render('30d');
    };

    // Initial
    render('7d');

    // SW (optional)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').catch(()=>{});
    }
  </script>
</body>
</html>
