<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sales Analytics ‚Äì Dr. Charan Hospital</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=31"/>
  <style>
    .section{margin:12px}
    .tint{border-radius:16px;padding:16px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,.08)}
    .tint-blue   {background:color-mix(in srgb,#2563eb 22%,var(--card-bg))}
    .tint-purple {background:color-mix(in srgb,#8b5cf6 20%,var(--card-bg))}
    .tint-green  {background:color-mix(in srgb,#22c55e 20%,var(--card-bg))}
    .tint-rose   {background:color-mix(in srgb,#f43f5e 20%,var(--card-bg))}
    .tint-sky    {background:color-mix(in srgb,#06b6d4 20%,var(--card-bg))}
    html[data-theme="dark"] .tint{border-color:rgba(255,255,255,.10)}

    .filters{display:flex;gap:10px;flex-wrap:wrap}
    .filters .chip.is-active{outline:2px solid var(--accent)}

    .kpi-grid{display:grid;gap:14px;grid-template-columns:1fr}
    @media(min-width:760px){.kpi-grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:1024px){.kpi-grid{grid-template-columns:repeat(4,1fr)}}

    .kpi{border-radius:16px;padding:16px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,.08)}
    .kpi h4{font-size:14px;margin-bottom:6px}
    .kpi .num{font-size:28px;font-weight:800}
    html[data-theme="dark"] .kpi{border-color:rgba(255,255,255,.10)}

    .grid{display:grid;gap:14px;grid-template-columns:1fr}
    @media(min-width:860px){.grid{grid-template-columns:1fr 1fr}}

    .card-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    canvas{width:100%;height:280px}
  </style>
</head>
<body>
  <!-- Banner -->
  <header class="banner">
    <button id="themeToggle" class="chip floating-toggle">üåô</button>
  </header>

  <!-- Toolbar -->
  <nav class="fixed-actions">
    <a class="chip" href="dashboard.html">‚Üê Dashboard</a>
    <button id="logoutBtn" class="chip">Logout</button>
    <button id="clearCacheBtn" class="chip">Clear Cache</button>
  </nav>

  <!-- Filters -->
  <section class="section tint tint-blue">
    <div class="card-title">
      <h2>Sales Analytics</h2>
      <div class="filters" id="rangeChips">
        <button class="chip is-active" data-range="7d">7D</button>
        <button class="chip" data-range="30d">30D</button>
        <button class="chip" data-range="ytd">YTD</button>
      </div>
    </div>
  </section>

  <!-- KPIs -->
  <section class="section">
    <div class="kpi-grid">
      <div class="kpi tint-blue"><h4>Total (‚Çπ)</h4><div class="num" id="kpiTotal">0</div></div>
      <div class="kpi tint-purple"><h4>Avg / Day (‚Çπ)</h4><div class="num" id="kpiAvg">0</div></div>
      <div class="kpi tint-green"><h4>Invoices</h4><div class="num" id="kpiInv">0</div></div>
      <div class="kpi tint-rose"><h4>Top Item</h4><div class="num" id="kpiTop">‚Äî</div></div>
    </div>
  </section>

  <!-- Charts -->
  <section class="section grid">
    <div class="tint tint-sky">
      <div class="card-title"><h3>Revenue by Day</h3><span id="lblSpan"></span></div>
      <canvas id="revChart"></canvas>
    </div>
    <div class="tint tint-purple">
      <div class="card-title"><h3>Top Items</h3><span>Selected period</span></div>
      <canvas id="pieChart"></canvas>
    </div>
  </section>

  <script src="assets/chart.umd.min.js"></script>
  <script type="module">
    // === Theme toggle
    const tt=document.getElementById('themeToggle');
    if(localStorage.theme){document.documentElement.dataset.theme=localStorage.theme;tt.textContent=localStorage.theme==='light'?'üåû':'üåô'}
    tt.onclick=()=>{const cur=document.documentElement.dataset.theme||'light';const next=cur==='light'?'dark':'light';document.documentElement.dataset.theme=next;localStorage.theme=next;tt.textContent=next==='light'?'üåû':'üåô';applyChartTheme()}

    // Session guard
    const s=JSON.parse(localStorage.getItem('session')||'{}');
    if(!s.role) location.replace('login.html');

    logoutBtn.onclick=()=>{localStorage.removeItem('session');location.href='login.html'};
    clearCacheBtn.onclick=async()=>{localStorage.clear();if('caches'in window){const ks=await caches.keys();await Promise.all(ks.map(k=>caches.delete(k)))};location.reload()}

    // Helpers
    function fmt(n){return (Number(n)||0).toFixed(2)}
    function getInvoices(){try{return JSON.parse(localStorage.getItem('invoices')||'[]')}catch{return[]}}
    function startOfDay(d){const x=new Date(d);x.setHours(0,0,0,0);return x}

    // Charts
    let revChart,pieChart;
    function makeCharts(labels,revData,pieLabels,pieVals){
      if(revChart) revChart.destroy();
      if(pieChart) pieChart.destroy();
      revChart=new Chart(document.getElementById('revChart'),{
        type:'line',
        data:{labels,datasets:[{label:'Revenue (‚Çπ)',data:revData,tension:.35,borderWidth:2}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
      });
      pieChart=new Chart(document.getElementById('pieChart'),{
        type:'pie',
        data:{labels:pieLabels,datasets:[{data:pieVals}]},
        options:{responsive:true,maintainAspectRatio:false}
      });
      applyChartTheme();
    }

    // Apply theme colors
    function applyChartTheme(){
      const fg=getComputedStyle(document.documentElement).getPropertyValue('--fg')||'#111';
      const grid=(document.documentElement.dataset.theme==='dark')?'rgba(255,255,255,.1)':'rgba(0,0,0,.08)';
      if(revChart){
        revChart.options.scales.x.ticks={color:fg};
        revChart.options.scales.y.ticks={color:fg};
        revChart.options.scales.x.grid={color:grid};
        revChart.options.scales.y.grid={color:grid};
        revChart.update('none');
      }
      if(pieChart){
        pieChart.options.plugins.legend.labels={color:fg};
        pieChart.update('none');
      }
    }

    // Summarize
    function summarize(range){
      const inv=getInvoices();const now=new Date();let from;
      if(range==='7d'){from=new Date(now);from.setDate(now.getDate()-6);from=startOfDay(from)}
      else if(range==='30d'){from=new Date(now);from.setDate(now.getDate()-29);from=startOfDay(from)}
      else if(range==='ytd'){from=new Date(now.getFullYear(),0,1)}
      else from=startOfDay(now);
      const fromISO=from.toISOString().slice(0,10),toISO=now.toISOString().slice(0,10);
      document.getElementById('lblSpan').textContent=`${fromISO} ‚Üí ${toISO}`;
      const picked=inv.filter(i=>{const d=i.date||new Date(i.ts||Date.now()).toISOString().slice(0,10);return d>=fromISO&&d<=toISO});
      const total=picked.reduce((s,i)=>s+(+i.total||0),0);
      const days=Math.max(1,Math.round((startOfDay(now)-from)/86400000)+1);
      const avg=total/days;
      document.getElementById('kpiTotal').textContent=fmt(total);
      document.getElementById('kpiAvg').textContent=fmt(avg);
      document.getElementById('kpiInv').textContent=picked.length;
      const items={};
      picked.forEach(i=>(i.items||[]).forEach(it=>{
        const k=it.name||'‚Äî';items[k]=(items[k]||0)+(Number(it.price)||0)*(Number(it.qty)||1)}));
      const top=Object.entries(items).sort((a,b)=>b[1]-a[1])[0]?.[0]||'‚Äî';
      document.getElementById('kpiTop').textContent=top;
      const dayMap={};for(let d=new Date(from);d<=now;d.setDate(d.getDate()+1)){dayMap[d.toISOString().slice(0,10)]=0}
      picked.forEach(i=>{const d=i.date||new Date(i.ts||Date.now()).toISOString().slice(0,10);if(dayMap[d]!=null)dayMap[d]+=+i.total||0});
      makeCharts(Object.keys(dayMap),Object.values(dayMap),Object.keys(items),Object.values(items));
    }

    // Range chips
    document.querySelectorAll('#rangeChips .chip').forEach(c=>{
      c.onclick=()=>{document.querySelectorAll('#rangeChips .chip').forEach(x=>x.classList.remove('is-active'));c.classList.add('is-active');summarize(c.dataset.range)}
    });
    summarize('7d');

    if('serviceWorker'in navigator){navigator.serviceWorker.register('service-worker.js').catch(()=>{})}
  </script>
</body>
</html>
