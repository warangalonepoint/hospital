<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Analytics ‚Äì Dr. Charan Hospital</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=18"/>
  <script defer src="assets/chart.umd.min.js"></script>
</head>
<body>
  <header class="banner">
    <button id="themeToggle" class="chip floating-toggle" aria-label="Theme">üåô</button>
  </header>

  <nav class="fixed-actions">
    <a class="chip" href="dashboard.html">‚Üê Dashboard</a>
    <button id="logoutBtn" class="chip">Logout</button>
    <button id="clearCacheBtn" class="chip">Clear Cache</button>
  </nav>

  <section class="section">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <h1>Sales Analytics</h1>
      <div class="range">
        <button class="chip active" data-range="7d">7D</button>
        <button class="chip" data-range="30d">30D</button>
        <button class="chip" data-range="ytd">YTD</button>
        <button class="chip" data-range="custom" id="btnCustom">Custom</button>
        <input id="from" type="date" class="input" style="width:auto;display:none;">
        <input id="to"   type="date" class="input" style="width:auto;display:none;">
        <button id="applyCustom" class="btn" style="display:none;">Apply</button>
      </div>
    </div>

    <div class="card-grid" style="margin-top:10px">
      <div class="card" style="background:var(--blue);"><h2>Total (‚Çπ)</h2><p id="mTotal">0.00</p></div>
      <div class="card" style="background:var(--lilac);"><h2>Avg / Day (‚Çπ)</h2><p id="mAvg">0.00</p></div>
      <div class="card" style="background:var(--mint);"><h2>Invoices</h2><p id="mInv">0</p></div>
      <div class="card" style="background:var(--peach);"><h2>Top Item</h2><p id="mTop">‚Äî</p></div>
    </div>

    <div class="section" style="margin:16px 0;">
      <h2>Revenue by Day</h2>
      <canvas id="line"></canvas>
    </div>

    <div class="section">
      <h2>Top Items</h2>
      <canvas id="pie"></canvas>
    </div>
  </section>

  <script type="module">
    // theme
    const t=document.getElementById('themeToggle');
    if(localStorage.theme){ document.documentElement.dataset.theme=localStorage.theme; t.textContent=localStorage.theme==='light'?'üåû':'üåô'; }
    t.onclick=()=>{ const cur=document.documentElement.dataset.theme||'light'; const next=cur==='light'?'dark':'light'; document.documentElement.dataset.theme=next; localStorage.theme=next; t.textContent=next==='light'?'üåû':'üåô'; };

    // guard: doctor only
    const ses=JSON.parse(localStorage.getItem('session')||'{}');
    if(ses.role!=='doctor'){ location.href='login.html'; }

    // actions
    document.getElementById('logoutBtn').onclick=()=>{ localStorage.removeItem('session'); location.href='login.html'; };
    document.getElementById('clearCacheBtn').onclick=async()=>{
      try{
        localStorage.clear();
        if('caches' in window){ const ks=await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k))); }
        if('serviceWorker' in navigator){ const regs=await navigator.serviceWorker.getRegistrations(); for(const r of regs) await r.unregister(); }
        alert('Cache cleared. Reloading‚Ä¶'); location.reload();
      }catch(e){ alert('Could not fully clear cache.'); }
    };

    // chips active state
    const chips=[...document.querySelectorAll('.range [data-range]')];
    function markActive(btn){ chips.forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
    chips.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if(btn.dataset.range==='custom') return;
        markActive(btn);
        loadRange(btn.dataset.range);
      });
    });

    // custom flow
    const btnCustom=document.getElementById('btnCustom');
    const from=document.getElementById('from');
    const to=document.getElementById('to');
    const apply=document.getElementById('applyCustom');
    btnCustom.addEventListener('click', ()=>{
      from.style.display=to.style.display=apply.style.display='inline-block';
    });
    apply.addEventListener('click', ()=>{
      markActive(btnCustom);
      loadRange('custom',{from:from.value,to:to.value});
    });

    // charts
    let lineChart, pieChart;
    function renderCharts(days, items){
      const ctx1=document.getElementById('line'); const ctx2=document.getElementById('pie');
      lineChart?.destroy(); pieChart?.destroy();
      lineChart=new Chart(ctx1,{type:'line',data:{labels:days.map(d=>d.label), datasets:[{data:days.map(d=>d.total)}]}});
      pieChart =new Chart(ctx2,{type:'pie', data:{labels:items.map(i=>i.name), datasets:[{data:items.map(i=>i.total)}]}} );
    }

    // stubbed aggregator (still reads from localStorage store format)
    function getSalesBetween(start,end){
      const store=JSON.parse(localStorage.getItem('sales')||'[]');
      return store.filter(r=>r.date>=start && r.date<=end);
    }
    function sum(arr,fn){ return arr.reduce((a,b)=>a+fn(b),0); }

    function loadRange(key,opts={}){
      const now=new Date(); let start,end;
      if(key==='7d'){ end=new Date(); start=new Date(); start.setDate(end.getDate()-6); }
      else if(key==='30d'){ end=new Date(); start=new Date(); start.setDate(end.getDate()-29); }
      else if(key==='ytd'){ end=new Date(); start=new Date(end.getFullYear(),0,1); }
      else { start=new Date(opts.from||now); end=new Date(opts.to||now); }

      const s=start.toISOString().slice(0,10), e=end.toISOString().slice(0,10);
      const rows=getSalesBetween(s,e);
      const total=sum(rows,r=>+r.total||0);
      const days=Math.max(1, Math.ceil((end-start)/86400000)+1);
      const byDay={}; rows.forEach(r=>{ byDay[r.date]=(byDay[r.date]||0)+(+r.total||0); });
      const labels=[]; for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){ labels.push(d.toISOString().slice(0,10)); }
      const daySeries=labels.map(lbl=>({label:lbl,total:byDay[lbl]||0}));

      const byItem={}; rows.forEach(r=> (r.items||[]).forEach(i=>{ byItem[i.name]=(byItem[i.name]||0)+((+i.qty||0)*(+i.price||0)); }));
      const items=Object.entries(byItem).map(([name,total])=>({name,total}));

      document.getElementById('mTotal').textContent=total.toFixed(2);
      document.getElementById('mAvg').textContent=(total/days).toFixed(2);
      document.getElementById('mInv').textContent=rows.length;
      document.getElementById('mTop').textContent=(items.sort((a,b)=>b.total-a.total)[0]?.name)||'‚Äî';

      renderCharts(daySeries, items.slice(0,6));
    }

    // initial
    loadRange('7d');
  </script>
</body>
</html>
