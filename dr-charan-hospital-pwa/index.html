<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dr. Charan Hospital ‚Äì Portal</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=26"/>
</head>
<body>
  <div class="wrap">
    <!-- Banner -->
    <header class="banner">
      <button id="themeToggle" class="chip floating-toggle" aria-label="Theme">üåô</button>
    </header>

    <!-- Actions -->
    <nav class="toolbar">
      <a class="chip" href="login.html">üîê Login</a>
      <button id="clearCacheBtn" class="chip">Clear Cache</button>
    </nav>

    <!-- Welcome -->
    <section class="section">
      <h2>Welcome</h2>
      <div class="tile-grid">
        <a class="tile panel--lilac" href="dashboard.html">
          <h3>Doctor Dashboard</h3>
          <p>Patients, follow-ups, analytics (read-only staff view)</p>
        </a>
        <a class="tile panel--mint" href="admin.html">
          <h3>Supervisor Console</h3>
          <p>Bookings, Pharmacy Billing & Reports, Staff (edit)</p>
        </a>
      </div>
      <p class="muted mt12">
        Tip: use PIN <b>4321</b> for Doctor, <b>1111</b> for Supervisor (demo).
      </p>
    </section>

    <!-- System Check -->
    <section class="section tint tint-lilac">
      <h3>System Check</h3>
      <p id="syscheck-status">‚è≥ Checking Supabase connection...</p>
    </section>
  </div>

  <script type="module">
    // === Theme toggle
    const t = document.getElementById('themeToggle');
    if (localStorage.theme) {
      document.documentElement.dataset.theme = localStorage.theme;
      t.textContent = localStorage.theme === 'light' ? 'üåû' : 'üåô';
    }
    t.onclick = () => {
      const cur = document.documentElement.dataset.theme || 'light';
      const next = cur === 'light' ? 'dark' : 'light';
      document.documentElement.dataset.theme = next;
      localStorage.theme = next;
      t.textContent = next === 'light' ? 'üåû' : 'üåô';
    };

    // === Clear cache
    document.getElementById('clearCacheBtn').onclick = async () => {
      localStorage.clear();
      sessionStorage.clear();
      if ('caches' in window) {
        const ks = await caches.keys();
        await Promise.all(ks.map(k => caches.delete(k)));
      }
      alert('Cache cleared. Reloading‚Ä¶');
      location.reload();
    };
  </script>

  <!-- ===== Supabase System Check (correct path: ./config.js) ===== -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from './config.js';  // <-- fixed import

    const statusEl = document.getElementById('syscheck-status');

    // Helper: timeout so it never spins forever
    async function withTimeout(promise, ms, label='operation') {
      let timer;
      const t = new Promise((_, rej) => {
        timer = setTimeout(() => rej(new Error(`${label} timed out after ${ms}ms`)), ms);
      });
      try {
        const res = await Promise.race([promise, t]);
        clearTimeout(timer);
        return res;
      } catch (e) {
        clearTimeout(timer);
        throw e;
      }
    }

    async function checkSupabase() {
      try {
        // Basic sanity
        if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
          throw new Error('Missing SUPABASE_URL or SUPABASE_ANON_KEY in ./config.js');
        }

        const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Small SELECT to ensure RLS + CORS are OK
        const { data, error } = await withTimeout(
          sb.from('staff').select('id').limit(1),
          7000,
          'Supabase query'
        );

        if (error) throw error;

        statusEl.textContent = '‚úÖ Connected to Supabase';
        statusEl.style.color = 'green';
      } catch (err) {
        console.error('System Check failed:', err);
        let hint = '';
        const msg = (err?.message || '').toLowerCase();
        if (msg.includes('timed out')) {
          hint = 'Likely CORS. Add https://warangalonepoint.github.io in Settings ‚Üí API ‚Üí Allowed CORS origins.';
        } else if (msg.includes('missing supabase_url') || msg.includes('anon')) {
          hint = 'Open ./config.js and fill SUPABASE_URL + SUPABASE_ANON_KEY.';
        }
        statusEl.textContent = `‚ùå Connection failed. ${hint || 'Open Console for details.'}`;
        statusEl.style.color = 'red';
      }
    }

    checkSupabase();
  </script>
</body>
</html>
