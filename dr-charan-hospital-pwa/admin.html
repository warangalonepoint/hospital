<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Supervisor ‚Äì Dr. Charan Hospital</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=63"/>
  <style>
    .wrap{max-width:1120px;margin:0 auto}
    .section{margin:12px}
    .tile-grid{display:grid;gap:16px;grid-template-columns:1fr}
    @media(min-width:760px){.tile-grid{grid-template-columns:1fr 1fr}}
    .tile{border-radius:18px;padding:22px;text-align:center;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,.06);text-decoration:none;color:inherit;display:block}
    .tile h3{font-size:22px;margin-bottom:6px;text-decoration:underline;text-underline-offset:4px}
    .tile p{color:var(--muted)}
    .kpi-grid{display:grid;gap:14px;grid-template-columns:1fr}
    @media(min-width:720px){.kpi-grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:1024px){.kpi-grid{grid-template-columns:repeat(4,1fr)}}
    .kpi{border-radius:16px;padding:16px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,.06)}
    .kpi h4{font-size:14px;opacity:.85;margin-bottom:6px}.kpi .num{font-size:28px;font-weight:800}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="banner"><button id="themeToggle" class="floating-toggle" aria-label="Theme">üåô</button></header>

    <nav class="fixed-actions">
      <a class="chip" href="login.html">‚Üê Login</a>
      <button id="logoutBtn" class="chip">Logout</button>
      <button id="clearCacheBtn" class="chip">Clear Cache</button>
    </nav>

    <section class="section">
      <div class="tile-grid">
        <a class="tile panel--lilac" href="bookings.html"><h3>Bookings</h3><p>Create tokens & manage appointments</p></a>
        <a class="tile panel--mint" href="pharmacy.html"><h3>Pharmacy ‚Äì Billing</h3><p>Multi-item invoices, discounts, payments</p></a>
        <a class="tile panel--peach" href="pharmacy-report.html" style="grid-column:1/-1"><h3>Pharmacy ‚Äì Reports</h3><p>Daily / Weekly / Monthly / Yearly sales & items</p></a>
        <a class="tile panel--rose" href="admin-staff.html" style="grid-column:1/-1"><h3>Staff ‚Äì Attendance & Roster</h3><p>Create day sheet, mark, edit, export</p></a>
      </div>
    </section>

    <section class="section panel--blue">
      <h2 style="font-size:22px;margin-bottom:8px">Today Snapshot</h2>
      <div class="kpi-grid">
        <div class="kpi panel--blue"><h4>Today (‚Çπ)</h4><div class="num" id="todayAmt">0.00</div></div>
        <div class="kpi panel--mint"><h4>This Month (‚Çπ)</h4><div class="num" id="mtdAmt">0.00</div></div>
        <div class="kpi panel--lilac"><h4>Top Item (Today)</h4><div class="num" id="topItem">‚Äî</div></div>
        <div class="kpi panel--peach"><h4>Invoices (Today)</h4><div class="num" id="invCnt">0</div></div>
      </div>
      <div class="fine muted" id="dateLabel" style="margin-top:8px"></div>
    </section>
  </div>

  <script>
    // Theme
    const t=document.getElementById('themeToggle');
    if(localStorage.theme){ document.documentElement.dataset.theme=localStorage.theme; t.textContent=localStorage.theme==='light'?'üåû':'üåô'; }
    t.onclick=()=>{ const cur=document.documentElement.dataset.theme||'light'; const next=cur==='light'?'dark':'light'; document.documentElement.dataset.theme=next; localStorage.theme=next; t.textContent=next==='light'?'üåû':'üåô'; };

    // Guard (supervisor only)
    const sess = JSON.parse(localStorage.getItem('session')||'{}');
    if(!sess.role) location.replace('login.html');
    if(sess.role!=='supervisor') location.replace(sess.role==='doctor'?'dashboard.html':'portal.html');

    // Actions
    logoutBtn.onclick=()=>{ localStorage.removeItem('session'); location.href='login.html'; };
    clearCacheBtn.onclick=async()=>{ localStorage.clear(); sessionStorage.clear(); if('caches' in window){ const ks=await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k))); } alert('Cleared. Reloading‚Ä¶'); location.reload(); };

    // Snapshot (local fallback)
    function fmt(n){ return (Number(n)||0).toFixed(2); }
    function iso(d){ return new Date(d).toISOString().slice(0,10); }
    function getInvoicesAll(){ try{return JSON.parse(localStorage.getItem('invoices')||'[]')}catch{return[]} }
    function sumLines(items){ return (items||[]).reduce((s,it)=> s + (Number(it.price)||0)*(Number(it.qty)||1), 0); }

    (async function render(){
      document.getElementById('dateLabel').textContent = iso(new Date());
      const invoices = await getInvoicesAll();
      const todayISO = iso(new Date());
      const monthStartISO = iso(new Date(new Date().getFullYear(), new Date().getMonth(), 1));
      const todays = invoices.filter(i => (i.date || iso(i.ts||Date.now())) === todayISO);
      const mtd    = invoices.filter(i => (i.date || iso(i.ts||Date.now())) >= monthStartISO);
      const todayAmt = todays.reduce((s,i)=> s + (Number(i.total)||sumLines(i.items||[])), 0);
      const mtdAmt   = mtd.reduce((s,i)=> s + (Number(i.total)||sumLines(i.items||[])), 0);
      const map = {}; todays.forEach(inv=> (inv.items||[]).forEach(it=>{ const n=it.name||it.item||'‚Äî'; const line=(+it.price||0)*(+it.qty||1); map[n]=(map[n]||0)+line; }));
      const topItem = Object.entries(map).sort((a,b)=>b[1]-a[1])[0]?.[0] || '‚Äî';
      todayAmt?0:0;
      document.getElementById('todayAmt').textContent = fmt(todayAmt);
      document.getElementById('mtdAmt').textContent   = fmt(mtdAmt);
      document.getElementById('topItem').textContent  = topItem;
      document.getElementById('invCnt').textContent   = todays.length;
    })();

    if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(()=>{}) }
  </script>

  <!-- Supabase quiet status chip -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module">
    import { SUPABASE_URL, SUPABASE_ANON } from './config.js';
    window.sb = window.sb || supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
    const host=document.querySelector('.fixed-actions')||document.body, pill=document.createElement('span');
    pill.textContent='Supabase: Checking‚Ä¶'; pill.style.cssText='display:inline-block;margin:6px 8px;padding:8px 12px;border-radius:999px;border:1px solid rgba(0,0,0,.12);background:var(--card-bg);box-shadow:var(--shadow);font-size:13px';
    if(host===document.body) Object.assign(pill.style,{position:'fixed',left:'12px',bottom:'12px',zIndex:'9999'}); host.appendChild(pill);
    (async()=>{ try{ const {error}=await sb.from('invoices').select('id').limit(1); if(error) throw error; pill.textContent='Supabase: OK'; pill.style.borderColor='rgba(22,163,74,.35)'; }
      catch(e){ console.error(e); pill.textContent='Supabase: FAIL'; pill.style.borderColor='rgba(220,38,38,.45)'; } })();
  </script>
</body>
</html>
