<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Pharmacy ‚Äì Billing</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="stylesheet" href="styles.css?v=13"/>
</head>
<body>
  <!-- Banner with embedded logo/text -->
  <header class="banner clean"></header>
  <button id="themeToggle" class="chip floating-toggle">üåô</button>

  <!-- Tabs -->
  <section class="container n8" style="margin-top:12px;margin-bottom:-6px">
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="chip" id="tabBilling">Billing</button>
      <button class="chip" id="tabRecords">Records</button>
    </div>
  </section>

  <main class="container n8">
    <!-- ===== BILLING PANEL ===== -->
    <div id="panelBilling">
      <!-- Top actions -->
      <section class="card" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between">
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <a href="dashboard.html?v=13" class="chip">‚Üê Dashboard</a>
          <button id="clearCacheBtn" class="btn">Clear Cache</button>
          <button id="logoutBtn" class="btn">Logout</button>
        </div>
        <div class="subtitle">Supervisor billing ‚Ä¢ Multi-item invoices</div>
      </section>

      <!-- Invoice header -->
      <section class="card" id="invHeader">
        <div class="form-grid">
          <div class="field"><label>Invoice #</label><input id="invNumber" disabled/></div>
          <div class="field"><label>Date</label><input id="invDate" type="date"/></div>
          <div class="field"><label>Doctor (optional)</label><input id="invDoctor" placeholder="Dr. Name"/></div>
          <div class="field"><label>Patient Name</label><input id="invPatient" placeholder="Full name"/></div>
          <div class="field"><label>Patient Phone</label><input id="invPhone" inputmode="tel" placeholder="10-digit"/></div>
          <div class="field" style="align-items:end"><button id="newInvoice" class="btn">New Invoice</button></div>
        </div>
      </section>

      <!-- Items table -->
      <section class="card" id="itemsCard">
        <h3 style="margin:0 0 10px">Items</h3>
        <div class="table-wrap">
          <table class="table" id="itemsTbl">
            <thead>
              <tr>
                <th style="min-width:140px">Item</th><th>Batch</th><th>Expiry</th>
                <th>Qty</th><th>Rate</th><th>Disc %</th><th>Disc ‚Çπ</th><th>GST %</th><th>Amount</th><th></th>
              </tr>
            </thead>
            <tbody id="itemRows"></tbody>
            <tfoot>
              <tr>
                <td><input id="add_name" placeholder="Paracetamol 650"></td>
                <td><input id="add_batch" placeholder=""></td>
                <td><input id="add_expiry" placeholder="2026-06"></td>
                <td><input id="add_qty" type="number" min="1" value="1"></td>
                <td><input id="add_rate" type="number" step="0.01"></td>
                <td><input id="add_discPct" type="number" step="0.01" value="0"></td>
                <td><input id="add_discAbs" type="number" step="0.01" value="0"></td>
                <td><input id="add_gst" type="number" step="0.01" value="0"></td>
                <td colspan="2"><button id="addItemBtn" class="btn">+ Add Item</button></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </section>

      <!-- Totals -->
      <section class="card" id="totalsCard">
        <div class="form-grid">
          <div class="field"><label>Invoice Discount %</label><input id="invDiscPct" type="number" step="0.01" value="0"></div>
          <div class="field"><label>Invoice Discount ‚Çπ</label><input id="invDiscAbs" type="number" step="0.01" value="0"></div>
          <div class="field"><label>Total ‚Çπ</label><input id="invTotal" disabled></div>
          <div class="field"><label>Paid ‚Çπ</label><input id="invPaid" type="number" step="0.01" value="0"></div>
          <div class="field"><label>Balance ‚Çπ</label><input id="invBalance" disabled></div>
          <div class="field" style="align-items:end">
            <button id="saveDraft" class="chip">Save Draft</button>
            <button id="finalize" class="btn">Finalize & Save</button>
          </div>
        </div>
      </section>

      <!-- Invoices list (quick glance) -->
      <section class="card">
        <h3 style="margin:0 0 10px">Invoices</h3>
        <div class="table-wrap">
          <table class="table" id="invTbl">
            <thead><tr><th>#</th><th>Date</th><th>Patient</th><th>Lines</th><th>Total</th><th>Paid</th><th>Balance</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- ===== RECORDS PANEL ===== -->
    <div id="panelRecords" style="display:none">
      <section class="card">
        <h3 style="margin:0 0 10px">Records</h3>
        <div class="form-grid">
          <div class="field"><label>From</label><input type="date" id="recFrom"></div>
          <div class="field"><label>To</label><input type="date" id="recTo"></div>
          <div class="field" style="align-items:end"><button class="btn" id="recLoad">Load</button></div>
        </div>
      </section>

      <section class="card">
        <div class="table-wrap">
          <table class="table" id="recTbl">
            <thead>
              <tr>
                <th>#</th><th>Date</th><th>Patient</th><th>Lines</th>
                <th>Total ‚Çπ</th><th>Paid ‚Çπ</th><th>Balance ‚Çπ</th><th>Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>
  </main>

  <footer style="text-align:center;color:var(--muted);margin:20px 0 40px">
    Billing v1 ‚Ä¢ Supervisor only
  </footer>

  <script type="module">
    import {
      currentUser, logout,
      newDraftInvoice, getInvoice, listInvoices,
      addLine, updateLine, removeLine,
      setInvoiceDiscounts, finalizeInvoice
    } from './js/store.js?v=12';

    // Theme toggle
    const tbtn=document.getElementById('themeToggle');
    if(localStorage.theme){document.documentElement.setAttribute('data-theme',localStorage.theme);tbtn.textContent=localStorage.theme==='light'?'üåû':'üåô';}
    tbtn.onclick=()=>{const cur=document.documentElement.getAttribute('data-theme')||'light';const next=cur==='light'?'dark':'light';document.documentElement.setAttribute('data-theme',next);localStorage.theme=next;tbtn.textContent=next==='light'?'üåû':'üåô';};

    // Auth: SUPERVISOR ONLY
    const u = currentUser();
    if(!u){ location.href='login.html?v=13'; }
    if(u?.role!=='supervisor'){ alert('Billing is supervisor-only'); location.href='dashboard.html?v=13'; }

    const $ = s=>document.querySelector(s);

    // Tabs
    const panelBilling=$('#panelBilling'), panelRecords=$('#panelRecords');
    $('#tabBilling').onclick=()=>{panelBilling.style.display='block';panelRecords.style.display='none';};
    $('#tabRecords').onclick=()=>{panelBilling.style.display='none';panelRecords.style.display='block';};

    // Clear cache + Logout
    $('#clearCacheBtn').onclick=async()=>{
      localStorage.clear();
      if('caches'in window){const ks=await caches.keys();await Promise.all(ks.map(k=>caches.delete(k)));}
      if('serviceWorker'in navigator){const rs=await navigator.serviceWorker.getRegistrations();for(const r of rs)await r.unregister();}
      alert('Cache cleared. Reloading‚Ä¶');location.reload(true);
    };
    $('#logoutBtn').onclick=()=>{ logout(); location.href='login.html?v=13'; };

    // State
    let curId=null;

    // New invoice
    $('#newInvoice').onclick=()=>{
      const inv=newDraftInvoice({});
      curId=inv.id; hydrate(inv); renderList();
    };

    // Add item
    $('#addItemBtn').onclick=()=>{
      if(!curId){alert('Create an invoice first');return;}
      const row={
        name:$('#add_name').value.trim(),
        batch:$('#add_batch').value.trim(),
        expiry:$('#add_expiry').value.trim(),
        qty:+$('#add_qty').value||0,
        rate:+$('#add_rate').value||0,
        discountPct:+$('#add_discPct').value||0,
        discountAbs:+$('#add_discAbs').value||0,
        gstPct:+$('#add_gst').value||0
      };
      if(!row.name||row.qty<=0||row.rate<0){alert('Enter item, qty, rate');return;}
      addLine(curId,row); hydrate(getInvoice(curId));
      $('#add_qty').value=1; $('#add_rate').value='';
    };

    // Invoice discounts
    $('#invDiscPct').onchange=()=>{if(curId){setInvoiceDiscounts(curId,{discPct:+$('#invDiscPct').value||0,discAbs:+$('#invDiscAbs').value||0});hydrate(getInvoice(curId));}};
    $('#invDiscAbs').onchange=()=>{if(curId){setInvoiceDiscounts(curId,{discPct:+$('#invDiscPct').value||0,discAbs:+$('#invDiscAbs').value||0});hydrate(getInvoice(curId));}};

    // Save/Finalize
    $('#saveDraft').onclick=()=>{if(!curId){alert('No invoice');return;}alert('Draft saved');renderList();};
    $('#finalize').onclick=()=>{if(!curId){alert('No invoice');return;}finalizeInvoice(curId,{paid:+($('#invPaid').value||0)});hydrate(getInvoice(curId));renderList();alert('Invoice finalized');};

    // Hydrate current invoice
    function hydrate(inv){
      if(!inv) return;
      $('#invNumber').value=inv.number; $('#invDate').value=inv.date;
      $('#invDoctor').value=inv.doctorName||''; $('#invPatient').value=inv.patientName||''; $('#invPhone').value=inv.patientPhone||'';
      $('#invDiscPct').value=inv.discPct||0; $('#invDiscAbs').value=inv.discAbs||0;
      $('#invTotal').value=(inv.total||0).toFixed(2); $('#invPaid').value=inv.paid||0; $('#invBalance').value=(inv.balance||0).toFixed(2);

      const tb=$('#itemRows'); tb.innerHTML='';
      for(const ln of inv.items){
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td><input value="${ln.name||''}" data-k="name" data-id="${ln.id}"></td>
          <td><input value="${ln.batch||''}" data-k="batch" data-id="${ln.id}"></td>
          <td><input value="${ln.expiry||''}" data-k="expiry" data-id="${ln.id}"></td>
          <td><input type="number" step="1" min="1" value="${ln.qty||0}" data-k="qty" data-id="${ln.id}"></td>
          <td><input type="number" step="0.01" value="${ln.rate||0}" data-k="rate" data-id="${ln.id}"></td>
          <td><input type="number" step="0.01" value="${ln.discountPct||0}" data-k="discountPct" data-id="${ln.id}"></td>
          <td><input type="number" step="0.01" value="${ln.discountAbs||0}" data-k="discountAbs" data-id="${ln.id}"></td>
          <td><input type="number" step="0.01" value="${ln.gstPct||0}" data-k="gstPct" data-id="${ln.id}"></td>
          <td>${(ln.amount||0).toFixed(2)}</td>
          <td><button class="chip" data-del="${ln.id}">‚úï</button></td>`;
        tb.appendChild(tr);
      }
      tb.querySelectorAll('input[data-id]').forEach(inp=>{
        inp.onchange=()=>{
          const k=inp.dataset.k,id=inp.dataset.id;
          const val=(k==='name'||k==='batch'||k==='expiry')?inp.value:+inp.value||0;
          updateLine(inv.id,id,{[k]:val}); hydrate(getInvoice(inv.id));
        };
      });
      tb.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.onclick=()=>{removeLine(inv.id,btn.dataset.del);hydrate(getInvoice(inv.id));};
      });
    }

    // Quick list under Billing
    function renderList(){
      const tbody=document.querySelector('#invTbl tbody'); tbody.innerHTML='';
      for(const i of listInvoices()){
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${i.number}</td><td>${i.date}</td><td>${i.patientName||''}</td>
                      <td>${i.items.length}</td><td>${(i.total||0).toFixed(2)}</td>
                      <td>${(i.paid||0).toFixed(2)}</td><td>${(i.balance||0).toFixed(2)}</td><td>${i.status}</td>`;
        tbody.appendChild(tr);
      }
    }

    // Records panel
    function recDefaultDates(){
      const today=new Date().toISOString().slice(0,10);
      const first=new Date(); first.setDate(first.getDate()-7);
      $('#recFrom').value=first.toISOString().slice(0,10);
      $('#recTo').value=today;
    }
    recDefaultDates();

    function loadRecords(){
      const from=$('#recFrom').value||''; const to=$('#recTo').value||'';
      const rows=listInvoices({from,to});
      const tbody=document.querySelector('#recTbl tbody'); tbody.innerHTML='';
      for(const i of rows){
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${i.number}</td><td>${i.date}</td><td>${i.patientName||''}</td>
                      <td>${i.items.length}</td><td>${(i.total||0).toFixed(2)}</td>
                      <td>${(i.paid||0).toFixed(2)}</td><td>${(i.balance||0).toFixed(2)}</td><td>${i.status}</td>`;
        tbody.appendChild(tr);
      }
    }
    document.getElementById('recLoad').onclick=loadRecords;

    // Init
    renderList(); loadRecords();
  </script>
</body>
</html>
