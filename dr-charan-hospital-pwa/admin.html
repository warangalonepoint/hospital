<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Supervisor ‚Äì Dr. Charan Hospital</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=14"/>
  <style>
    .floating-actions{position:fixed;top:14px;left:14px;z-index:1000;display:flex;gap:8px;flex-wrap:wrap}
    .big-tile{min-height:120px;display:flex;flex-direction:column;justify-content:center}
    .tabs{display:flex;gap:10px;margin-bottom:12px}
    .tabs .chip.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-top:1px solid var(--border);text-align:left}
    .backlink{margin-bottom:10px;display:inline-flex;gap:6px;align-items:center}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <!-- Banner -->
  <header class="banner clean"></header>

  <!-- Always-visible controls -->
  <div class="floating-actions">
    <a href="login.html" id="logout" class="chip">Logout</a>
    <button id="clearCacheBtn" class="chip">Clear Cache</button>
  </div>
  <button id="themeToggle" class="chip floating-toggle">üåô</button>

  <main class="container n8">

    <!-- SUPERVISOR HOME -->
    <section id="supHome" class="card">
      <div class="tile-grid">
        <a class="tile big-tile bookings" id="openBookings">
          <div class="title">Bookings</div>
          <div class="sub">Create patient appointments</div>
        </a>
        <a class="tile big-tile pharma" id="openPharmacy">
          <div class="title">Pharmacy</div>
          <div class="sub">Billing & records</div>
        </a>
      </div>
      <p class="muted" style="margin-top:12px">Supervisor home ‚Ä¢ choose a module</p>
    </section>

    <!-- PHARMACY HUB (Billing / Records) -->
    <section id="pharmacyHub" class="card" style="display:none">
      <a class="backlink" id="goHome">‚Üê Back to Supervisor Home</a>
      <h3 style="margin:0 0 8px">Pharmacy</h3>
      <div class="tabs">
        <button class="chip active" id="tabBilling">Billing</button>
        <button class="chip" id="tabRecords">Records</button>
      </div>

      <!-- BILLING PANEL (compact demo) -->
      <div id="billingPanel">
        <div class="toolbar">
          <button class="btn" id="newInvoice">New Invoice</button>
          <div class="muted" id="invHint"></div>
        </div>

        <div class="form-grid">
          <div class="field">
            <label>Invoice #</label>
            <input id="invNo" placeholder="Auto"/>
          </div>
          <div class="field">
            <label>Date</label>
            <input id="invDate" type="date"/>
          </div>
          <div class="field">
            <label>Patient Name</label>
            <input id="invPatient" placeholder="Full name"/>
          </div>
          <div class="field">
            <label>Patient Phone</label>
            <input id="invPhone" inputmode="numeric" maxlength="10" placeholder="10-digit"/>
          </div>
        </div>

        <!-- MULTI-ITEM LINES -->
        <div class="toolbar">
          <button class="chip" id="addLine">+ Add Item</button>
          <span class="muted">Add all medicines in one invoice</span>
        </div>
        <div id="lines"></div>

        <div class="form-grid" style="margin-top:8px">
          <div class="field"><label>Invoice Discount %</label><input id="discPct" inputmode="decimal" value="0"/></div>
          <div class="field"><label>Invoice Discount ‚Çπ</label><input id="discAmt" inputmode="decimal" value="0"/></div>
          <div class="field"><label>Paid ‚Çπ</label><input id="paid" inputmode="decimal" value="0"/></div>
          <div class="field"><label>Total ‚Çπ</label><input id="total" disabled/></div>
        </div>

        <div style="display:flex;gap:10px;margin-top:10px">
          <button class="btn" id="saveInvoice">Finalize & Save</button>
          <button class="btn ghost" id="calcTotal">Recalculate</button>
        </div>
      </div>

      <!-- RECORDS PANEL -->
      <div id="recordsPanel" style="display:none">
        <div class="toolbar">
          <input id="recFrom" type="date"/>
          <input id="recTo" type="date"/>
          <button class="chip" id="recFilter">Filter</button>
          <span class="muted" id="recSummary"></span>
        </div>
        <div class="table-wrap">
          <table class="table" id="recTable">
            <thead><tr>
              <th>#</th><th>Date</th><th>Patient</th><th>Lines</th><th>Total ‚Çπ</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
    import { requireRole, listInvoices, listSales, totalsToday, totalsMonth } from './js/store.js?v=21';
    import * as S from './js/store.js?v=21';
    requireRole('supervisor'); // supervisors only

    // Theme toggle
    const tbtn=document.getElementById('themeToggle');
    if(localStorage.theme){ document.documentElement.setAttribute('data-theme', localStorage.theme); tbtn.textContent=localStorage.theme==='light'?'üåû':'üåô'; }
    tbtn.onclick=()=>{ const cur=document.documentElement.getAttribute('data-theme')||'light'; const next=cur==='light'?'dark':'light'; document.documentElement.setAttribute('data-theme',next); localStorage.theme=next; tbtn.textContent=next==='light'?'üåû':'üåô'; };

    // Clear cache
    document.getElementById('clearCacheBtn').onclick=async()=>{
      try{
        localStorage.clear();
        if('caches'in window){const ks=await caches.keys();await Promise.all(ks.map(k=>caches.delete(k)));}
        if('serviceWorker'in navigator){const rs=await navigator.serviceWorker.getRegistrations();for(const r of rs)await r.unregister();}
        alert('Cache cleared. Reloading‚Ä¶'); location.reload(true);
      }catch(e){ console.error(e); alert('Could not clear everything. Try hard reload.'); }
    };

    // Navigation
    const supHome = document.getElementById('supHome');
    const hub = document.getElementById('pharmacyHub');
    const billingPanel = document.getElementById('billingPanel');
    const recordsPanel = document.getElementById('recordsPanel');
    const tabBilling = document.getElementById('tabBilling');
    const tabRecords = document.getElementById('tabRecords');

    document.getElementById('openPharmacy').onclick=()=>{ supHome.style.display='none'; hub.style.display='block'; showBilling(); };
    document.getElementById('openBookings').onclick=()=>{ location.href='patient.html'; };
    document.getElementById('goHome').onclick=()=>{ hub.style.display='none'; supHome.style.display='block'; };

    function showBilling(){
      tabBilling.classList.add('active'); tabRecords.classList.remove('active');
      billingPanel.style.display='block'; recordsPanel.style.display='none';
    }
    function showRecords(){
      tabRecords.classList.add('active'); tabBilling.classList.remove('active');
      recordsPanel.style.display='block'; billingPanel.style.display='none';
      renderRecords();
    }
    tabBilling.onclick=showBilling;
    tabRecords.onclick=showRecords;

    // ------- Billing (minimal, multi-item) -------
    const invNo = document.getElementById('invNo');
    const invDate = document.getElementById('invDate');
    const invPatient = document.getElementById('invPatient');
    const invPhone = document.getElementById('invPhone');
    const discPct = document.getElementById('discPct');
    const discAmt = document.getElementById('discAmt');
    const paid = document.getElementById('paid');
    const total = document.getElementById('total');
    const invHint = document.getElementById('invHint');
    const linesWrap = document.getElementById('lines');

    function addLine(defaults={item:'Paracetamol 650', qty:1, price:0, batch:'', expiry:''}){
      const row=document.createElement('div');
      row.className='form-grid';
      row.innerHTML=`
        <div class="field"><label>Item</label><input class="l-item" value="${defaults.item}"/></div>
        <div class="field"><label>Batch</label><input class="l-batch" value="${defaults.batch}"/></div>
        <div class="field"><label>Expiry</label><input class="l-expiry" type="month" value="${defaults.expiry}"/></div>
        <div class="field"><label>Qty</label><input class="l-qty" inputmode="decimal" value="${defaults.qty}"/></div>
        <div class="field"><label>Price ‚Çπ</label><input class="l-price" inputmode="decimal" value="${defaults.price}"/></div>
        <div class="field" style="align-items:end"><button class="chip ghost l-del">Remove</button></div>
      `;
      row.querySelector('.l-del').onclick=()=>{ row.remove(); calcTotal(); };
      ['.l-qty','.l-price','.l-item','.l-batch','.l-expiry'].forEach(sel=>{
        row.querySelector(sel).addEventListener('input', calcTotal);
      });
      linesWrap.appendChild(row);
    }

    function calcTotal(){
      let sum=0;
      linesWrap.querySelectorAll('.form-grid').forEach(g=>{
        const qty=+g.querySelector('.l-qty').value||0;
        const price=+g.querySelector('.l-price').value||0;
        sum += qty*price;
      });
      let afterPct = sum * (1 - (+discPct.value||0)/100);
      let final = Math.max(0, afterPct - (+discAmt.value||0));
      total.value = final.toFixed(2);
    }

    document.getElementById('addLine').onclick=()=>{ addLine({}); };
    document.getElementById('calcTotal').onclick=calcTotal;

    document.getElementById('newInvoice').onclick=()=>{
      invNo.value=''; invDate.value=new Date().toISOString().slice(0,10);
      invPatient.value=''; invPhone.value='';
      discPct.value='0'; discAmt.value='0'; paid.value='0'; total.value='';
      linesWrap.innerHTML=''; addLine({});
      const all=S.listInvoices(); const last=all[0]?.number ?? '‚Äî';
      invHint.textContent = `Last invoice: ${last}`;
    };

    document.getElementById('saveInvoice').onclick=()=>{
      // build invoice record
      const items=[]; 
      linesWrap.querySelectorAll('.form-grid').forEach(g=>{
        items.push({
          item: g.querySelector('.l-item').value.trim(),
          batch: g.querySelector('.l-batch').value.trim(),
          expiry: g.querySelector('.l-expiry').value.trim(),
          qty: +g.querySelector('.l-qty').value||0,
          price: +g.querySelector('.l-price').value||0,
        });
      });
      const rec=S.saveInvoice({
        number: invNo.value? +invNo.value : undefined,
        date: invDate.value || new Date().toISOString().slice(0,10),
        patient: invPatient.value,
        phone: invPhone.value,
        doctor: '', // optional
        items,
        discountPct: +discPct.value||0,
        discountAmt: +discAmt.value||0,
        paid: +paid.value||0
      });
      invNo.value = rec.number;
      calcTotal();
      alert('Invoice saved: #' + rec.number);
    };

    // start with a fresh invoice on load
    document.getElementById('newInvoice').click();

    // ------- Records -------
    function renderRecords(){
      const from = document.getElementById('recFrom').value || '0000-00-00';
      const to = document.getElementById('recTo').value || '9999-12-31';
      const rows = S.listInvoices({from,to});
      const tb = document.querySelector('#recTable tbody');
      tb.innerHTML='';
      let sum=0;
      rows.forEach(i=>{
        sum += +i.total||0;
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${i.number}</td>
          <td>${i.date||''}</td>
          <td>${i.patient||''}</td>
          <td>${(i.items||[]).length}</td>
          <td>‚Çπ${(+i.total||0).toFixed(2)}</td>
        `;
        tb.appendChild(tr);
      });
      const today=new Date().toISOString().slice(0,10);
      const month=today.slice(0,7);
      const countMonth = rows.filter(r=> (r.date||'').startsWith(month)).length;
      document.getElementById('recSummary').textContent =
        `${rows.length} invoices ‚Ä¢ Total ‚Çπ${sum.toFixed(2)} ‚Ä¢ MTD ${countMonth} inv`;
    }
    document.getElementById('recFilter').onclick=renderRecords;

    // SW (optional)
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }
  </script>
</body>
</html>
