<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Patient Portal â€“ Dr. Charan Hospital</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=26"/>
</head>
<body>
  <!-- Banner -->
  <header class="banner">
    <button id="themeToggle" class="chip floating-toggle" aria-label="Theme">ğŸŒ™</button>
  </header>

  <!-- Fixed actions -->
  <div class="fixed-actions">
    <a class="chip" href="login.html">â† Login</a>
    <button id="logoutBtn" class="chip">Logout</button>
    <button id="clearCacheBtn" class="chip">Clear Cache</button>
  </div>

  <main class="section" style="max-width:1100px">
    <!-- Lookup -->
    <section class="card">
      <h2 style="font-size:18px;margin-bottom:8px">Find My Appointments</h2>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;align-items:end">
        <div>
          <label class="muted">Phone (10-digit)</label>
          <input id="pPhone" class="input" inputmode="numeric" maxlength="10" placeholder="e.g., 9876543210"/>
        </div>
        <div>
          <button id="pFind" class="btn">Find</button>
        </div>
      </div>
      <p class="help" style="margin-top:6px">
        Your bookings are created by the hospital. Use the same phone number given during booking.
      </p>
    </section>

    <!-- Next visit / Reminder -->
    <section class="card">
      <h2 style="font-size:18px;margin-bottom:8px">Next Visit & Reminder</h2>
      <div class="card-grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;">
        <div class="card card--blue">
          <h2 id="nextVisit">â€”</h2><p>Next Visit</p>
        </div>
        <div class="card card--mint">
          <h2 id="reminderOn">â€”</h2><p>Reminder On</p>
        </div>
        <div class="card card--peach">
          <h2 id="reminderSent">â€”</h2><p>Reminder Status</p>
        </div>
      </div>
    </section>

    <!-- Today token (if any) -->
    <section class="card" id="todayCard" style="display:none">
      <h2 style="font-size:18px;margin-bottom:8px">Todayâ€™s Token</h2>
      <div class="card-grid" style="grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;">
        <div class="card"><h2 id="todayToken">â€”</h2><p>Token #</p></div>
        <div class="card"><h2 id="todayTime">â€”</h2><p>Time</p></div>
        <div class="card"><h2 id="todayStatus">â€”</h2><p>Status</p></div>
      </div>
    </section>

    <!-- History -->
    <section class="card">
      <h2 style="font-size:18px;margin-bottom:8px">My Visits (Recent)</h2>
      <table class="table" id="histTable">
        <thead><tr><th>Date</th><th>Token</th><th>Time</th><th>Status</th><th>Notes</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script type="module">
    /* ---------- Role guard: patient only ---------- */
    const sess = JSON.parse(localStorage.getItem('session')||'null');
    if(!sess || sess.role!=='patient') location.replace('login.html');

    /* ---------- Theme ---------- */
    const t = document.getElementById('themeToggle');
    const setTheme = (m)=>{ document.documentElement.dataset.theme=m; localStorage.theme=m; t.textContent=m==='light'?'ğŸŒ':'ğŸŒ™'; };
    setTheme(localStorage.theme || 'light');
    t.onclick = ()=> setTheme((document.documentElement.dataset.theme||'light')==='light'?'dark':'light');

    /* ---------- Logout / Clear ---------- */
    document.getElementById('logoutBtn').onclick = () => { localStorage.removeItem('session'); location.replace('login.html'); };
    document.getElementById('clearCacheBtn').onclick = async () => {
      try{ const s=localStorage.getItem('session'); localStorage.clear(); if(s) localStorage.setItem('session', s);
        if('caches' in window){ const ks=await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k))); }
        alert('Cache cleared. Reloadingâ€¦'); location.reload(true);
      }catch{}
    };

    /* ---------- Data helpers ---------- */
    const lsGet = (k,f)=>{ try{ return JSON.parse(localStorage.getItem(k)||JSON.stringify(f)); }catch{ return f; } };
    const bookings = ()=> lsGet('bookings', []); // {id,date,time,token,name,phone,reason,status}
    const patients = ()=> lsGet('patients', []); // {name,phone,notes,nextVisit,reminderOn,reminderSent}

    const bySel = (sel)=> document.querySelector(sel);
    const histTbody = bySel('#histTable tbody');

    function todayStr(d=new Date()){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10); }

    function renderForPhone(phone){
      // Pull patient master record (optional)
      const pat = patients().find(p=> (p.phone||'') === phone);

      // Next visit + reminders
      bySel('#nextVisit').textContent   = pat?.nextVisit   || 'â€”';
      bySel('#reminderOn').textContent  = pat?.reminderOn  || 'â€”';
      bySel('#reminderSent').textContent= pat?.reminderSent==='yes' ? 'Sent' : (pat?.reminderOn ? 'Pending' : 'â€”');

      // Bookings history
      const list = bookings()
        .filter(b => (b.phone||'') === phone)
        .sort((a,b)=> (a.date<b.date?1:-1) || ((a.token||0)-(b.token||0)));
      histTbody.innerHTML = '';
      list.slice(0,25).forEach(b=>{
        const tr=document.createElement('tr');
        // link doctor notes from patient master for display (if same day)
        const note = (pat && pat.notes && pat.nextVisit && pat.nextVisit === b.date) ? pat.notes : (pat?.notes||'');
        tr.innerHTML = `<td>${b.date||''}</td><td>${b.token||''}</td><td>${b.time||''}</td><td>${b.status||''}</td><td>${note||''}</td>`;
        histTbody.appendChild(tr);
      });

      // Today token card
      const today = todayStr();
      const todayRec = list.find(b => b.date === today);
      const hasToday = !!todayRec;
      bySel('#todayCard').style.display = hasToday ? 'block' : 'none';
      if(hasToday){
        bySel('#todayToken').textContent = todayRec.token ?? 'â€”';
        bySel('#todayTime').textContent = todayRec.time || 'â€”';
        bySel('#todayStatus').textContent = todayRec.status || 'â€”';
      }
    }

    // Find action
    const pPhone = document.getElementById('pPhone');
    document.getElementById('pFind').onclick = ()=>{
      const ph = (pPhone.value||'').trim();
      if(!/^\d{10}$/.test(ph)){ alert('Enter a valid 10-digit phone.'); return; }
      renderForPhone(ph);
    };

    // If we stored a last used phone for this session, auto-fill
    const lastPhone = localStorage.getItem('portal_last_phone');
    if(lastPhone){ pPhone.value = lastPhone; renderForPhone(lastPhone); }
    pPhone.addEventListener('input', ()=> localStorage.setItem('portal_last_phone', (pPhone.value||'').trim()));

    // SW register
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }
  </script>
</body>
</html>
