<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Settings ‚Ä¢ Dr. Charan Hospital</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=18"/>
</head>
<body>
  <!-- Consistent banner -->
  <header class="banner">
    <button id="themeToggle" class="chip floating-toggle" aria-label="Theme">üåô</button>
  </header>

  <!-- Fixed actions row -->
  <nav class="fixed-actions">
    <a class="chip" href="dashboard.html">‚Üê Dashboard</a>
    <button id="logoutBtn" class="chip">Logout</button>
    <button id="clearCacheBtn" class="chip">Clear Cache</button>
  </nav>

  <section class="section">
    <h1>Settings</h1>

    <!-- Tabs as chips -->
    <div class="range" id="tabs" style="margin:10px 0 14px">
      <button class="chip active" data-tab="pins">PINs</button>
      <button class="chip" data-tab="staff">Staff</button>
      <button class="chip" data-tab="patients">Patients</button>
    </div>

    <!-- PINs -->
    <div class="section" data-panel="pins">
      <h2>Login PINs</h2>
      <div class="card-grid" style="margin-top:8px">
        <div class="card"><h2>Doctor PIN</h2><p><input id="pinDoctor" class="input" placeholder="e.g. 4321" style="width:160px"/></p></div>
        <div class="card"><h2>Supervisor PIN</h2><p><input id="pinSupervisor" class="input" placeholder="e.g. 1111" style="width:160px"/></p></div>
        <div class="card"><h2>Patient PIN</h2><p><input id="pinPatient" class="input" placeholder="e.g. 2222" style="width:160px"/></p></div>
      </div>
      <div style="margin-top:12px"><button id="savePins" class="btn">Save PINs</button></div>
      <p class="help">Only the doctor (owner) can change these.</p>
    </div>

    <!-- Staff -->
    <div class="section" data-panel="staff" style="display:none">
      <h2>Staff Directory</h2>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <input id="sName" class="input" placeholder="Full name" style="width:220px"/>
        <input id="sRole" class="input" placeholder="Role" style="width:180px"/>
        <button id="addStaff" class="chip">Add</button>
      </div>
      <table class="table" id="tblStaff">
        <thead><tr><th>Name</th><th>Role</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Patients -->
    <div class="section" data-panel="patients" style="display:none">
      <h2>Patients</h2>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <input id="pName" class="input" placeholder="Patient name" style="width:220px"/>
        <input id="pPhone" class="input" placeholder="Phone" style="width:160px"/>
        <button id="addPatient" class="chip">Add</button>
      </div>
      <table class="table" id="tblPatients">
        <thead><tr><th>Name</th><th>Phone</th><th>Notes</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <script type="module">
    // Theme
    const t=document.getElementById('themeToggle');
    if(localStorage.theme){ document.documentElement.dataset.theme=localStorage.theme; t.textContent=localStorage.theme==='light'?'üåû':'üåô'; }
    t.onclick=()=>{ const cur=document.documentElement.dataset.theme||'light'; const next=cur==='light'?'dark':'light'; document.documentElement.dataset.theme=next; localStorage.theme=next; t.textContent=next==='light'?'üåû':'üåô'; };

    // Guard: doctor only (owner)
    const ses=JSON.parse(localStorage.getItem('session')||'{}');
    if(ses.role!=='doctor'){ location.href='login.html'; }

    // Actions
    document.getElementById('logoutBtn').onclick=()=>{ localStorage.removeItem('session'); location.href='login.html'; };
    document.getElementById('clearCacheBtn').onclick=async()=>{
      try{
        localStorage.clear();
        if('caches' in window){ const ks=await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k))); }
        if('serviceWorker' in navigator){ const regs=await navigator.serviceWorker.getRegistrations(); for(const r of regs) await r.unregister(); }
        alert('Cache cleared. Reloading‚Ä¶'); location.reload();
      }catch(e){ alert('Could not fully clear cache.'); }
    };

    /* ---------- Tabs (chips with active state) ---------- */
    const tabs=[...document.querySelectorAll('#tabs .chip')];
    const panels=[...document.querySelectorAll('[data-panel]')];
    tabs.forEach(tab=>{
      tab.addEventListener('click',()=>{
        tabs.forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        const id=tab.dataset.tab;
        panels.forEach(p=>p.style.display = (p.dataset.panel===id)?'block':'none');
      });
    });

    /* ---------- PINs ---------- */
    const PIN_KEY='appPins';
    const defaults={doctor:'4321', supervisor:'1111', patient:'2222'};
    const pins=Object.assign({},defaults, JSON.parse(localStorage.getItem(PIN_KEY)||'{}'));
    pinDoctor.value=pins.doctor; pinSupervisor.value=pins.supervisor; pinPatient.value=pins.patient;
    savePins.onclick=()=>{
      const newPins={doctor:pinDoctor.value.trim(), supervisor:pinSupervisor.value.trim(), patient:pinPatient.value.trim()};
      if(!/^\d{4,6}$/.test(newPins.doctor) || !/^\d{4,6}$/.test(newPins.supervisor) || !/^\d{4,6}$/.test(newPins.patient)){
        return alert('PINs must be 4‚Äì6 digits.');
      }
      localStorage.setItem(PIN_KEY, JSON.stringify(newPins));
      alert('Saved!');
    };

    /* ---------- Staff directory (local first; ready for Supabase) ---------- */
    const STAFF_KEY='staffDirectory';
    const staff=JSON.parse(localStorage.getItem(STAFF_KEY)||'[]');
    const staffTbody=document.querySelector('#tblStaff tbody');
    function renderStaff(){
      staffTbody.innerHTML=staff.map((s,i)=>`
        <tr>
          <td contenteditable onblur="this.dispatchEvent(new CustomEvent('cell', {bubbles:true, detail:{i,field:'name',val:this.textContent.trim()}}))">${s.name}</td>
          <td contenteditable onblur="this.dispatchEvent(new CustomEvent('cell', {bubbles:true, detail:{i,field:'role',val:this.textContent.trim()}}))">${s.role}</td>
          <td><button class="chip" data-del="${i}">Remove</button></td>
        </tr>`).join('');
    }
    renderStaff();
    document.getElementById('addStaff').onclick=()=>{
      const name=sName.value.trim(), role=sRole.value.trim();
      if(!name) return alert('Name required');
      staff.push({name,role}); localStorage.setItem(STAFF_KEY, JSON.stringify(staff));
      sName.value=''; sRole.value=''; renderStaff();
    };
    staffTbody.addEventListener('click',e=>{
      const i=e.target.dataset.del; if(i==null) return;
      staff.splice(+i,1); localStorage.setItem(STAFF_KEY, JSON.stringify(staff)); renderStaff();
    });
    staffTbody.addEventListener('cell', e=>{
      const {i,field,val}=e.detail; staff[i][field]=val; localStorage.setItem(STAFF_KEY, JSON.stringify(staff));
    });

    /* ---------- Patients directory (local; ready for Supabase) ---------- */
    const PAT_KEY='patientsDirectory';
    const patients=JSON.parse(localStorage.getItem(PAT_KEY)||'[]');
    const patTbody=document.querySelector('#tblPatients tbody');
    function renderPatients(){
      patTbody.innerHTML=patients.map((p,i)=>`
        <tr>
          <td contenteditable onblur="this.dispatchEvent(new CustomEvent('pCell', {bubbles:true, detail:{i,field:'name',val:this.textContent.trim()}}))">${p.name}</td>
          <td contenteditable onblur="this.dispatchEvent(new CustomEvent('pCell', {bubbles:true, detail:{i,field:'phone',val:this.textContent.trim()}}))">${p.phone||''}</td>
          <td contenteditable onblur="this.dispatchEvent(new CustomEvent('pCell', {bubbles:true, detail:{i,field:'notes',val:this.textContent.trim()}}))">${p.notes||''}</td>
          <td><button class="chip" data-delp="${i}">Remove</button></td>
        </tr>`).join('');
    }
    renderPatients();
    document.getElementById('addPatient').onclick=()=>{
      const name=pName.value.trim(), phone=pPhone.value.trim();
      if(!name) return alert('Name required');
      patients.push({name, phone}); localStorage.setItem(PAT_KEY, JSON.stringify(patients));
      pName.value=''; pPhone.value=''; renderPatients();
    };
    patTbody.addEventListener('click',e=>{
      const i=e.target.dataset.delp; if(i==null) return;
      patients.splice(+i,1); localStorage.setItem(PAT_KEY, JSON.stringify(patients)); renderPatients();
    });
    patTbody.addEventListener('pCell', e=>{
      const {i,field,val}=e.detail; patients[i][field]=val; localStorage.setItem(PAT_KEY, JSON.stringify(patients));
    });
  </script>
</body>
</html>
